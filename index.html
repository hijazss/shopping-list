<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);

      --dem:#4aa3ff;
      --rep:#ff5a5a;
      --both:#b38bff;

      --ok:#7cffc0;
      --err:#ff8a8a;

      --pos:#7cffc0;
      --neg:#ff8a8a;

      --sec:#ffd27d;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:12px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      padding:12px 14px 8px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    .h1{font-size:16px;font-weight:900;letter-spacing:.01em}
    .subtle{font-size:12px;color:var(--muted);margin-top:2px}
    .pillBtn{
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:8px 14px 110px;
    }

    .status{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px 10px;
      margin:6px 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .status strong{color:#fff}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .tabRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 8px;
      align-items:center;
    }
    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:7px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
    }
    .tabBtnActive{
      color:#fff;
      background:rgba(255,255,255,.10);
    }

    .rightTools{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      padding:7px 10px;
      cursor:pointer;
    }
    .seg .on{
      background:rgba(255,255,255,.10);
      color:#fff;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 820px){
      .grid2{grid-template-columns:1fr 1fr;}
    }

    .grid3{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .grid3{grid-template-columns:repeat(3,1fr);}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .grid3{grid-template-columns:repeat(2,1fr);}
    }

    .grid4{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .grid4{grid-template-columns:repeat(4,1fr);}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .grid4{grid-template-columns:repeat(2,1fr);}
    }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .kpiTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .kpiTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .kpiIcon{
      width:18px;
      height:18px;
      border-radius:8px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-size:12px;
      line-height:1;
    }
    .kpiValue{
      font-size:16px;
      font-weight:900;
      letter-spacing:.02em;
      margin-top:4px;
    }
    .kpiSub{
      font-size:12px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
    }
    .kpiList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:rgba(255,255,255,.90);
      align-items:center;
      flex-wrap:wrap;
    }
    .kpiRow .muted{color:var(--muted)}
    .kpiBadge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      color:rgba(255,255,255,.90);
    }
    .badgePos{border-color:rgba(124,255,192,.45); color:var(--pos)}
    .badgeNeg{border-color:rgba(255,138,138,.45); color:var(--neg)}
    .badgeNeu{border-color:rgba(255,255,255,.18); color:rgba(255,255,255,.85)}
    .badgeDem{border-color:rgba(74,163,255,.5); color:var(--dem)}
    .badgeRep{border-color:rgba(255,90,90,.5); color:var(--rep)}
    .badgeBoth{border-color:rgba(179,139,255,.55); color:var(--both)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px 9px;
      margin-bottom:8px;
    }

    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-size:13px;
      font-weight:900;
      letter-spacing:.03em;
    }
    .who{
      font-size:12px;
      color:var(--muted);
      max-width:720px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }
    .tag{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tagDem{border-color:rgba(74,163,255,.5); color:var(--dem)}
    .tagRep{border-color:rgba(255,90,90,.5); color:var(--rep)}
    .tagBoth{border-color:rgba(179,139,255,.55); color:var(--both)}
    .tagBuy{border-color:rgba(124,255,192,.45); color:var(--ok)}
    .tagSell{border-color:rgba(255,138,138,.45); color:var(--err)}

    .metaRow{
      margin-top:7px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      line-height:1.25;
    }

    .counts{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .countItem{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }

    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dotDem{background:var(--dem)}
    .dotRep{background:var(--rep)}

    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0 7px}

    .miniLinks{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .miniLink{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      margin:10px 0 10px;
    }
    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .panelTitle h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.9);
      cursor:pointer;
    }
    iframe{
      width:100%;
      height:360px;
      border:0;
      border-radius:12px;
      background:#000;
      margin-top:8px;
    }

    .colsHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:2px 0 8px;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.05em;
      text-transform:uppercase;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin:6px 0 0;
      line-height:1.25;
    }

    .tabsBottom{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#151522f0;
      border-top:1px solid var(--border);
      backdrop-filter:blur(12px);
    }
    .tabBarBottom{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(3,1fr);
    }
    .tabBottom{
      text-align:center;
      padding:11px 10px 16px;
      font-size:11px;
      color:var(--muted);
      user-select:none;
      cursor:pointer;
    }
    .tabBottomActive{color:#fff}

    /* Strategy section */
    .tvTape{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      overflow:hidden;
    }
    .smallCard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .smallTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .smallValue{
      font-size:14px;
      font-weight:900;
      margin-top:6px;
      letter-spacing:.02em;
    }
    .smallSub{
      margin-top:6px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
      font-size:12px;
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="h1" id="pageTitle">Convergence</div>
      <div class="subtle" id="reportDate"></div>
    </div>
    <button class="pillBtn" id="refreshBtn">Refresh</button>
  </header>

  <main class="container">
    <div class="status" id="statusBox">
      <strong>Status:</strong> <span id="statusText">Loading‚Ä¶</span><br/>
      <span class="mono" id="statusDetail"></span>
    </div>

    <div class="tabRow">
      <button class="tabBtn tabBtnActive" id="tabMainBtn">Main</button>
      <button class="tabBtn" id="tabCryptoBtn">Crypto</button>
      <button class="tabBtn" id="tabSearchBtn">Search</button>

      <div class="rightTools" id="mainWindowTools">
        <div class="seg" aria-label="window toggle">
          <button id="btn30" class="on">30D</button>
          <button id="btn180">180D</button>
          <button id="btn365">365D</button>
        </div>
      </div>
    </div>

    <div id="stockPanel" style="display:none;"></div>

    <!-- MARKET SNAPSHOT + VALUE STRATEGY -->
    <section id="strategyStrip">
      <div class="sectionTitle" id="strategyTitle">Market snapshot + value accumulation strategy</div>

      <div class="tvTape" style="margin-bottom:10px;">
        <div class="tradingview-widget-container" style="padding:10px;">
          <div class="tradingview-widget-container__widget"></div>
        </div>
      </div>

      <div class="grid3" style="margin-bottom:10px;">
        <div class="smallCard">
          <div class="smallTitle"><span class="kpiIcon">üß≠</span> Market context</div>
          <div class="smallValue" id="marketCtxValue">Loading‚Ä¶</div>
          <div class="smallSub" id="marketCtxSub">
            Uses SPY trend + VIX level when available. If blocked, it falls back to tape only.
          </div>
        </div>

        <div class="smallCard">
          <div class="smallTitle"><span class="kpiIcon">üß±</span> Value-style plan</div>
          <div class="smallSub" id="valuePlanText">
            Loading‚Ä¶
          </div>
        </div>

        <div class="smallCard">
          <div class="smallTitle"><span class="kpiIcon">üîé</span> 10 stocks to research</div>
          <div class="smallSub" style="margin-top:6px;">
            Ranked by congressional accumulation plus persistence across 30D, 180D, 365D.
          </div>
          <div class="kpiList" id="valueList"></div>
        </div>
      </div>

      <div class="hint" id="strategyHint">
        This is informational and for research only, not financial advice. Use it as a starting point for valuation work (free cash flow, balance sheet strength, margin stability, and price vs intrinsic value).
      </div>
    </section>

    <!-- KPI strip -->
    <section id="kpiStrip">
      <div class="sectionTitle" id="kpiTitle">Signal dashboard (top 4, rolling 30 days)</div>
      <div class="grid4">
        <div class="kpi" id="kpiNet"></div>
        <div class="kpi" id="kpiPart"></div>
        <div class="kpi" id="kpiTop"></div>
        <div class="kpi" id="kpiHighlights"></div>
      </div>
    </section>

    <section id="viewMain">
      <div class="sectionTitle" id="convTitle">Convergence üî• (bipartisan overlap on BUY, rolling 30 days)</div>
      <div id="convergenceList"></div>

      <div class="sectionTitle" id="partTitle">Congress trades by participation (rolling 30 days)</div>
      <div class="colsHeader">
        <div>Buys (left)</div>
        <div>Sells (right)</div>
      </div>

      <div class="grid2">
        <div><div id="buyList"></div></div>
        <div><div id="sellList"></div></div>
      </div>

      <div class="hint" id="mainHint">
        Sort is by total participation (both parties) within the rolling window. Tap ticker for chart.
      </div>
    </section>

    <section id="viewCrypto" style="display:none;">
      <div class="sectionTitle" id="cryptoTitle">Crypto congress disclosures (rolling 30 days)</div>

      <div class="grid2">
        <div>
          <div class="sectionTitle">Buys</div>

          <div class="sectionTitle" style="margin-top:8px;">Direct crypto disclosures</div>
          <div id="cryptoDirectBuys"></div>

          <div class="sectionTitle" style="margin-top:14px;">Crypto-linked tickers (ETFs, miners, exchanges)</div>
          <div id="cryptoLinkedBuys"></div>
        </div>

        <div>
          <div class="sectionTitle">Sells</div>

          <div class="sectionTitle" style="margin-top:8px;">Direct crypto disclosures</div>
          <div id="cryptoDirectSells"></div>

          <div class="sectionTitle" style="margin-top:14px;">Crypto-linked tickers (ETFs, miners, exchanges)</div>
          <div id="cryptoLinkedSells"></div>
        </div>
      </div>

      <div class="hint" id="cryptoHint">
        Direct crypto items come from disclosure descriptions (BTC, ETH, SOL, LINK, etc). Crypto-linked tickers are ETFs, miners, and exchanges pulled from the same congress feed.
      </div>
    </section>

    <section id="viewSearch" style="display:none;">
      <div class="sectionTitle">Search ticker</div>
      <div class="panel">
        <div class="metaRow" style="margin-top:0;">
          <div style="color:rgba(255,255,255,.9)">Type a ticker (example: NVDA)</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input id="searchInput" placeholder="Ticker" autocapitalize="characters"
                 style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#fff; font-size:13px;" />
          <button class="pillBtn" id="searchBtn">Go</button>
        </div>
        <div class="hint" style="margin-top:10px;">Opens the chart panel for quick trend context.</div>
      </div>
    </section>
  </main>

  <nav class="tabsBottom">
    <div class="tabBarBottom">
      <div class="tabBottom tabBottomActive" id="navMain">Main</div>
      <div class="tabBottom" id="navCrypto">Crypto</div>
      <div class="tabBottom" id="navSearch">Search</div>
    </div>
  </nav>

  <script>
    const BACKEND_BASE = "https://finance-backend-dzta.onrender.com";
    const el = (id) => document.getElementById(id);

    let ACTIVE_TAB = "Main";
    let WINDOW_DAYS = 30;

    let CACHE_MAIN = new Map();

    // Crypto-linked stock tickers (ETFs, miners, exchanges)
    const CRYPTO_TICKERS = new Set([
      "COIN","MSTR","RIOT","MARA","HUT","CLSK","SQ","PYPL",
      "IBIT","FBTC","GBTC","BITO","ARKB","BTCO","HODL","BITB",
      "ETHE","ETHA","WGMI","BKCH","BLOK","BITQ","DAPP"
    ]);

    // Coin symbols you consider "direct crypto"
    const DIRECT_COIN_SET = new Set([
      "BTC","ETH","SOL","LINK","XRP","ADA","DOGE","AVAX","MATIC","BNB"
    ]);

    function setStatus(kind, text, detail){
      const st = el("statusText");
      const sd = el("statusDetail");
      st.textContent = text || "";
      st.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
      sd.textContent = detail || "";
    }

    function setTitleForTab(tab){
      const map = {
        "Main":"Convergence",
        "Crypto":"Crypto",
        "Search":"Search"
      };
      el("pageTitle").textContent = map[tab] || "Convergence";
    }

    function showTab(tab){
      ACTIVE_TAB = tab;
      setTitleForTab(tab);

      el("viewMain").style.display = tab === "Main" ? "" : "none";
      el("viewCrypto").style.display = tab === "Crypto" ? "" : "none";
      el("viewSearch").style.display = tab === "Search" ? "" : "none";

      el("kpiStrip").style.display = (tab === "Main") ? "" : "none";
      el("strategyStrip").style.display = (tab === "Main") ? "" : "none";
      el("mainWindowTools").style.display = (tab === "Main" || tab === "Crypto") ? "" : "none";

      el("tabMainBtn").classList.toggle("tabBtnActive", tab === "Main");
      el("tabCryptoBtn").classList.toggle("tabBtnActive", tab === "Crypto");
      el("tabSearchBtn").classList.toggle("tabBtnActive", tab === "Search");

      el("navMain").classList.toggle("tabBottomActive", tab === "Main");
      el("navCrypto").classList.toggle("tabBottomActive", tab === "Crypto");
      el("navSearch").classList.toggle("tabBottomActive", tab === "Search");

      if (tab === "Main") {
        loadMain(false);
        refreshStrategy();
      }
      if (tab === "Crypto") loadMain(false);
    }

    function normalizeList(arr){ return Array.isArray(arr) ? arr.slice() : []; }

    function congressScore(x){
      return (
        Number(x.demBuyers || 0) +
        Number(x.repBuyers || 0) +
        Number(x.demSellers || 0) +
        Number(x.repSellers || 0)
      );
    }

    function bipartisanScore(x){
      const dem = Number(x.demBuyers || 0) + Number(x.demSellers || 0);
      const rep = Number(x.repBuyers || 0) + Number(x.repSellers || 0);
      return Math.min(dem, rep);
    }

    function sortByCongressStrength(a, b){
      const totalA = congressScore(a);
      const totalB = congressScore(b);
      if (totalA !== totalB) return totalB - totalA;
      const biA = bipartisanScore(a);
      const biB = bipartisanScore(b);
      if (biA !== biB) return biB - biA;
      return String(a.ticker || "").localeCompare(String(b.ticker || ""), undefined, {sensitivity:"base"});
    }

    function netFlow(x){
      const buys = Number(x.demBuyers || 0) + Number(x.repBuyers || 0);
      const sells = Number(x.demSellers || 0) + Number(x.repSellers || 0);
      return buys - sells;
    }

    function confidenceLabel(x){
      const t = congressScore(x);
      if (t >= 6) return "STRONG";
      if (t >= 3) return "MOD";
      return "WEAK";
    }

    function confidenceBadgeClass(lbl){
      if (lbl === "STRONG") return "badgePos";
      if (lbl === "MOD") return "badgeNeu";
      return "badgeNeu";
    }

    function tickerLinksHTML(ticker){
      const t = String(ticker || "").toUpperCase();
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tvChart = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent("NASDAQ:" + t)}`;
      return `
        <div class="miniLinks">
          <a class="miniLink" href="#stock=${t}">Chart</a>
          <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Yahoo</a>
          <a class="miniLink" href="${tvChart}" target="_blank" rel="noopener">TV</a>
        </div>
      `;
    }

    function demRepTagRow(dem, rep){
      const d = Number(dem||0);
      const r = Number(rep||0);
      const total = d + r;
      if (!total) return "";
      return `
        <span class="kpiBadge badgeDem">DEM ${d}</span>
        <span class="kpiBadge badgeRep">GOP ${r}</span>
      `;
    }

    function iconSpan(txt){ return `<span class="kpiIcon" aria-hidden="true">${txt}</span>`; }

    function cardHTML(x, mode){
      const ticker = String(x.ticker || "").toUpperCase();
      const who = String(x.companyName || "").trim();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";

      const dem = mode === "BUY" ? Number(x.demBuyers || 0) : Number(x.demSellers || 0);
      const rep = mode === "BUY" ? Number(x.repBuyers || 0) : Number(x.repSellers || 0);

      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                ${who ? `<div class="who">${who}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${mode === "BUY" ? `<span class="tag tagBuy">BUY</span>` : `<span class="tag tagSell">SELL</span>`}
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
              ${demRepTagRow(dem, rep)}
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function overlapCardHTML(x){
      const ticker = String(x.ticker || "").toUpperCase();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";
      const dem = Number(x.demBuyers || 0);
      const rep = Number(x.repBuyers || 0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                <div class="who">Bipartisan overlap (BUY)</div>
              </div>
            </div>
            <div class="tags">
              <span class="tag tagBoth">OVERLAP</span>
              <span class="tag tagBuy">BUY</span>
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
              ${demRepTagRow(dem, rep)}
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function setStockPanel(ticker){
      const t = String(ticker || "").toUpperCase();
      if (!t){
        el("stockPanel").style.display = "none";
        el("stockPanel").innerHTML = "";
        return;
      }

      const symbol = "NASDAQ:" + t;
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tv = `https://www.tradingview.com/symbols/${encodeURIComponent(symbol)}/`;

      el("stockPanel").style.display = "";
      el("stockPanel").innerHTML = `
        <div class="panel">
          <div class="panelTitle">
            <h2>${t} chart</h2>
            <button class="closeBtn" id="closeStockBtn">Close</button>
          </div>
          <iframe
            title="TradingView Chart"
            src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=D&hidesidetoolbar=0&symboledit=1&saveimage=1&toolbarbg=%23151522&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1"
            loading="lazy">
          </iframe>
          <div class="miniLinks">
            <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Open Yahoo</a>
            <a class="miniLink" href="${tv}" target="_blank" rel="noopener">Open TradingView</a>
          </div>
        </div>
      `;

      const btn = document.getElementById("closeStockBtn");
      if (btn) btn.addEventListener("click", () => {
        history.pushState("", document.title, window.location.pathname + window.location.search);
        setStockPanel("");
      });
    }

    function handleHash(){
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim();
        setStockPanel(t);
        return;
      }
      setStockPanel("");
    }

    function topBy(arr, scoreFn, n){
      const a = normalizeList(arr).slice();
      a.sort((x,y) => (scoreFn(y) - scoreFn(x)) || String(x.ticker||"").localeCompare(String(y.ticker||""), undefined, {sensitivity:"base"}));
      return a.slice(0, n);
    }

    function renderKpis(convergence, buys, sells, windowDays){
      const merged = new Map();
      function addCard(x){
        const t = String(x.ticker || "").toUpperCase();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0 };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        merged.set(t, cur);
      }
      buys.forEach(addCard);
      sells.forEach(addCard);

      const mergedArr = Array.from(merged.values());
      const win = Number(windowDays || 30);

      el("kpiTitle").textContent = `Signal dashboard (top 4, rolling ${win} days)`;

      const topNet = topBy(mergedArr, x => netFlow(x), 5);
      el("kpiNet").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">${iconSpan("üìà")} Net flow</div>
            <div class="kpiValue">Buys - Sells</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Highest accumulation or distribution in rolling ${win}D.</div>
        <div class="kpiList">
          ${topNet.map(x => {
            const nf = netFlow(x);
            const cls = nf > 0 ? "badgePos" : nf < 0 ? "badgeNeg" : "badgeNeu";
            const sign = nf > 0 ? "+" : "";
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${sign}${nf}</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      const topPart = topBy(mergedArr, x => congressScore(x), 5);
      el("kpiPart").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">${iconSpan("üë•")} Participation</div>
            <div class="kpiValue">Total activity</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Total participation (both parties) in rolling ${win}D.</div>
        <div class="kpiList">
          ${topPart.map(x => {
            const total = congressScore(x);
            const lbl = confidenceLabel(x);
            const cls = confidenceBadgeClass(lbl);
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${lbl} ¬∑ ${total}</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      const topTickers = topBy(mergedArr, x => congressScore(x), 5);
      el("kpiTop").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">${iconSpan("üè∑Ô∏è")} Top tickers</div>
            <div class="kpiValue">Intensity</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Most active tickers in rolling ${win}D.</div>
        <div class="kpiList">
          ${topTickers.map(x => {
            const total = congressScore(x);
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge badgeNeu">${total} items</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      const topAcc = topBy(mergedArr, x => netFlow(x), 1)[0];
      const topDist = topBy(mergedArr, x => -netFlow(x), 1)[0];
      const topConv = (convergence && convergence.length) ? convergence.slice().sort(sortByCongressStrength)[0] : null;

      el("kpiHighlights").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">${iconSpan("‚ú®")} Top signals</div>
            <div class="kpiValue">Fast read</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Best accumulation, selling, and overlap in rolling ${win}D.</div>
        <div class="kpiList">
          <div class="kpiRow"><span class="muted">${iconSpan("üü¢")} Accumulation</span>${topAcc ? `<a href="#stock=${topAcc.ticker}"><strong>${topAcc.ticker}</strong></a>` : `<span class="muted">None</span>`}</div>
          <div class="kpiRow"><span class="muted">${iconSpan("üî¥")} Selling</span>${topDist ? `<a href="#stock=${topDist.ticker}"><strong>${topDist.ticker}</strong></a>` : `<span class="muted">None</span>`}</div>
          <div class="kpiRow"><span class="muted">${iconSpan("üü£")} Overlap</span>${topConv ? `<a href="#stock=${String(topConv.ticker||"").toUpperCase()}"><strong>${String(topConv.ticker||"").toUpperCase()}</strong></a>` : `<span class="muted">None</span>`}</div>
        </div>
      `;
    }

    function renderMain(data){
      const win = Number(data.windowDays || WINDOW_DAYS || 30);

      el("reportDate").textContent = data.date ? `${data.date} ¬∑ window ${win}D` : `window ${win}D`;
      el("convTitle").textContent = `Convergence üî• (bipartisan overlap on BUY, rolling ${win} days)`;
      el("partTitle").textContent = `Congress trades by participation (rolling ${win} days)`;
      el("mainHint").textContent = `Sort is by total participation (both parties) within the rolling ${win}-day window. Tap ticker for chart.`;

      const convergence = normalizeList(data.convergence).sort(sortByCongressStrength);
      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers).sort(sortByCongressStrength);
      const sells = normalizeList(data.politicianSells).sort(sortByCongressStrength);

      renderKpis(convergence, buys, sells, win);

      el("convergenceList").innerHTML =
        convergence.length ? convergence.map(overlapCardHTML).join("") : "<div class='subtle'>No overlap tickers in this window.</div>";

      el("buyList").innerHTML =
        buys.length ? buys.map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No buy trades found.</div>";

      el("sellList").innerHTML =
        sells.length ? sells.map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No sell trades found.</div>";

      renderCryptoFromMain(data);
      handleHash();
    }

    // Crypto helpers
    function partyTag(p){
      const s = String(p||"").toUpperCase();
      if (s === "D") return `<span class="tag tagDem">DEM</span>`;
      if (s === "R") return `<span class="tag tagRep">GOP</span>`;
      return `<span class="tag badgeNeu">?</span>`;
    }

    function coinsToLabel(coins){
      const arr = Array.isArray(coins) ? coins.map(x => String(x||"").toUpperCase()).filter(Boolean) : [];
      const cleaned = arr.filter(c => c !== "CRYPTO-LINKED");
      if (!cleaned.length) return "CRYPTO";
      return cleaned.join(" ¬∑ ");
    }

    function isDirectCryptoRow(r){
      const coins = Array.isArray(r.coins) ? r.coins : [];
      return coins.some(c => DIRECT_COIN_SET.has(String(c||"").toUpperCase()));
    }

    function cryptoDirectCardHTML(r){
      const kind = String(r.kind || "").toUpperCase();
      const who = String(r.politician || "").trim();
      const chamber = String(r.chamber || "").trim();
      const amt = String(r.amountRange || "").trim();
      const traded = String(r.traded || "");
      const filed = String(r.filed || "");
      const desc = String(r.description || "").trim();
      const sym = coinsToLabel(r.coins);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <div class="ticker">${sym}</div>
                ${who ? `<div class="who">${who}${chamber ? " ¬∑ " + chamber : ""}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${kind === "BUY" ? `<span class="tag tagBuy">BUY</span>` : kind === "SELL" ? `<span class="tag tagSell">SELL</span>` : `<span class="tag badgeNeu">${kind || "TX"}</span>`}
              ${partyTag(r.party)}
            </div>
          </div>

          <div class="divider"></div>

          ${desc ? `
            <div class="metaRow">
              <div style="max-width:820px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${desc}
              </div>
            </div>
          ` : ""}

          <div class="metaRow">
            <div class="counts">
              ${amt ? `<div class="countItem">Amount: <strong>${amt}</strong></div>` : ""}
              ${traded ? `<div class="countItem">Traded: <strong>${traded}</strong></div>` : ""}
              ${filed ? `<div class="countItem">Filed: <strong>${filed}</strong></div>` : ""}
            </div>
          </div>
        </div>
      `;
    }

    function renderCryptoFromMain(data){
      const win = Number(data.windowDays || WINDOW_DAYS || 30);
      el("cryptoTitle").textContent = `Crypto congress disclosures (rolling ${win} days)`;

      const crypto = (data && data.crypto && typeof data.crypto === "object") ? data.crypto : {};
      const raw = normalizeList(crypto.raw);

      const direct = raw.filter(isDirectCryptoRow);
      const directBuys = direct.filter(x => String(x.kind||"").toUpperCase() === "BUY");
      const directSells = direct.filter(x => String(x.kind||"").toUpperCase() === "SELL");

      el("cryptoDirectBuys").innerHTML =
        directBuys.length ? directBuys.map(cryptoDirectCardHTML).join("") : "<div class='subtle'>No direct crypto buys in this window.</div>";

      el("cryptoDirectSells").innerHTML =
        directSells.length ? directSells.map(cryptoDirectCardHTML).join("") : "<div class='subtle'>No direct crypto sells in this window.</div>";

      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers)
        .filter(x => CRYPTO_TICKERS.has(String(x.ticker||"").toUpperCase()))
        .sort(sortByCongressStrength);

      const sells = normalizeList(data.politicianSells)
        .filter(x => CRYPTO_TICKERS.has(String(x.ticker||"").toUpperCase()))
        .sort(sortByCongressStrength);

      el("cryptoLinkedBuys").innerHTML =
        buys.length ? buys.map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No crypto-linked buys in this window.</div>";

      el("cryptoLinkedSells").innerHTML =
        sells.length ? sells.map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No crypto-linked sells in this window.</div>";

      const sumBuys = normalizeList(crypto.buys);
      const sumSells = normalizeList(crypto.sells);
      const topBuy = sumBuys.slice(0,5).map(x => `${String(x.symbol||"").toUpperCase()} (${Number(x.count||0)})`).join(", ");
      const topSell = sumSells.slice(0,5).map(x => `${String(x.symbol||"").toUpperCase()} (${Number(x.count||0)})`).join(", ");
      const hintBits = [];
      if (topBuy) hintBits.push(`Top tags BUY: ${topBuy}`);
      if (topSell) hintBits.push(`Top tags SELL: ${topSell}`);
      if (hintBits.length){
        el("cryptoHint").textContent = hintBits.join(" ¬∑ ");
      } else {
        el("cryptoHint").textContent =
          "Direct crypto items come from disclosure descriptions (BTC, ETH, SOL, LINK, etc). Crypto-linked tickers are ETFs, miners, and exchanges pulled from the same congress feed.";
      }
    }

    // Strategy engine
    async function fetchWindow(days){
      const key = String(days);
      const cached = CACHE_MAIN.get(key);
      if (cached) return cached;

      const url = `${BACKEND_BASE}/report/today?window_days=${encodeURIComponent(String(days))}`;
      const res = await fetch(url, { cache: "no-store" });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error("HTTP " + res.status);
      if (data.error) throw new Error(data.error);
      CACHE_MAIN.set(key, data);
      return data;
    }

    function mergeTickerCards(cards){
      const merged = new Map();
      (Array.isArray(cards) ? cards : []).forEach(x => {
        const t = String(x.ticker||"").toUpperCase().trim();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0, lastFiledAt:"" };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        const lf = String(x.lastFiledAt||"");
        if (lf && (!cur.lastFiledAt || lf > cur.lastFiledAt)) cur.lastFiledAt = lf;
        merged.set(t, cur);
      });
      return merged;
    }

    function scoreAccumulation(row){
      const buys = Number(row.demBuyers||0) + Number(row.repBuyers||0);
      const sells = Number(row.demSellers||0) + Number(row.repSellers||0);
      const nf = buys - sells;
      const overlap = Math.min(Number(row.demBuyers||0), Number(row.repBuyers||0));
      const intensity = buys + sells;

      let score = 0;
      if (nf > 0) score += Math.min(8, nf) * 1.6;
      if (overlap > 0) score += Math.min(6, overlap) * 2.0;
      score += Math.min(10, intensity) * 0.8;
      if (sells > 0) score -= Math.min(8, sells) * 0.9;

      return { score, nf, overlap, buys, sells, intensity };
    }

    function valueRowHTML(r){
      const t = r.ticker;
      const persistBadge = r.persist === 3 ? "badgeBoth" : r.persist === 2 ? "badgeNeu" : "badgeNeu";
      const persistLabel = r.persist === 3 ? "PERSIST 30/180/365" : r.persist === 2 ? "PERSIST 2 WINDOWS" : "PERSIST 1 WINDOW";
      const nfCls = r.nf > 0 ? "badgePos" : r.nf < 0 ? "badgeNeg" : "badgeNeu";
      const sign = r.nf > 0 ? "+" : "";
      const last = r.lastFiledAt ? ` ¬∑ ${r.lastFiledAt}` : "";
      return `
        <div class="kpiRow">
          <a href="#stock=${encodeURIComponent(t)}"><strong>${t}</strong></a>
          <span class="kpiBadge ${persistBadge}">${persistLabel}</span>
          <span class="kpiBadge ${nfCls}">${sign}${r.nf} net</span>
          <span class="kpiBadge badgeNeu">overlap ${r.overlap}</span>
          <span class="kpiBadge badgeNeu">score ${r.score.toFixed(1)}${last}</span>
        </div>
      `;
    }

    async function fetchWithTimeout(url, ms){
      const ctrl = new AbortController();
      const to = setTimeout(() => ctrl.abort(), ms);
      try{
        const res = await fetch(url, { cache:"no-store", signal: ctrl.signal });
        return res;
      } finally {
        clearTimeout(to);
      }
    }

    async function fetchStooqDaily(sym){
      // daily history csv
      const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(sym)}&i=d`;
      const res = await fetchWithTimeout(url, 3500);
      if (!res || !res.ok) return null;
      const text = await res.text();
      const lines = (text || "").trim().split("\n");
      if (lines.length < 3) return null;

      // columns: Date,Open,High,Low,Close,Volume
      const closes = [];
      for (let i = 1; i < lines.length; i++){
        const parts = lines[i].split(",");
        if (parts.length < 5) continue;
        const c = Number(parts[4]);
        if (isFinite(c)) closes.push(c);
      }
      return closes;
    }

    function sma(arr, n){
      if (!arr || arr.length < n) return null;
      let sum = 0;
      for (let i = arr.length - n; i < arr.length; i++) sum += arr[i];
      return sum / n;
    }

    function pct(a, b){
      if (!isFinite(a) || !isFinite(b) || b === 0) return null;
      return (a - b) / b;
    }

    async function updateMarketContext(){
      el("marketCtxValue").textContent = "Reading SPY trend‚Ä¶";

      try{
        const spy = await fetchStooqDaily("spy.us");
        const vix = await fetchStooqDaily("vix");

        if (!spy || spy.length < 220){
          el("marketCtxValue").textContent = "Tape only";
          el("marketCtxSub").textContent = "SPY trend fetch blocked or insufficient. Use the tape as context.";
          return;
        }

        const last = spy[spy.length - 1];
        const ma50 = sma(spy, 50);
        const ma200 = sma(spy, 200);
        const rel50 = ma50 ? pct(last, ma50) : null;
        const rel200 = ma200 ? pct(last, ma200) : null;

        let volTxt = "VIX unavailable";
        let volLvl = null;
        if (vix && vix.length > 20){
          volLvl = vix[vix.length - 1];
          volTxt = `VIX ${volLvl.toFixed(1)}`;
        }

        const trend = (rel200 != null && rel200 >= 0) ? "Uptrend" : "Below 200D";
        const risk =
          volLvl == null ? "Neutral"
          : volLvl < 18 ? "Lower vol"
          : volLvl <= 25 ? "Medium vol"
          : "High vol";

        el("marketCtxValue").textContent = `${trend} ¬∑ ${risk}`;
        el("marketCtxSub").textContent =
          `SPY ${last.toFixed(2)} ¬∑ 50D ${ma50 ? ma50.toFixed(2) : "‚Äî"} ¬∑ 200D ${ma200 ? ma200.toFixed(2) : "‚Äî"} ¬∑ ${volTxt}.`;

      }catch(e){
        el("marketCtxValue").textContent = "Tape only";
        el("marketCtxSub").textContent = "Market context fetch failed. Use the tape as context.";
      }
    }

    function setValuePlanText(){
      // generic, value-style, accumulation. Not dependent on market data so it always shows.
      const win = Number(WINDOW_DAYS || 30);
      const text = `
        <div>
          <div><strong>Core rule:</strong> accumulate gradually, never chase, size buys based on volatility.</div>
          <div style="margin-top:6px;"><strong>Signals used:</strong> positive net buying, bipartisan overlap, and persistence across 30D/180D/365D.</div>
          <div style="margin-top:6px;"><strong>Execution idea:</strong> build a watchlist, pick 3 to 5 names that pass valuation checks, and add in 3 to 6 tranches over time.</div>
          <div style="margin-top:6px;"><strong>Window:</strong> your dashboard is currently ${win}D for the live signal view.</div>
        </div>
      `;
      el("valuePlanText").innerHTML = text;
    }

    async function updateValueList(){
      el("valueList").innerHTML = `<div class="subtle">Loading‚Ä¶</div>`;

      try{
        const [d30, d180, d365] = await Promise.all([
          fetchWindow(30),
          fetchWindow(180),
          fetchWindow(365)
        ]);

        const m30 = mergeTickerCards([...(normalizeList(d30.politicianBuys)), ...(normalizeList(d30.politicianSells))]);
        const m180 = mergeTickerCards([...(normalizeList(d180.politicianBuys)), ...(normalizeList(d180.politicianSells))]);
        const m365 = mergeTickerCards([...(normalizeList(d365.politicianBuys)), ...(normalizeList(d365.politicianSells))]);

        const all = new Set([...m30.keys(), ...m180.keys(), ...m365.keys()]);
        const scored = [];

        for (const t of all){
          const active = (WINDOW_DAYS === 365 ? m365.get(t) : WINDOW_DAYS === 180 ? m180.get(t) : m30.get(t)) || m30.get(t) || m180.get(t) || m365.get(t);
          if (!active) continue;

          const s = scoreAccumulation(active);
          const persist = (m30.has(t) ? 1 : 0) + (m180.has(t) ? 1 : 0) + (m365.has(t) ? 1 : 0);

          // value-leaning heuristics from this dataset only:
          // - prefer net buyers
          // - prefer persistence
          // - do not hard exclude anything else (valuation is done by user later)
          const totalScore = s.score + (persist * 2.2);

          scored.push({
            ticker: t,
            score: totalScore,
            nf: s.nf,
            overlap: s.overlap,
            persist,
            lastFiledAt: active.lastFiledAt || ""
          });
        }

        const top10 = scored
          .filter(x => x.nf > 0)
          .sort((a,b) => (b.persist - a.persist) || (b.score - a.score) || a.ticker.localeCompare(b.ticker))
          .slice(0, 10);

        el("valueList").innerHTML =
          top10.length ? top10.map(valueRowHTML).join("") : `<div class="subtle">No clear accumulation candidates in this data.</div>`;

      }catch(err){
        el("valueList").innerHTML = `<div class="subtle">Could not load the value list.</div>`;
      }
    }

    function refreshStrategy(){
      el("strategyTitle").textContent = `Market snapshot + value accumulation strategy (window ${WINDOW_DAYS}D)`;
      setValuePlanText();
      updateMarketContext();
      updateValueList();
    }

    async function loadMain(force){
      const key = String(WINDOW_DAYS);
      const cached = CACHE_MAIN.get(key);

      if (cached && !force){
        if (ACTIVE_TAB === "Main" || ACTIVE_TAB === "Crypto"){
          setStatus("ok", "Using cached congress data ‚úÖ", "");
          renderMain(cached);
        }
        return;
      }

      const url = `${BACKEND_BASE}/report/today?window_days=${encodeURIComponent(String(WINDOW_DAYS))}`;
      setStatus("", `Loading congress (rolling ${WINDOW_DAYS}D)‚Ä¶`, url);

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        CACHE_MAIN.set(key, data);
        setStatus("ok", "Live congress data loaded ‚úÖ", "");

        if (ACTIVE_TAB === "Main" || ACTIVE_TAB === "Crypto"){
          renderMain(data);
        }
      }catch(err){
        setStatus("err", "Could not load congress data", String(err));
        if (ACTIVE_TAB === "Main"){
          el("convergenceList").innerHTML = "<div class='subtle'>No data displayed.</div>";
          el("buyList").innerHTML = "<div class='subtle'>No data displayed.</div>";
          el("sellList").innerHTML = "<div class='subtle'>No data displayed.</div>";
        }
        if (ACTIVE_TAB === "Crypto"){
          el("cryptoDirectBuys").innerHTML = "<div class='subtle'>No data displayed.</div>";
          el("cryptoDirectSells").innerHTML = "<div class='subtle'>No data displayed.</div>";
          el("cryptoLinkedBuys").innerHTML = "<div class='subtle'>No data displayed.</div>";
          el("cryptoLinkedSells").innerHTML = "<div class='subtle'>No data displayed.</div>";
        }
      }
    }

    function setWindow(days){
      WINDOW_DAYS = days;
      el("btn30").classList.toggle("on", WINDOW_DAYS === 30);
      el("btn180").classList.toggle("on", WINDOW_DAYS === 180);
      el("btn365").classList.toggle("on", WINDOW_DAYS === 365);

      if (ACTIVE_TAB === "Main" || ACTIVE_TAB === "Crypto"){
        loadMain(false);
      }
      if (ACTIVE_TAB === "Main"){
        refreshStrategy();
      }
    }

    function handleRefresh(){
      CACHE_MAIN.delete(String(WINDOW_DAYS));
      loadMain(true);
      if (ACTIVE_TAB === "Main"){
        refreshStrategy();
      }
    }

    el("searchBtn").addEventListener("click", () => {
      const t = String(el("searchInput").value || "").trim().toUpperCase();
      if (!t) return;
      window.location.hash = "#stock=" + encodeURIComponent(t);
      showTab("Search");
      handleHash();
    });

    el("btn30").addEventListener("click", () => setWindow(30));
    el("btn180").addEventListener("click", () => setWindow(180));
    el("btn365").addEventListener("click", () => setWindow(365));

    el("tabMainBtn").addEventListener("click", () => showTab("Main"));
    el("tabCryptoBtn").addEventListener("click", () => showTab("Crypto"));
    el("tabSearchBtn").addEventListener("click", () => showTab("Search"));

    el("navMain").addEventListener("click", () => showTab("Main"));
    el("navCrypto").addEventListener("click", () => showTab("Crypto"));
    el("navSearch").addEventListener("click", () => showTab("Search"));

    el("refreshBtn").addEventListener("click", handleRefresh);
    window.addEventListener("hashchange", handleHash);

    // TradingView tape injection (clean, minimal)
    function initTradingViewTape(){
      const container = document.querySelector(".tradingview-widget-container__widget");
      if (!container) return;
      container.innerHTML = "";

      const script = document.createElement("script");
      script.type = "text/javascript";
      script.async = true;
      script.src = "https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js";
      script.innerHTML = JSON.stringify({
        symbols: [
          { proName: "AMEX:SPY", title: "S&P 500" },
          { proName: "NASDAQ:QQQ", title: "Nasdaq 100" },
          { proName: "DJ:DJI", title: "Dow" },
          { proName: "CBOE:VIX", title: "VIX" },
          { proName: "TVC:US10Y", title: "US 10Y" }
        ],
        showSymbolLogo: true,
        isTransparent: true,
        displayMode: "adaptive",
        colorTheme: "dark",
        locale: "en"
      });
      container.appendChild(script);
    }

    // boot
    initTradingViewTape();
    showTab("Main");
    loadMain(false);
    refreshStrategy();
  </script>
</body>
</html>

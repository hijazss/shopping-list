<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);

      --dem:#4aa3ff;
      --rep:#ff5a5a;
      --both:#b38bff;

      --ok:#7cffc0;
      --err:#ff8a8a;

      --pos:#7cffc0;
      --neg:#ff8a8a;

      --sec:#ffd27d;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:12px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      padding:12px 14px 8px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    .h1{font-size:16px;font-weight:900;letter-spacing:.01em}
    .subtle{font-size:12px;color:var(--muted);margin-top:2px}
    .pillBtn{
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:8px 14px 110px;
    }

    .status{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px 10px;
      margin:6px 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .status strong{color:#fff}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .tabRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 8px;
      align-items:center;
    }
    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:7px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
    }
    .tabBtnActive{
      color:#fff;
      background:rgba(255,255,255,.10);
    }

    .rightTools{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      padding:7px 10px;
      cursor:pointer;
    }
    .seg .on{
      background:rgba(255,255,255,.10);
      color:#fff;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 820px){
      .grid2{grid-template-columns:1fr 1fr;}
    }

    .grid3{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .grid3{grid-template-columns:repeat(3,1fr);}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .grid3{grid-template-columns:repeat(2,1fr);}
    }

    .grid4{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .grid4{grid-template-columns:repeat(4,1fr);}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .grid4{grid-template-columns:repeat(2,1fr);}
    }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .kpiTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .kpiTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .kpiValue{
      font-size:16px;
      font-weight:900;
      letter-spacing:.02em;
      margin-top:4px;
    }
    .kpiSub{
      font-size:12px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
    }
    .kpiList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:rgba(255,255,255,.90);
      align-items:center;
    }
    .kpiBadge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      color:rgba(255,255,255,.90);
    }
    .badgePos{border-color:rgba(124,255,192,.45); color:var(--pos)}
    .badgeNeg{border-color:rgba(255,138,138,.45); color:var(--neg)}
    .badgeNeu{border-color:rgba(255,255,255,.18); color:rgba(255,255,255,.85)}
    .badgeBoth{border-color:rgba(179,139,255,.45); color:var(--both)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px 9px;
      margin-bottom:8px;
    }

    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-size:13px;
      font-weight:900;
      letter-spacing:.03em;
    }
    .who{
      font-size:12px;
      color:var(--muted);
      max-width:720px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tagDem{border-color:rgba(74,163,255,.5); color:var(--dem)}
    .tagRep{border-color:rgba(255,90,90,.5); color:var(--rep)}
    .tagBoth{border-color:rgba(179,139,255,.55); color:var(--both)}
    .tagBuy{border-color:rgba(124,255,192,.45); color:var(--ok)}
    .tagSell{border-color:rgba(255,138,138,.45); color:var(--err)}
    .tagSEC{border-color:rgba(255,210,125,.40); color:var(--sec)}

    .metaRow{
      margin-top:7px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      line-height:1.25;
    }

    .counts{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .countItem{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }

    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dotDem{background:var(--dem)}
    .dotRep{background:var(--rep)}

    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0 7px}

    .miniLinks{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .miniLink{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      margin:10px 0 10px;
    }
    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .panelTitle h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.9);
      cursor:pointer;
    }
    iframe{
      width:100%;
      height:360px;
      border:0;
      border-radius:12px;
      background:#000;
      margin-top:8px;
    }

    .colsHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:2px 0 8px;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.05em;
      text-transform:uppercase;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin:6px 0 0;
      line-height:1.25;
    }

    .tabsBottom{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#151522f0;
      border-top:1px solid var(--border);
      backdrop-filter:blur(12px);
    }
    .tabBarBottom{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(5,1fr);
    }
    .tabBottom{
      text-align:center;
      padding:11px 10px 16px;
      font-size:11px;
      color:var(--muted);
      user-select:none;
      cursor:pointer;
    }
    .tabBottomActive{color:#fff}

    /* Strategy */
    .strategyHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .strategyTitle{
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
      margin:0;
    }
    .strategyPills{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .strategyPill{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
      cursor:pointer;
      user-select:none;
    }
    .strategyPill.on{
      background:rgba(255,255,255,.10);
      color:#fff;
    }
    .scoreExplain{
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
      margin-top:8px;
    }
    .strategyGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 980px){
      .strategyGrid{grid-template-columns:1fr 1fr 1fr;}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .strategyGrid{grid-template-columns:1fr 1fr;}
    }

    .stockItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
    }
    .stockTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .stockMeta{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }
    .rowBadges{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Holdings list */
    .holdingsGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 980px){
      .holdingsGrid{grid-template-columns:1fr 1fr;}
    }
    .holdingsItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="h1" id="pageTitle">Convergence</div>
      <div class="subtle" id="reportDate"></div>
    </div>
    <button class="pillBtn" id="refreshBtn">Refresh</button>
  </header>

  <main class="container">
    <div class="status" id="statusBox">
      <strong>Status:</strong> <span id="statusText">Loading‚Ä¶</span><br/>
      <span class="mono" id="statusDetail"></span>
    </div>

    <div class="tabRow">
      <button class="tabBtn tabBtnActive" id="tabMainBtn">Main</button>
      <button class="tabBtn" id="tabCongressBtn">Congress Trading</button>
      <button class="tabBtn" id="tabCryptoBtn">Crypto</button>
      <button class="tabBtn" id="tabScoreBtn">Score</button>
      <button class="tabBtn" id="tabSearchBtn">Search</button>

      <div class="rightTools" id="mainWindowTools">
        <div class="seg" aria-label="window toggle">
          <button id="btn30" class="on">30D</button>
          <button id="btn180">180D</button>
          <button id="btn365">365D</button>
        </div>
      </div>
    </div>

    <div id="stockPanel" style="display:none;"></div>

    <!-- MAIN TAB -->
    <section id="viewMain">
      <div class="sectionTitle">Market entry</div>
      <div class="panel">
        <div class="grid3">
          <div class="kpi" id="entryKpiScore"></div>
          <div class="kpi" id="entryKpiRules"></div>
          <div class="kpi" id="entryKpiBuffett"></div>
        </div>
        <div class="hint" id="entryHint" style="margin-top:10px;"></div>
      </div>

      <div class="sectionTitle">Strategy</div>
      <div class="panel">
        <div class="strategyHeader">
          <div>
            <div class="strategyTitle">5‚Äì10Y Accumulation Strategy</div>
            <div class="hint" style="margin-top:6px;">
              Value-tilted accumulation in AI, chips, medical innovation, robotics, and infrastructure. Congress is a weighted signal, not a requirement.
            </div>
          </div>
          <div class="strategyPills" id="strategySectorPills"></div>
        </div>

        <div class="divider"></div>

        <div class="grid3">
          <div class="kpi" id="strategyPhilosophyBox"></div>
          <div class="kpi" id="strategyScoringBox"></div>
          <div class="kpi" id="strategyTopPicksBox"></div>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle" id="strategyListTitle" style="margin-top:0;">Ranked ideas</div>
        <div id="strategyList" class="strategyGrid"></div>

        <div class="hint" id="strategyHint" style="margin-top:10px;">
          Scores are designed for comparison inside the strategy, not a promise of returns.
        </div>
      </div>
    </section>

    <!-- CONGRESS TRADING TAB -->
    <section id="viewCongress" style="display:none;">
      <div class="sectionTitle">Congress Trading</div>

      <div class="panel">
        <div class="panelTitle">
          <h2>Common holdings (overlap)</h2>
          <span class="kpiBadge badgeNeu" id="holdingsWindowBadge">365D</span>
        </div>
        <div class="hint" style="margin-top:6px;">
          This uses a holdings proxy based on disclosures in the selected window. It ranks tickers by how many unique members disclosed activity.
        </div>
        <div class="divider"></div>

        <div class="grid3">
          <div class="kpi" id="holdingsKpiTop"></div>
          <div class="kpi" id="holdingsKpiBreadth"></div>
          <div class="kpi" id="holdingsKpiRules"></div>
        </div>

        <div class="divider"></div>

        <div class="sectionTitle" style="margin-top:0;">Ranked by holder count</div>
        <div id="holdingsList" class="holdingsGrid"></div>

        <div class="hint" id="holdingsHint" style="margin-top:10px;"></div>
      </div>

      <div class="sectionTitle" id="kpiTitle">Congressman activity signal dashboard (top 4, rolling 30 days)</div>
      <div class="grid4">
        <div class="kpi" id="kpiNet"></div>
        <div class="kpi" id="kpiPart"></div>
        <div class="kpi" id="kpiTop"></div>
        <div class="kpi" id="kpiHighlights"></div>
      </div>

      <div class="sectionTitle" id="convTitle">Convergence üî• (bipartisan overlap on BUY, rolling 30 days)</div>
      <div id="convergenceList"></div>

      <div class="sectionTitle" id="partTitle">Congress trades by participation (rolling 30 days)</div>
      <div class="colsHeader">
        <div>Buys (left)</div>
        <div>Sells (right)</div>
      </div>

      <div class="grid2">
        <div><div id="buyList"></div></div>
        <div><div id="sellList"></div></div>
      </div>

      <div class="hint" id="mainHint"></div>
    </section>

    <!-- CRYPTO TAB -->
    <section id="viewCrypto" style="display:none;">
      <div class="sectionTitle" id="cryptoTitle">Crypto congress disclosures (rolling 30 days)</div>

      <div class="grid2">
        <div>
          <div class="sectionTitle">Buys</div>
          <div class="sectionTitle" style="margin-top:8px;">Direct crypto disclosures</div>
          <div id="cryptoDirectBuys"></div>
          <div class="sectionTitle" style="margin-top:14px;">Crypto-linked tickers (ETFs, miners, exchanges)</div>
          <div id="cryptoLinkedBuys"></div>
        </div>

        <div>
          <div class="sectionTitle">Sells</div>
          <div class="sectionTitle" style="margin-top:8px;">Direct crypto disclosures</div>
          <div id="cryptoDirectSells"></div>
          <div class="sectionTitle" style="margin-top:14px;">Crypto-linked tickers (ETFs, miners, exchanges)</div>
          <div id="cryptoLinkedSells"></div>
        </div>
      </div>

      <div class="hint" id="cryptoHint"></div>
    </section>

    <!-- SCORE TAB -->
    <section id="viewScore" style="display:none;">
      <div class="sectionTitle">Score a ticker</div>

      <div class="panel">
        <div class="hint" style="margin-top:0;">
          Enter any ticker. The same strategy scoring rules are applied. Congress can add points, but it is never required.
        </div>

        <div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
          <input id="scoreInput" placeholder="Ticker (example: ISRG)" autocapitalize="characters"
                 style="flex:1; min-width:220px; padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#fff; font-size:13px;" />
          <select id="scoreSector"
                  style="padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#fff; font-size:13px;">
            <option value="auto">Auto sector</option>
            <option value="ai">AI</option>
            <option value="chips">Chips</option>
            <option value="medical">Medical</option>
            <option value="robotics">Robotics</option>
            <option value="infrastructure">Infrastructure</option>
          </select>
          <button class="pillBtn" id="scoreGoBtn">Score</button>
        </div>

        <div id="scoreResult" style="margin-top:12px;"></div>
      </div>
    </section>

    <!-- SEARCH TAB -->
    <section id="viewSearch" style="display:none;">
      <div class="sectionTitle">Search ticker</div>
      <div class="panel">
        <div class="metaRow" style="margin-top:0;">
          <div style="color:rgba(255,255,255,.9)">Type a ticker (example: NVDA)</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input id="searchInput" placeholder="Ticker" autocapitalize="characters"
                 style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#fff; font-size:13px;" />
          <button class="pillBtn" id="searchBtn">Go</button>
        </div>
        <div class="hint" style="margin-top:10px;">Opens the chart panel for quick trend context.</div>
      </div>
    </section>
  </main>

  <nav class="tabsBottom">
    <div class="tabBarBottom">
      <div class="tabBottom tabBottomActive" id="navMain">Main</div>
      <div class="tabBottom" id="navCongress">Congress</div>
      <div class="tabBottom" id="navCrypto">Crypto</div>
      <div class="tabBottom" id="navScore">Score</div>
      <div class="tabBottom" id="navSearch">Search</div>
    </div>
  </nav>

  <script>
    const BACKEND_BASE = "https://finance-backend-dzta.onrender.com";

    // Existing trade activity endpoint
    const TODAY_URL = (windowDays) => `${BACKEND_BASE}/report/today?window_days=${encodeURIComponent(String(windowDays))}`;

    // Holdings overlap endpoint (matches the cleaned backend: /report/congress-holdings)
    const HOLDINGS_COMMON_URL = (windowDays) => `${BACKEND_BASE}/report/congress-holdings?window_days=${encodeURIComponent(String(windowDays))}&top_n=30`;

    // Market entry endpoint (backend should implement for reliable scoring)
    const ENTRY_URL = (windowDays) => `${BACKEND_BASE}/market/entry?window_days=${encodeURIComponent(String(windowDays))}`;

    const el = (id) => document.getElementById(id);

    let ACTIVE_TAB = "Main";
    let WINDOW_DAYS = 30;

    let CACHE_MAIN = new Map();
    let CACHE_HOLDINGS = new Map();
    let CACHE_ENTRY = new Map();

    // Crypto
    const CRYPTO_TICKERS = new Set([
      "COIN","MSTR","RIOT","MARA","HUT","CLSK","SQ","PYPL",
      "IBIT","FBTC","GBTC","BITO","ARKB","BTCO","HODL","BITB",
      "ETHE","ETHA","WGMI","BKCH","BLOK","BITQ","DAPP"
    ]);
    const DIRECT_COIN_SET = new Set([
      "BTC","ETH","SOL","LINK","XRP","ADA","DOGE","AVAX","MATIC","BNB"
    ]);

    // Strategy weights
    const STRATEGY_WEIGHTS = {
      innovationFit: 40,
      congressSignal: 25,
      valueDiscipline: 20,
      riskPenalty: 15
    };

    // Strategy sectors
    const SECTOR_ORDER = [
      { key:"ai", label:"AI" },
      { key:"chips", label:"Chips" },
      { key:"medical", label:"Medical" },
      { key:"robotics", label:"Robotics" },
      { key:"infrastructure", label:"Infrastructure" },
    ];

    // Sector seeds
    const SECTOR_SEEDS = {
      ai: ["NVDA","MSFT","GOOGL","AMZN","META","AVGO","ORCL","PLTR","SNOW","DDOG","NOW","CRM"],
      chips: ["NVDA","AVGO","AMD","INTC","ASML","TSM","MU","QCOM","ARM","LRCX","AMAT","KLAC","ADI","MRVL"],
      medical: ["ISRG","MDT","BSX","SYK","JNJ","ABT","TMO","DHR","IDXX","EW","ZBH","DXCM","PODD","RMD","REGN","VRTX","MRNA","BMY","LLY","NVO","HCA","UHS"],
      robotics: ["ISRG","ROK","TER","ZBRA","SYM","ABB","FANUY","YASKY","KUKAY","HON","EMR","IR","PH","AME","RRX","CGNX","TDY","BOTZ","ROBO"],
      infrastructure: ["ANET","CSCO","MSFT","AMZN","GOOGL","ORCL","EQIX","DLR","VRT","ETN","PWR","NVT","HUBB","AME","TT","NEE","CEG","CCJ","BEPC","ENPH"]
    };

    // Taxonomy map
    const TICKER_SECTOR_MAP = {
      "NVDA":["ai","chips"], "MSFT":["ai","infrastructure"], "GOOGL":["ai","infrastructure"], "AMZN":["ai","infrastructure"],
      "META":["ai"], "PLTR":["ai"], "SNOW":["ai"], "DDOG":["ai"], "NOW":["ai"], "CRM":["ai"], "ORCL":["ai","infrastructure"],
      "AVGO":["chips","ai","infrastructure"], "AMD":["chips"], "INTC":["chips"], "ASML":["chips"], "TSM":["chips"],
      "MU":["chips"], "QCOM":["chips"], "ARM":["chips"], "LRCX":["chips"], "AMAT":["chips"], "KLAC":["chips"], "ADI":["chips"], "MRVL":["chips"],
      "ISRG":["medical","robotics"], "MDT":["medical"], "BSX":["medical"], "SYK":["medical"], "JNJ":["medical"], "ABT":["medical"],
      "TMO":["medical"], "DHR":["medical"], "IDXX":["medical"], "EW":["medical"], "ZBH":["medical"], "DXCM":["medical"], "PODD":["medical"],
      "RMD":["medical"], "REGN":["medical"], "VRTX":["medical"], "MRNA":["medical"], "BMY":["medical"], "LLY":["medical"], "NVO":["medical"],
      "HCA":["medical"], "UHS":["medical"],
      "ROK":["robotics"], "TER":["robotics","chips"], "ZBRA":["robotics"], "SYM":["robotics"],
      "ABB":["robotics"], "FANUY":["robotics"], "YASKY":["robotics"], "KUKAY":["robotics"],
      "HON":["robotics","infrastructure"], "EMR":["robotics","infrastructure"], "IR":["robotics","infrastructure"], "PH":["robotics","infrastructure"],
      "AME":["robotics","infrastructure"], "RRX":["robotics"], "CGNX":["robotics"], "TDY":["robotics"],
      "BOTZ":["robotics"], "ROBO":["robotics"],
      "ANET":["infrastructure"], "CSCO":["infrastructure"], "EQIX":["infrastructure"], "DLR":["infrastructure"],
      "VRT":["infrastructure"], "ETN":["infrastructure"], "PWR":["infrastructure"], "NVT":["infrastructure"], "HUBB":["infrastructure"],
      "TT":["infrastructure"], "NEE":["infrastructure"], "CEG":["infrastructure"], "CCJ":["infrastructure"], "BEPC":["infrastructure"], "ENPH":["infrastructure"]
    };

    function setStatus(kind, text, detail){
      const st = el("statusText");
      const sd = el("statusDetail");
      st.textContent = text || "";
      st.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
      sd.textContent = detail || "";
    }

    function setTitleForTab(tab){
      const map = {
        "Main":"Convergence",
        "Congress":"Congress Trading",
        "Crypto":"Crypto",
        "Score":"Score",
        "Search":"Search"
      };
      el("pageTitle").textContent = map[tab] || "Convergence";
    }

    function showTab(tab){
      ACTIVE_TAB = tab;
      setTitleForTab(tab);

      el("viewMain").style.display = tab === "Main" ? "" : "none";
      el("viewCongress").style.display = tab === "Congress" ? "" : "none";
      el("viewCrypto").style.display = tab === "Crypto" ? "" : "none";
      el("viewScore").style.display = tab === "Score" ? "" : "none";
      el("viewSearch").style.display = tab === "Search" ? "" : "none";

      el("tabMainBtn").classList.toggle("tabBtnActive", tab === "Main");
      el("tabCongressBtn").classList.toggle("tabBtnActive", tab === "Congress");
      el("tabCryptoBtn").classList.toggle("tabBtnActive", tab === "Crypto");
      el("tabScoreBtn").classList.toggle("tabBtnActive", tab === "Score");
      el("tabSearchBtn").classList.toggle("tabBtnActive", tab === "Search");

      el("navMain").classList.toggle("tabBottomActive", tab === "Main");
      el("navCongress").classList.toggle("tabBottomActive", tab === "Congress");
      el("navCrypto").classList.toggle("tabBottomActive", tab === "Crypto");
      el("navScore").classList.toggle("tabBottomActive", tab === "Score");
      el("navSearch").classList.toggle("tabBottomActive", tab === "Search");

      el("mainWindowTools").style.display = (tab === "Congress" || tab === "Crypto" || tab === "Score") ? "" : "none";

      if (tab === "Main"){
        loadMain(false);
        loadEntryIndex(365, false);
      }
      if (tab === "Congress"){
        loadMain(false);
        loadHoldingsCommon(365, false);
      }
      if (tab === "Crypto"){
        loadMain(false);
      }
      if (tab === "Score"){
        loadMain(false);
        maybeAutoScoreFromHash();
      }

      handleHash();
    }

    function normalizeList(arr){ return Array.isArray(arr) ? arr.slice() : []; }

    function tickerLinksHTML(ticker){
      const t = String(ticker||"").toUpperCase();
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tvChart = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent("NASDAQ:" + t)}`;
      return `
        <div class="miniLinks">
          <a class="miniLink" href="#stock=${t}">Chart</a>
          <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Yahoo</a>
          <a class="miniLink" href="${tvChart}" target="_blank" rel="noopener">TV</a>
        </div>
      `;
    }

    // Stock panel
    function setStockPanel(ticker){
      const t = String(ticker||"").toUpperCase();
      if (!t){
        el("stockPanel").style.display = "none";
        el("stockPanel").innerHTML = "";
        return;
      }

      const symbol = "NASDAQ:" + t;
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tv = `https://www.tradingview.com/symbols/${encodeURIComponent(symbol)}/`;

      el("stockPanel").style.display = "";
      el("stockPanel").innerHTML = `
        <div class="panel">
          <div class="panelTitle">
            <h2>${t} chart</h2>
            <button class="closeBtn" id="closeStockBtn">Close</button>
          </div>
          <iframe
            title="TradingView Chart"
            src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=D&hidesidetoolbar=0&symboledit=1&saveimage=1&toolbarbg=%23151522&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1"
            loading="lazy">
          </iframe>
          <div class="miniLinks">
            <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Open Yahoo</a>
            <a class="miniLink" href="${tv}" target="_blank" rel="noopener">Open TradingView</a>
          </div>
        </div>
      `;

      const btn = document.getElementById("closeStockBtn");
      if (btn) btn.addEventListener("click", () => {
        history.pushState("", document.title, window.location.pathname + window.location.search);
        setStockPanel("");
      });
    }

    function handleHash(){
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim();
        setStockPanel(t);
        return;
      }
      setStockPanel("");
    }

    // Congress scoring helpers
    function congressScore(x){
      return Number(x.demBuyers||0)+Number(x.repBuyers||0)+Number(x.demSellers||0)+Number(x.repSellers||0);
    }
    function bipartisanScore(x){
      const dem = Number(x.demBuyers||0)+Number(x.demSellers||0);
      const rep = Number(x.repBuyers||0)+Number(x.repSellers||0);
      return Math.min(dem, rep);
    }
    function sortByCongressStrength(a,b){
      const ta = congressScore(a), tb = congressScore(b);
      if (ta !== tb) return tb - ta;
      const ba = bipartisanScore(a), bb = bipartisanScore(b);
      if (ba !== bb) return bb - ba;
      return String(a.ticker||"").localeCompare(String(b.ticker||""), undefined, {sensitivity:"base"});
    }
    function netFlow(x){
      const buys = Number(x.demBuyers||0) + Number(x.repBuyers||0);
      const sells = Number(x.demSellers||0) + Number(x.repSellers||0);
      return buys - sells;
    }
    function confidenceLabel(x){
      const t = congressScore(x);
      if (t >= 6) return "STRONG";
      if (t >= 3) return "MOD";
      return "WEAK";
    }
    function confidenceBadgeClass(lbl){
      if (lbl === "STRONG") return "badgePos";
      if (lbl === "MOD") return "badgeNeu";
      return "badgeNeu";
    }

    function cardHTML(x, mode){
      const ticker = String(x.ticker||"").toUpperCase();
      const who = String(x.companyName||"").trim();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";

      const dem = mode === "BUY" ? Number(x.demBuyers||0) : Number(x.demSellers||0);
      const rep = mode === "BUY" ? Number(x.repBuyers||0) : Number(x.repSellers||0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                ${who ? `<div class="who">${who}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${mode === "BUY" ? `<span class="tag tagBuy">BUY</span>` : `<span class="tag tagSell">SELL</span>`}
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function overlapCardHTML(x){
      const ticker = String(x.ticker||"").toUpperCase();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";
      const dem = Number(x.demBuyers||0);
      const rep = Number(x.repBuyers||0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                <div class="who">Bipartisan overlap (BUY)</div>
              </div>
            </div>
            <div class="tags">
              <span class="tag tagDem">DEM</span>
              <span class="tag tagRep">GOP</span>
              <span class="tag tagBoth">OVERLAP</span>
              <span class="tag tagBuy">BUY</span>
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function topBy(arr, scoreFn, n){
      const a = normalizeList(arr).slice();
      a.sort((x,y) => (scoreFn(y) - scoreFn(x)) || String(x.ticker||"").localeCompare(String(y.ticker||""), undefined, {sensitivity:"base"}));
      return a.slice(0, n);
    }

    function renderKpis(convergence, buys, sells, windowDays){
      const merged = new Map();
      function addCard(x){
        const t = String(x.ticker||"").toUpperCase();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0 };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        merged.set(t, cur);
      }
      buys.forEach(addCard);
      sells.forEach(addCard);

      const mergedArr = Array.from(merged.values());
      const win = Number(windowDays || 30);
      el("kpiTitle").textContent = `Congressman activity signal dashboard (top 4, rolling ${win} days)`;

      const topNet = topBy(mergedArr, x => netFlow(x), 5);
      el("kpiNet").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Net flow</div>
            <div class="kpiValue">Buys - Sells</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Highest accumulation or distribution in rolling ${win}D.</div>
        <div class="kpiList">
          ${topNet.map(x => {
            const nf = netFlow(x);
            const cls = nf > 0 ? "badgePos" : nf < 0 ? "badgeNeg" : "badgeNeu";
            const sign = nf > 0 ? "+" : "";
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${sign}${nf}</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      const topPart = topBy(mergedArr, x => congressScore(x), 5);
      el("kpiPart").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Participation</div>
            <div class="kpiValue">Total activity</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Total participation (both parties) in rolling ${win}D.</div>
        <div class="kpiList">
          ${topPart.map(x => {
            const total = congressScore(x);
            const lbl = confidenceLabel(x);
            const cls = confidenceBadgeClass(lbl);
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${lbl} ¬∑ ${total}</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      const topTickers = topBy(mergedArr, x => congressScore(x), 5);
      el("kpiTop").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top tickers</div>
            <div class="kpiValue">Intensity</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Most active tickers in rolling ${win}D.</div>
        <div class="kpiList">
          ${topTickers.map(x => {
            const total = congressScore(x);
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge badgeNeu">${total} items</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      const topAcc = topBy(mergedArr, x => netFlow(x), 1)[0];
      const topDist = topBy(mergedArr, x => -netFlow(x), 1)[0];
      const topConv = (convergence && convergence.length) ? convergence.slice().sort(sortByCongressStrength)[0] : null;

      el("kpiHighlights").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top signals</div>
            <div class="kpiValue">Fast read</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Best accumulation, selling, and overlap in rolling ${win}D.</div>
        <div class="kpiList">
          <div class="kpiRow"><span class="muted">üìà Accumulation</span>${topAcc ? `<a href="#stock=${topAcc.ticker}"><strong>${topAcc.ticker}</strong></a>` : `<span class="muted">None</span>`}</div>
          <div class="kpiRow"><span class="muted">üìâ Selling</span>${topDist ? `<a href="#stock=${topDist.ticker}"><strong>${topDist.ticker}</strong></a>` : `<span class="muted">None</span>`}</div>
          <div class="kpiRow"><span class="muted">ü§ù Overlap</span>${topConv ? `<a href="#stock=${String(topConv.ticker||"").toUpperCase()}"><strong>${String(topConv.ticker||"").toUpperCase()}</strong></a>` : `<span class="muted">None</span>`}</div>
        </div>
      `;
    }

    function renderCongressTradeSections(data){
      const win = Number(data.windowDays || WINDOW_DAYS || 30);
      el("convTitle").textContent = `Convergence üî• (bipartisan overlap on BUY, rolling ${win} days)`;
      el("partTitle").textContent = `Congress trades by participation (rolling ${win} days)`;
      el("mainHint").textContent = `Sort is by total participation within rolling ${win} days. Tap ticker for chart.`;

      const convergence = normalizeList(data.convergence).sort(sortByCongressStrength);
      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers).sort(sortByCongressStrength);
      const sells = normalizeList(data.politicianSells).sort(sortByCongressStrength);

      renderKpis(convergence, buys, sells, win);

      el("convergenceList").innerHTML =
        convergence.length ? convergence.map(overlapCardHTML).join("") : "<div class='subtle'>No overlap tickers in this window.</div>";

      el("buyList").innerHTML =
        buys.length ? buys.map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No buy trades found.</div>";

      el("sellList").innerHTML =
        sells.length ? sells.map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No sell trades found.</div>";
    }

    // Crypto rendering
    function partyTag(p){
      const s = String(p||"").toUpperCase();
      if (s === "D") return `<span class="tag tagDem">DEM</span>`;
      if (s === "R") return `<span class="tag tagRep">GOP</span>`;
      return `<span class="tag badgeNeu">?</span>`;
    }
    function coinsToLabel(coins){
      const arr = Array.isArray(coins) ? coins.map(x => String(x||"").toUpperCase()).filter(Boolean) : [];
      const cleaned = arr.filter(c => c !== "CRYPTO-LINKED");
      if (!cleaned.length) return "CRYPTO";
      return cleaned.join(" ¬∑ ");
    }
    function isDirectCryptoRow(r){
      const coins = Array.isArray(r.coins) ? r.coins : [];
      return coins.some(c => DIRECT_COIN_SET.has(String(c||"").toUpperCase()));
    }
    function cryptoDirectCardHTML(r){
      const kind = String(r.kind || "").toUpperCase();
      const who = String(r.politician || "").trim();
      const chamber = String(r.chamber || "").trim();
      const amt = String(r.amountRange || "").trim();
      const traded = String(r.traded || "");
      const filed = String(r.filed || "");
      const desc = String(r.description || "").trim();
      const sym = coinsToLabel(r.coins);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <div class="ticker">${sym}</div>
                ${who ? `<div class="who">${who}${chamber ? " ¬∑ " + chamber : ""}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${kind === "BUY" ? `<span class="tag tagBuy">BUY</span>` : kind === "SELL" ? `<span class="tag tagSell">SELL</span>` : `<span class="tag badgeNeu">${kind || "TX"}</span>`}
              ${partyTag(r.party)}
            </div>
          </div>

          <div class="divider"></div>

          ${desc ? `
            <div class="metaRow">
              <div style="max-width:820px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${desc}
              </div>
            </div>
          ` : ""}

          <div class="metaRow">
            <div class="counts">
              ${amt ? `<div class="countItem">Amount: <strong>${amt}</strong></div>` : ""}
              ${traded ? `<div class="countItem">Traded: <strong>${traded}</strong></div>` : ""}
              ${filed ? `<div class="countItem">Filed: <strong>${filed}</strong></div>` : ""}
            </div>
          </div>
        </div>
      `;
    }

    function renderCryptoFromMain(data){
      const win = Number(data.windowDays || WINDOW_DAYS || 30);
      el("cryptoTitle").textContent = `Crypto congress disclosures (rolling ${win} days)`;

      const crypto = (data && data.crypto && typeof data.crypto === "object") ? data.crypto : {};
      const raw = normalizeList(crypto.raw);

      const direct = raw.filter(isDirectCryptoRow);
      const directBuys = direct.filter(x => String(x.kind||"").toUpperCase() === "BUY");
      const directSells = direct.filter(x => String(x.kind||"").toUpperCase() === "SELL");

      el("cryptoDirectBuys").innerHTML =
        directBuys.length ? directBuys.map(cryptoDirectCardHTML).join("") : "<div class='subtle'>No direct crypto buys in this window.</div>";

      el("cryptoDirectSells").innerHTML =
        directSells.length ? directSells.map(cryptoDirectCardHTML).join("") : "<div class='subtle'>No direct crypto sells in this window.</div>";

      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers)
        .filter(x => CRYPTO_TICKERS.has(String(x.ticker||"").toUpperCase()))
        .sort(sortByCongressStrength);

      const sells = normalizeList(data.politicianSells)
        .filter(x => CRYPTO_TICKERS.has(String(x.ticker||"").toUpperCase()))
        .sort(sortByCongressStrength);

      el("cryptoLinkedBuys").innerHTML =
        buys.length ? buys.map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No crypto-linked buys in this window.</div>";

      el("cryptoLinkedSells").innerHTML =
        sells.length ? sells.map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No crypto-linked sells in this window.</div>";

      el("cryptoHint").textContent =
        "Direct crypto items are parsed from disclosure text. Crypto-linked tickers are ETFs, miners, and exchanges from the congress feed.";
    }

    // Strategy
    const clamp01 = (x) => Math.max(0, Math.min(1, x));
    function saturating01(x, k=6){
      return 1 - Math.exp(-(Number(x||0) / k));
    }

    function sectorsForTicker(ticker){
      const t = String(ticker||"").toUpperCase().trim();
      if (!t) return [];
      const mapped = TICKER_SECTOR_MAP[t];
      return Array.isArray(mapped) ? mapped.slice() : [];
    }

    function inferSectorForTicker(ticker){
      const secs = sectorsForTicker(ticker);
      if (secs.includes("medical")) return "medical";
      if (secs.includes("robotics")) return "robotics";
      if (secs.includes("chips")) return "chips";
      if (secs.includes("ai")) return "ai";
      if (secs.includes("infrastructure")) return "infrastructure";
      return "ai";
    }

    function buildCongressAggMap(payload){
      const map = new Map();
      const buys = Array.isArray(payload?.politicianBuys) ? payload.politicianBuys : [];
      const sells = Array.isArray(payload?.politicianSells) ? payload.politicianSells : [];
      function add(card){
        const t = String(card?.ticker || "").toUpperCase().trim();
        if (!t) return;
        const cur = map.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0 };
        cur.demBuyers += Number(card.demBuyers || 0);
        cur.repBuyers += Number(card.repBuyers || 0);
        cur.demSellers += Number(card.demSellers || 0);
        cur.repSellers += Number(card.repSellers || 0);
        map.set(t, cur);
      }
      buys.forEach(add);
      sells.forEach(add);
      return map;
    }

    function congressMetrics(agg){
      if (!agg) return { hasCongress:false, participation:0, buys:0, sells:0, net:0, bipartisanBuyOverlap:0 };
      const buys = Number(agg.demBuyers||0) + Number(agg.repBuyers||0);
      const sells = Number(agg.demSellers||0) + Number(agg.repSellers||0);
      const participation = buys + sells;
      const bipartisanBuyOverlap = Math.min(Number(agg.demBuyers||0), Number(agg.repBuyers||0));
      return { hasCongress: participation>0, participation, buys, sells, net: buys-sells, bipartisanBuyOverlap };
    }

    function scoreCongressSignal(metrics){
      const part01 = saturating01(metrics.participation, 5);
      const net01 = clamp01((metrics.net + 4) / 8);
      const overlap01 = saturating01(metrics.bipartisanBuyOverlap, 2);
      const weighted01 = 0.55*part01 + 0.30*net01 + 0.15*overlap01;
      return weighted01 * STRATEGY_WEIGHTS.congressSignal;
    }

    function scoreInnovationFit(sectorKey, ticker){
      const baseBySector = { ai:0.95, chips:0.95, medical:0.92, robotics:0.92, infrastructure:0.85 };
      const base01 = baseBySector[sectorKey] ?? 0.6;

      const secs = sectorsForTicker(ticker);
      const inSector = secs.includes(sectorKey) || (SECTOR_SEEDS[sectorKey] || []).includes(ticker);

      const sectorCap = inSector ? 1.0 : 0.15;
      return clamp01(base01 * sectorCap) * STRATEGY_WEIGHTS.innovationFit;
    }

    function scoreValueDiscipline(){
      return 0.50 * STRATEGY_WEIGHTS.valueDiscipline;
    }

    function riskPenalty(ticker){
      const highBetaSpec = new Set(["MARA","RIOT","GME"]);
      const pen01 = highBetaSpec.has(String(ticker).toUpperCase()) ? 0.50 : 0.20;
      return pen01 * STRATEGY_WEIGHTS.riskPenalty;
    }

    function scoreTicker({ sectorKey, ticker, congressAggMap }){
      const agg = congressAggMap.get(ticker);
      const cm = congressMetrics(agg);

      const sInnovation = scoreInnovationFit(sectorKey, ticker);
      const sCongress   = scoreCongressSignal(cm);
      const sValue      = scoreValueDiscipline();
      const pRisk       = riskPenalty(ticker);

      const total = Math.round(sInnovation + sCongress + sValue - pRisk);

      return {
        ticker,
        sectorKey,
        score: Math.max(0, Math.min(100, total)),
        breakdown: {
          innovation: Math.round(sInnovation),
          congress: Math.round(sCongress),
          value: Math.round(sValue),
          risk: Math.round(pRisk)
        },
        badges: {
          horizon: "5‚Äì10Y",
          congress: cm.hasCongress ? "Congress-confirmed" : "Research list"
        }
      };
    }

    function buildSectorCandidates(sectorKey, discoveredTickers){
      const seeds = (SECTOR_SEEDS[sectorKey] || []).map(t => t.toUpperCase());
      const disc = (Array.isArray(discoveredTickers) ? discoveredTickers : [])
        .map(t => String(t||"").toUpperCase().trim()).filter(Boolean);

      const filteredDisc = disc.filter(t => sectorsForTicker(t).includes(sectorKey));
      return Array.from(new Set([...seeds, ...filteredDisc]));
    }

    function rankSector(sectorKey, payload){
      const congressAggMap = buildCongressAggMap(payload);
      const discovered = Array.from(congressAggMap.keys());
      const candidates = buildSectorCandidates(sectorKey, discovered);
      const scored = candidates.map(ticker => scoreTicker({ sectorKey, ticker, congressAggMap }));
      scored.sort((a,b) => (b.score - a.score) || a.ticker.localeCompare(b.ticker));
      return scored;
    }

    let STRATEGY_ACTIVE_SECTOR = "ai";

    function buildStrategyPills(){
      const host = el("strategySectorPills");
      host.innerHTML = SECTOR_ORDER.map(s => {
        const on = s.key === STRATEGY_ACTIVE_SECTOR ? "on" : "";
        return `<div class="strategyPill ${on}" data-sector="${s.key}">${s.label}</div>`;
      }).join("");

      Array.from(host.querySelectorAll(".strategyPill")).forEach(p => {
        p.addEventListener("click", () => {
          STRATEGY_ACTIVE_SECTOR = String(p.getAttribute("data-sector") || "ai");
          buildStrategyPills();
          const cached = CACHE_MAIN.get(String(WINDOW_DAYS));
          if (cached) renderStrategy(cached);
        });
      });
    }

    function strategyStockHTML(row){
      const t = String(row.ticker || "").toUpperCase();
      const sc = Number(row.score || 0);
      const b = row.breakdown || {};
      const horizon = row.badges?.horizon || "5‚Äì10Y";
      const cBadge = row.badges?.congress || "Research list";
      const cCls = (cBadge === "Congress-confirmed") ? "badgeBoth" : "badgeNeu";

      return `
        <div class="stockItem">
          <div class="stockTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${encodeURIComponent(t)}">${t}</a>
                <span class="kpiBadge badgeNeu">${horizon}</span>
              </div>
              <div class="stockMeta">
                <span class="kpiBadge ${cCls}">${cBadge}</span>
                <span class="kpiBadge badgeNeu">Score: <strong>${sc}/100</strong></span>
              </div>
            </div>

            <div class="rowBadges">
              <span class="kpiBadge badgeNeu">Innov ${Number(b.innovation||0)}</span>
              <span class="kpiBadge badgeNeu">Congress ${Number(b.congress||0)}</span>
              <span class="kpiBadge badgeNeu">Value ${Number(b.value||0)}</span>
              <span class="kpiBadge badgeNeg">Risk -${Number(b.risk||0)}</span>
            </div>
          </div>

          <div class="miniLinks">
            <a class="miniLink" href="#stock=${t}">Chart</a>
            <a class="miniLink" target="_blank" rel="noopener" href="https://finance.yahoo.com/quote/${encodeURIComponent(t)}">Yahoo</a>
            <a class="miniLink" target="_blank" rel="noopener" href="https://www.tradingview.com/chart/?symbol=${encodeURIComponent("NASDAQ:" + t)}">TV</a>
          </div>
        </div>
      `;
    }

    function renderStrategy(payload){
      buildStrategyPills();

      el("strategyPhilosophyBox").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Philosophy</div>
            <div class="kpiValue">Accumulate innovation</div>
          </div>
          <span class="kpiBadge badgeNeu">5‚Äì10Y</span>
        </div>
        <div class="kpiSub">
          Focus on durable moats in AI, chips, medical, robotics, and infrastructure.
          Congress is weighted, not required. Accumulate gradually and hold through volatility.
        </div>
      `;

      const w = STRATEGY_WEIGHTS;
      el("strategyScoringBox").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Scoring rules</div>
            <div class="kpiValue">Total score</div>
          </div>
          <span class="kpiBadge badgeNeu">0‚Äì100</span>
        </div>
        <div class="kpiSub">
          <div class="kpiRow"><span>Innovation fit</span><span class="kpiBadge badgeNeu">${w.innovationFit} pts</span></div>
          <div class="kpiRow"><span>Congress signal</span><span class="kpiBadge badgeNeu">${w.congressSignal} pts</span></div>
          <div class="kpiRow"><span>Value discipline</span><span class="kpiBadge badgeNeu">${w.valueDiscipline} pts</span></div>
          <div class="kpiRow"><span>Risk penalty</span><span class="kpiBadge badgeNeg">-${w.riskPenalty} pts</span></div>
          <div class="scoreExplain"><strong>Total</strong> = Innovation + Congress + Value ‚àí Risk.</div>
        </div>
      `;

      const sectorLabel = (SECTOR_ORDER.find(s => s.key === STRATEGY_ACTIVE_SECTOR)?.label) || "Strategy";
      el("strategyListTitle").textContent = `Ranked ideas: ${sectorLabel}`;

      const ranked = rankSector(STRATEGY_ACTIVE_SECTOR, payload).slice(0, 12);

      el("strategyList").innerHTML = ranked.length
        ? ranked.map(strategyStockHTML).join("")
        : "<div class='subtle'>No strategy candidates found.</div>";

      const top = ranked.slice(0, 5);
      el("strategyTopPicksBox").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top picks</div>
            <div class="kpiValue">${sectorLabel}</div>
          </div>
          <span class="kpiBadge badgeNeu">Top 5</span>
        </div>
        <div class="kpiSub">Highest total scores in this sector right now.</div>
        <div class="kpiList">
          ${top.map(r => {
            const t = r.ticker;
            const sc = r.score;
            const badge = (r.badges?.congress === "Congress-confirmed") ? "badgeBoth" : "badgeNeu";
            const label = r.badges?.congress || "Research list";
            return `
              <div class="kpiRow">
                <a href="#stock=${encodeURIComponent(t)}"><strong>${t}</strong></a>
                <span class="kpiBadge ${badge}">${sc}/100 ¬∑ ${label}</span>
              </div>
            `;
          }).join("") || `<div class="kpiRow"><span class="muted">No data</span></div>`}
        </div>
      `;

      el("strategyHint").textContent =
        "Discovered tickers only appear in a sector if the taxonomy maps them there. Seeds keep each sector populated.";
    }

    // Score tab
    function scoreCardHTML(row){
      const t = String(row.ticker || "").toUpperCase();
      const b = row.breakdown || {};
      const sc = Number(row.score||0);
      const sectorLabel = (SECTOR_ORDER.find(s => s.key === row.sectorKey)?.label) || row.sectorKey;
      const horizon = row.badges?.horizon || "5‚Äì10Y";
      const cBadge = row.badges?.congress || "Research list";
      const cCls = (cBadge === "Congress-confirmed") ? "badgeBoth" : "badgeNeu";

      return `
        <div class="card" style="margin-bottom:0;">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${encodeURIComponent(t)}">${t}</a>
                <div class="who">Sector: ${sectorLabel}</div>
              </div>
            </div>
            <div class="tags">
              <span class="tag ${cCls}">${cBadge}</span>
              <span class="tag badgeNeu">${horizon}</span>
              <span class="tag badgeNeu">Score: ${sc}/100</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="kpiList">
            <div class="kpiRow"><span class="muted">Innovation fit</span><span class="kpiBadge badgeNeu">${Number(b.innovation||0)} pts</span></div>
            <div class="kpiRow"><span class="muted">Congress signal</span><span class="kpiBadge badgeNeu">${Number(b.congress||0)} pts</span></div>
            <div class="kpiRow"><span class="muted">Value discipline</span><span class="kpiBadge badgeNeu">${Number(b.value||0)} pts</span></div>
            <div class="kpiRow"><span class="muted">Risk penalty</span><span class="kpiBadge badgeNeg">-${Number(b.risk||0)} pts</span></div>
          </div>

          ${tickerLinksHTML(t)}
        </div>
      `;
    }

    function scoreSingleTicker(payload, ticker, sectorChoice){
      const t = String(ticker||"").toUpperCase().trim();
      if (!t) return null;
      const congressAggMap = buildCongressAggMap(payload || {});
      let sectorKey = sectorChoice && sectorChoice !== "auto" ? sectorChoice : inferSectorForTicker(t);
      if (!sectorKey) sectorKey = "ai";
      return scoreTicker({ sectorKey, ticker: t, congressAggMap });
    }

    function runScoreFromUI(){
      const cached = CACHE_MAIN.get(String(WINDOW_DAYS));
      const payload = cached || {};
      const t = String(el("scoreInput").value || "").trim().toUpperCase();
      const sectorChoice = String(el("scoreSector").value || "auto");
      if (!t){
        el("scoreResult").innerHTML = "<div class='subtle'>Enter a ticker.</div>";
        return;
      }
      const row = scoreSingleTicker(payload, t, sectorChoice);
      if (!row){
        el("scoreResult").innerHTML = "<div class='subtle'>Could not score that ticker.</div>";
        return;
      }
      el("scoreResult").innerHTML = scoreCardHTML(row);
      window.location.hash = "#stock=" + encodeURIComponent(row.ticker);
    }

    function maybeAutoScoreFromHash(){
      if (ACTIVE_TAB !== "Score") return;
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim().toUpperCase();
        if (t && !String(el("scoreInput").value||"").trim()){
          el("scoreInput").value = t;
        }
      }
    }

    // Market Entry Index (backend driven)
    function entryBadge(score){
      const s = Number(score || 0);
      if (s >= 75) return {label:"RISK-ON", cls:"badgePos"};
      if (s >= 55) return {label:"NEUTRAL", cls:"badgeNeu"};
      return {label:"RISK-OFF", cls:"badgeNeg"};
    }

    function renderEntryIndex(payload){
      if (!payload || typeof payload.score !== "number"){
        el("entryKpiScore").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">Market entry index</div>
              <div class="kpiValue">Unavailable</div>
            </div>
            <span class="kpiBadge badgeNeu">Needs backend</span>
          </div>
          <div class="kpiSub">
            Add <span class="mono">/market/entry</span> to compute a real entry score from SPX trend, volatility, breadth, credit, and a Buffett proxy.
          </div>
        `;

        el("entryKpiRules").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">How it works</div>
              <div class="kpiValue">Score 0‚Äì100</div>
            </div>
            <span class="kpiBadge badgeNeu">Rules</span>
          </div>
          <div class="kpiSub">
            Suggested components:
            <div class="kpiList">
              <div class="kpiRow"><span>SPX trend</span><span class="kpiBadge badgeNeu">40%</span></div>
              <div class="kpiRow"><span>Volatility (VIX)</span><span class="kpiBadge badgeNeu">20%</span></div>
              <div class="kpiRow"><span>Breadth</span><span class="kpiBadge badgeNeu">15%</span></div>
              <div class="kpiRow"><span>Credit stress</span><span class="kpiBadge badgeNeu">15%</span></div>
              <div class="kpiRow"><span>Rates stress</span><span class="kpiBadge badgeNeu">10%</span></div>
            </div>
          </div>
        `;

        el("entryKpiBuffett").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">Buffett proxy</div>
              <div class="kpiValue">Optional</div>
            </div>
            <span class="kpiBadge badgeNeu">Proxy</span>
          </div>
          <div class="kpiSub">
            Two simple options to add to backend:
            <div class="kpiList">
              <div class="kpiRow"><span>BRK relative strength vs SPY</span><span class="kpiBadge badgeNeu">trend</span></div>
              <div class="kpiRow"><span>Cash-tilt signal</span><span class="kpiBadge badgeNeu">if available</span></div>
            </div>
          </div>
        `;

        el("entryHint").textContent =
          "Once the backend exposes /market/entry, this box becomes your go or no-go meter for adding risk. Until then, it stays explicit about being unavailable.";
        return;
      }

      const b = entryBadge(payload.score);
      const regime = payload.regime || b.label;
      const signal = payload.signal || (payload.score >= 70 ? "ACCUMULATE" : payload.score >= 55 ? "ACCUMULATE SLOWLY" : "WAIT / SMALL DCA");
      const notes = payload.notes || "";

      el("entryKpiScore").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Market entry index</div>
            <div class="kpiValue">${Math.round(payload.score)}/100</div>
          </div>
          <span class="kpiBadge ${b.cls}">${regime}</span>
        </div>
        <div class="kpiSub">
          Suggested action: <strong>${signal}</strong><br/>
          ${notes ? `<span class="muted">${notes}</span>` : ""}
        </div>
      `;

      const c = payload.components || {};
      function pct01(x){ return `${Math.round(100 * Number(x || 0))}%`; }

      el("entryKpiRules").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Components</div>
            <div class="kpiValue">What drove it</div>
          </div>
          <span class="kpiBadge badgeNeu">${payload.date || ""}</span>
        </div>
        <div class="kpiSub">
          <div class="kpiList">
            <div class="kpiRow"><span>SPX trend</span><span class="kpiBadge badgeNeu">${pct01(c.spxTrend)}</span></div>
            <div class="kpiRow"><span>Volatility</span><span class="kpiBadge badgeNeu">${pct01(c.vix)}</span></div>
            <div class="kpiRow"><span>Breadth</span><span class="kpiBadge badgeNeu">${pct01(c.breadth)}</span></div>
            <div class="kpiRow"><span>Credit</span><span class="kpiBadge badgeNeu">${pct01(c.credit)}</span></div>
            <div class="kpiRow"><span>Rates</span><span class="kpiBadge badgeNeu">${pct01(c.rates)}</span></div>
          </div>
        </div>
      `;

      el("entryKpiBuffett").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Buffett proxy</div>
            <div class="kpiValue">${typeof c.buffettProxy === "number" ? pct01(c.buffettProxy) : "‚Äî"}</div>
          </div>
          <span class="kpiBadge badgeNeu">Proxy</span>
        </div>
        <div class="kpiSub">
          Uses a proxy, not private Buffett cash data. Best option: relative strength (BRK.B vs SPY) plus drawdown filters.
        </div>
      `;

      el("entryHint").textContent =
        "Use this as a pacing tool. High score means increase DCA pace and accept risk. Low score means slow down, stay selective, or wait for better conditions.";
    }

    async function loadEntryIndex(windowDays, force){
      const key = String(windowDays || 365);
      if (CACHE_ENTRY.has(key) && !force){
        renderEntryIndex(CACHE_ENTRY.get(key));
        return;
      }
      try{
        const url = ENTRY_URL(windowDays || 365);
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);
        CACHE_ENTRY.set(key, data);
        renderEntryIndex(data);
      }catch(err){
        renderEntryIndex(null);
      }
    }

    // Holdings overlap (supports /report/congress-holdings response)
    function holdingsBadgeByScore(score){
      const s = Number(score || 0);
      if (s >= 80) return { label: "VERY BROAD", cls: "badgePos" };
      if (s >= 60) return { label: "BROAD", cls: "badgeNeu" };
      if (s >= 40) return { label: "MODERATE", cls: "badgeNeu" };
      return { label: "NICHE", cls: "badgeNeu" };
    }

    function holdingsRowHTML(item){
      const t = String(item.ticker || "").toUpperCase();
      const holders = Number(item.holderCount ?? item.holders ?? 0);
      const dem = Number(item.demHolders ?? 0);
      const rep = Number(item.repHolders ?? 0);
      const score = Number(item.holdingsScore ?? 0);
      const last = String(item.lastActivity || "");
      const b = holdingsBadgeByScore(score);

      const bip = (dem > 0 && rep > 0);
      const bipBadge = bip ? `<span class="kpiBadge badgeBoth">Bipartisan</span>` : `<span class="kpiBadge badgeNeu">Single-party</span>`;

      return `
        <div class="holdingsItem">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${encodeURIComponent(t)}">${t}</a>
                <span class="kpiBadge ${b.cls}">${b.label}</span>
              </div>
              <div class="stockMeta">
                <span class="kpiBadge badgeNeu">Holders: <strong>${holders}</strong></span>
                <span class="kpiBadge badgeNeu">Score: <strong>${score}/100</strong></span>
                ${bipBadge}
                ${last ? `<span class="kpiBadge badgeNeu">Last: ${last}</span>` : ""}
              </div>
            </div>
            <div class="tags">
              <span class="tag tagSEC">OVERLAP</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem holders: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP holders: <strong>${rep}</strong></div>
            </div>
          </div>

          ${tickerLinksHTML(t)}
        </div>
      `;
    }

    function renderHoldingsKpis(payload, list){
      const win = Number(payload?.windowDays || 365);
      const breadth = payload?.breadth || {};
      const uniquePol = Number(breadth.uniquePoliticians || 0);
      const uniqueTickers = Number(breadth.uniqueTickers || 0);

      const items = Array.isArray(list) ? list : [];
      const top = items[0] || null;

      const avgHolders = items.length ? Math.round(items.reduce((s,x)=>s+Number(x.holderCount||0),0) / items.length) : 0;
      const avgScore = items.length ? Math.round(items.reduce((s,x)=>s+Number(x.holdingsScore||0),0) / items.length) : 0;

      el("holdingsKpiTop").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top holding</div>
            <div class="kpiValue">${top ? String(top.ticker).toUpperCase() : "‚Äî"}</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">
          ${top ? `Holders: <strong>${Number(top.holderCount||0)}</strong> ¬∑ Score: <strong>${Number(top.holdingsScore||0)}/100</strong>` : "No overlap data."}
        </div>
        <div class="kpiList">
          <div class="kpiRow"><span class="muted">Avg holders (top list)</span><span class="kpiBadge badgeNeu">${avgHolders}</span></div>
          <div class="kpiRow"><span class="muted">Avg score (top list)</span><span class="kpiBadge badgeNeu">${avgScore}/100</span></div>
        </div>
      `;

      el("holdingsKpiBreadth").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Breadth</div>
            <div class="kpiValue">${uniquePol || 0} members</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">
          Universe is the unique members who disclosed activity in this window.
        </div>
        <div class="kpiList">
          <div class="kpiRow"><span class="muted">Unique tickers</span><span class="kpiBadge badgeNeu">${uniqueTickers || 0}</span></div>
          <div class="kpiRow"><span class="muted">Displayed</span><span class="kpiBadge badgeNeu">${items.length}</span></div>
        </div>
      `;

      el("holdingsKpiRules").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Holdings score</div>
            <div class="kpiValue">0‚Äì100</div>
          </div>
          <span class="kpiBadge badgeNeu">Proxy</span>
        </div>
        <div class="kpiSub">
          <div class="kpiRow"><span>Primary</span><span class="kpiBadge badgeNeu">Breadth</span></div>
          <div class="kpiRow"><span>Input</span><span class="kpiBadge badgeNeu">holderCount / uniquePoliticians</span></div>
          <div class="kpiRow"><span>Boost</span><span class="kpiBadge badgeBoth">Bipartisan</span></div>
          <div class="scoreExplain">
            This is a proxy based on disclosures, not a real-time holdings statement. Use it to find common names, not to time entries.
          </div>
        </div>
      `;
    }

    function renderHoldingsCommon(payload){
      const win = Number(payload?.windowDays || 365);
      el("holdingsWindowBadge").textContent = `${win}D`;

      const list = Array.isArray(payload?.topHoldings) ? payload.topHoldings
        : Array.isArray(payload?.holdings) ? payload.holdings
        : [];

      if (!list.length){
        el("holdingsList").innerHTML = "<div class='subtle'>No holdings overlap data returned.</div>";
        el("holdingsHint").textContent =
          "If this is empty, confirm the backend is deployed with /report/congress-holdings.";
        renderHoldingsKpis(payload || {}, []);
        return;
      }

      const cleaned = list.slice().map(x => ({
        ticker: String(x.ticker || "").toUpperCase(),
        holderCount: Number(x.holderCount ?? x.holders ?? 0),
        demHolders: Number(x.demHolders ?? 0),
        repHolders: Number(x.repHolders ?? 0),
        breadthPct: Number(x.breadthPct ?? 0),
        holdingsScore: Number(x.holdingsScore ?? 0),
        lastActivity: String(x.lastActivity || "")
      })).filter(x => x.ticker && x.holderCount >= 0);

      cleaned.sort((a,b) => (b.holderCount - a.holderCount) || (b.holdingsScore - a.holdingsScore) || a.ticker.localeCompare(b.ticker));

      const trimmed = cleaned.slice(0, 30);
      renderHoldingsKpis(payload || {}, trimmed);

      el("holdingsList").innerHTML = trimmed.map(holdingsRowHTML).join("");
      el("holdingsHint").textContent =
        "Common overlap finds crowding. Combine with the Market Entry Index to pace buying.";
    }

    async function loadHoldingsCommon(windowDays, force){
      const key = String(windowDays || 365);
      const cached = CACHE_HOLDINGS.get(key);
      if (cached && !force){
        renderHoldingsCommon(cached);
        return;
      }

      const url = HOLDINGS_COMMON_URL(windowDays || 365);
      el("holdingsList").innerHTML = "<div class='subtle'>Loading holdings overlap‚Ä¶</div>";
      el("holdingsHint").textContent = `Loading holdings overlap from: ${url}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);
        CACHE_HOLDINGS.set(key, data);
        renderHoldingsCommon(data);
      }catch(err){
        renderHoldingsCommon({ windowDays: windowDays || 365, topHoldings: [], holdings: [] });
        el("holdingsHint").textContent =
          "Holdings overlap could not load. Confirm backend has /report/congress-holdings and it is deployed.";
      }
    }

    // Main loader
    function renderMain(payload){
      const win = Number(payload.windowDays || WINDOW_DAYS || 30);
      el("reportDate").textContent = payload.date ? `${payload.date} ¬∑ window ${win}D` : `window ${win}D`;
      renderStrategy(payload);
      renderCryptoFromMain(payload);
      handleHash();
    }

    async function loadMain(force){
      const key = String(WINDOW_DAYS);
      const cached = CACHE_MAIN.get(key);

      if (cached && !force){
        setStatus("ok", "Using cached congress data ‚úÖ", "");
        if (ACTIVE_TAB === "Main") renderMain(cached);
        if (ACTIVE_TAB === "Crypto") renderCryptoFromMain(cached);
        if (ACTIVE_TAB === "Congress") renderCongressTradeSections(cached);
        return;
      }

      const url = TODAY_URL(WINDOW_DAYS);
      setStatus("", `Loading congress (rolling ${WINDOW_DAYS}D)‚Ä¶`, url);

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        CACHE_MAIN.set(key, data);
        setStatus("ok", "Live congress data loaded ‚úÖ", "");

        if (ACTIVE_TAB === "Main") renderMain(data);
        if (ACTIVE_TAB === "Crypto") renderCryptoFromMain(data);
        if (ACTIVE_TAB === "Congress") renderCongressTradeSections(data);
      }catch(err){
        setStatus("err", "Could not load congress data", String(err));
      }
    }

    // Window toggle
    function setWindow(days){
      WINDOW_DAYS = days;
      el("btn30").classList.toggle("on", WINDOW_DAYS === 30);
      el("btn180").classList.toggle("on", WINDOW_DAYS === 180);
      el("btn365").classList.toggle("on", WINDOW_DAYS === 365);

      if (ACTIVE_TAB === "Congress" || ACTIVE_TAB === "Crypto" || ACTIVE_TAB === "Score"){
        loadMain(false);
      }
    }

    function handleRefresh(){
      if (ACTIVE_TAB === "Congress"){
        CACHE_MAIN.delete(String(WINDOW_DAYS));
        CACHE_HOLDINGS.delete("365");
        loadMain(true);
        loadHoldingsCommon(365, true);
        return;
      }
      if (ACTIVE_TAB === "Main"){
        CACHE_MAIN.delete(String(WINDOW_DAYS));
        CACHE_ENTRY.delete("365");
        loadMain(true);
        loadEntryIndex(365, true);
        return;
      }
      CACHE_MAIN.delete(String(WINDOW_DAYS));
      loadMain(true);
    }

    // Events
    el("searchBtn").addEventListener("click", () => {
      const t = String(el("searchInput").value || "").trim().toUpperCase();
      if (!t) return;
      window.location.hash = "#stock=" + encodeURIComponent(t);
      showTab("Search");
      handleHash();
    });

    el("scoreGoBtn").addEventListener("click", () => runScoreFromUI());

    el("btn30").addEventListener("click", () => setWindow(30));
    el("btn180").addEventListener("click", () => setWindow(180));
    el("btn365").addEventListener("click", () => setWindow(365));

    el("tabMainBtn").addEventListener("click", () => showTab("Main"));
    el("tabCongressBtn").addEventListener("click", () => showTab("Congress"));
    el("tabCryptoBtn").addEventListener("click", () => showTab("Crypto"));
    el("tabScoreBtn").addEventListener("click", () => showTab("Score"));
    el("tabSearchBtn").addEventListener("click", () => showTab("Search"));

    el("navMain").addEventListener("click", () => showTab("Main"));
    el("navCongress").addEventListener("click", () => showTab("Congress"));
    el("navCrypto").addEventListener("click", () => showTab("Crypto"));
    el("navScore").addEventListener("click", () => showTab("Score"));
    el("navSearch").addEventListener("click", () => showTab("Search"));

    el("refreshBtn").addEventListener("click", handleRefresh);
    window.addEventListener("hashchange", handleHash);

    // Start
    showTab("Main");
    loadMain(false);
    loadEntryIndex(365, false);
  </script>
</body>
</html>

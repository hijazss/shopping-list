<script>
  const BACKEND_URL = "https://finance-backend-1-bbi9.onrender.com/report/today";

  const el = (id) => document.getElementById(id);

  function cardHTML(x){
    const funds = x.funds && x.funds.length
      ? `Funds: ${x.funds.slice(0,2).join(", ")}${x.funds.length>2 ? " +" + (x.funds.length-2) : ""}`
      : "";

    return `
      <div class="card">
        <div class="row">
          <div class="title">${x.ticker} · ${x.companyName || ""}</div>
          <div class="badge">${x.strength || ""}</div>
        </div>
        <div class="meta">D buyers: ${x.demBuyers || 0} | R buyers: ${x.repBuyers || 0}</div>
        ${funds ? `<div class="meta">${funds}</div>` : ""}
        ${x.lastFiledAt ? `<div class="meta">Last filed: ${x.lastFiledAt}</div>` : ""}
      </div>
    `;
  }

  function fundRowHTML(r){
    return `
      <div class="card">
        <div class="row">
          <div class="title">${r.ticker} · ${r.companyName || ""}</div>
          <div class="badge">${(r.signal && r.signal.signalType) || ""}</div>
        </div>
        <div class="meta">${(r.signal && r.signal.fundName) || ""} · Filed ${(r.signal && r.signal.filedAt) || ""}</div>
        ${(r.signal && r.signal.ownershipChange) ? `<div class="meta">${r.signal.ownershipChange}</div>` : ""}
      </div>
    `;
  }

  function render(data){
    el("reportDate").textContent = data.date || "";

    el("convergenceList").innerHTML =
      (data.convergence || []).map(cardHTML).join("") ||
      "<div class='meta'>No convergence items today.</div>";

    el("bipartisanList").innerHTML =
      (data.bipartisanTickers || []).map(cardHTML).join("") ||
      "<div class='meta'>No bipartisan buys found.</div>";

    el("fundList").innerHTML =
      (data.fundSignals || []).map(fundRowHTML).join("") ||
      "<div class='meta'>No fund signals yet.</div>";
  }

  async function load(){
    el("convergenceList").innerHTML = "<div class='meta'>Loading live data…</div>";
    el("bipartisanList").innerHTML = "";
    el("fundList").innerHTML = "";

    try {
      const res = await fetch(BACKEND_URL, { cache: "no-store" });
      const data = await res.json();

      if (!res.ok || data.error) {
        const msg = data.error ? data.error : ("HTTP " + res.status);
        throw new Error(msg);
      }

      render(data);
    } catch (err) {
      el("convergenceList").innerHTML =
        "<div class='meta'>Could not load live data.</div>" +
        "<div class='meta'>Error: " + String(err) + "</div>";
    }
  }

  el("refreshBtn").addEventListener("click", load);
  load();
</script>

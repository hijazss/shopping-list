<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);

      --dem:#4aa3ff;
      --rep:#ff5a5a;
      --both:#b38bff;

      --ok:#7cffc0;
      --err:#ff8a8a;

      --pos:#7cffc0;
      --neg:#ff8a8a;

      --sec:#ffd27d;
      --chip:#ffffff0a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:12px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      padding:14px 14px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      max-width:980px;
      margin:0 auto;
    }
    .h1{font-size:17px;font-weight:900;letter-spacing:.01em}
    .subtle{font-size:12px;color:var(--muted);margin-top:2px}
    .pillBtn{
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:#fff;
      font-size:12px;
    }

    .container{
      max-width:980px;
      margin:0 auto;
      padding:8px 14px 110px;
    }

    .status{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px 10px;
      margin:6px 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .status strong{color:#fff}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .tabRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 10px;
    }
    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:7px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .tabBtnActive{
      color:#fff;
      background:rgba(255,255,255,.08);
    }

    .chipRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 10px;
      align-items:center;
    }
    .chip{
      border:1px solid var(--border);
      background:var(--chip);
      padding:6px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .chipActive{
      color:#fff;
      background:#ffffff14;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 760px){
      .grid2{grid-template-columns:1fr 1fr;}
    }

    .grid4{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .grid4{grid-template-columns:repeat(4,1fr);}
    }
    @media (min-width: 760px) and (max-width: 859px){
      .grid4{grid-template-columns:repeat(2,1fr);}
    }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .kpiTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:6px;
    }
    .kpiTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .kpiValue{
      font-size:17px;
      font-weight:900;
      letter-spacing:.02em;
      margin-top:4px;
    }
    .kpiSub{
      font-size:12px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
    }
    .kpiList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:rgba(255,255,255,.90);
    }
    .kpiBadge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      color:rgba(255,255,255,.90);
    }
    .badgePos{border-color:rgba(124,255,192,.45); color:var(--pos)}
    .badgeNeg{border-color:rgba(255,138,138,.45); color:var(--neg)}
    .badgeNeu{border-color:rgba(255,255,255,.18); color:rgba(255,255,255,.85)}
    .badgeSEC{border-color:rgba(255,210,125,.40); color:var(--sec)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px 9px;
      margin-bottom:8px;
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-size:13px;
      font-weight:900;
      letter-spacing:.03em;
    }
    .who{
      font-size:12px;
      color:var(--muted);
      max-width:560px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tagDem{border-color:rgba(74,163,255,.5); color:var(--dem)}
    .tagRep{border-color:rgba(255,90,90,.5); color:var(--rep)}
    .tagBoth{border-color:rgba(179,139,255,.55); color:var(--both)}
    .tagBuy{border-color:rgba(124,255,192,.45); color:var(--ok)}
    .tagSell{border-color:rgba(255,138,138,.45); color:var(--err)}
    .tagSEC{border-color:rgba(255,210,125,.40); color:var(--sec)}

    .metaRow{
      margin-top:7px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      line-height:1.25;
    }
    .counts{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .countItem{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dotDem{background:var(--dem)}
    .dotRep{background:var(--rep)}

    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0 7px}

    .miniLinks{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .miniLink{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      margin:10px 0 10px;
    }
    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .panelTitle h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.9);
    }
    iframe{
      width:100%;
      height:360px;
      border:0;
      border-radius:12px;
      background:#000;
      margin-top:8px;
    }

    .colsHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:2px 0 8px;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.05em;
      text-transform:uppercase;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin:6px 0 0;
    }

    .tabsBottom{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#151522f0;
      border-top:1px solid var(--border);
      backdrop-filter:blur(12px);
    }
    .tabBarBottom{
      max-width:980px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(5,1fr);
    }
    .tabBottom{
      text-align:center;
      padding:11px 8px 16px;
      font-size:11px;
      color:var(--muted);
      user-select:none;
    }
    .tabBottomActive{color:#fff}

    .eventRow{
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:8px;
      margin-top:8px;
    }
    .eventTitle{
      font-weight:900;
      font-size:12px;
      letter-spacing:.02em;
    }
    .eventMeta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="h1" id="pageTitle">Convergence</div>
      <div class="subtle" id="reportDate"></div>
    </div>
    <button class="pillBtn" id="refreshBtn">Refresh</button>
  </header>

  <main class="container">
    <div class="status" id="statusBox">
      <strong>Status:</strong> <span id="statusText">Loading‚Ä¶</span><br/>
      <span class="mono" id="statusDetail"></span>
    </div>

    <!-- Top tabs -->
    <div class="tabRow">
      <button class="tabBtn tabBtnActive" id="tabMainBtn">Main</button>
      <button class="tabBtn" id="tabPerfBtn">Performance (2Y)</button>
      <button class="tabBtn" id="tabLeadersBtn">Leaders</button>
      <button class="tabBtn" id="tabCryptoBtn">Crypto</button>
      <button class="tabBtn" id="tabSearchBtn">Search</button>
    </div>

    <!-- Main window toggle -->
    <div class="chipRow" id="windowChips">
      <div class="chip chipActive" id="chip30">Rolling 30D</div>
      <div class="chip" id="chip180">Rolling 180D</div>
      <div class="chip badgeNeu" id="chipMeta"></div>
    </div>

    <div id="stockPanel" style="display:none;"></div>

    <!-- KPI STRIP -->
    <section id="kpiStrip">
      <div class="sectionTitle" id="kpiTitle">Signal dashboard (top 4)</div>
      <div class="grid4">
        <div class="kpi" id="kpiAccum"></div>
        <div class="kpi" id="kpiSell"></div>
        <div class="kpi" id="kpiTop"></div>
        <div class="kpi" id="kpiHighlights"></div>
      </div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain">
      <div class="sectionTitle" id="convTitle">Convergence üî• (bipartisan overlap on BUY)</div>
      <div id="convergenceList"></div>

      <div class="sectionTitle" id="partTitle">Politicians ranked by participation</div>
      <div class="colsHeader">
        <div>Buys (left)</div>
        <div>Sells (right)</div>
      </div>

      <div class="grid2">
        <div><div id="buyList"></div></div>
        <div><div id="sellList"></div></div>
      </div>

      <div class="hint" id="mainHint"></div>
    </section>

    <!-- PERFORMANCE VIEW -->
    <section id="viewPerf" style="display:none;">
      <div class="sectionTitle">Top 2-year performers</div>

      <div class="chipRow">
        <div class="chip chipActive" id="hChip30">Horizon 30D</div>
        <div class="chip" id="hChip90">Horizon 90D</div>
        <div class="chip" id="hChip180">Horizon 180D</div>
      </div>

      <div id="perfList"></div>
      <div class="hint">This uses your backend endpoint <span class="mono">/report/performance-2y</span>. It‚Äôs a simple equal-weight score.</div>
    </section>

    <!-- LEADERS VIEW -->
    <section id="viewLeaders" style="display:none;">
      <div class="sectionTitle">SEC leaders (rolling 365D)</div>
      <div id="leadersList"></div>
      <div class="hint">Form 4 includes tickers and buy/sell transactions. 13F shows holdings and deltas vs prior 13F when possible.</div>
    </section>

    <!-- CRYPTO VIEW -->
    <section id="viewCrypto" style="display:none;">
      <div class="sectionTitle">Congress crypto activity</div>
      <div class="chipRow">
        <div class="chip chipActive" id="cChip30">30D</div>
        <div class="chip" id="cChip180">180D</div>
        <div class="chip" id="cChip365">365D</div>
      </div>

      <div class="sectionTitle">Direct crypto mentions (from disclosures)</div>
      <div id="cryptoDirectList"></div>

      <div class="sectionTitle">Crypto-linked tickers (ETFs, trusts, COIN/MSTR)</div>
      <div id="cryptoLinkedList"></div>

      <div class="hint">If ‚ÄúDirect crypto‚Äù is empty, it means your underlying dataset is not providing coin-level entries consistently.</div>
    </section>

    <!-- SEARCH VIEW -->
    <section id="viewSearch" style="display:none;">
      <div class="sectionTitle">Search ticker</div>
      <div class="panel">
        <div class="metaRow" style="margin-top:0;">
          <div style="color:rgba(255,255,255,.9)">Type a ticker (example: NVDA)</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input id="searchInput" placeholder="Ticker" autocapitalize="characters"
                 style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#fff; font-size:13px;" />
          <button class="pillBtn" id="searchBtn">Go</button>
        </div>
        <div class="hint" style="margin-top:10px;">Opens the chart panel for quick trend context.</div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="tabsBottom">
    <div class="tabBarBottom">
      <div class="tabBottom tabBottomActive" id="navMain">Main</div>
      <div class="tabBottom" id="navPerf">Perf</div>
      <div class="tabBottom" id="navLeaders">Leaders</div>
      <div class="tabBottom" id="navCrypto">Crypto</div>
      <div class="tabBottom" id="navSearch">Search</div>
    </div>
  </nav>

  <script>
    const BASE = "https://finance-backend-dzta.onrender.com";
    const LEADERS_URL = BASE + "/report/public-leaders";

    const el = (id) => document.getElementById(id);

    let ACTIVE_TAB = "Main";
    let MAIN_WINDOW_DAYS = 30;   // 30 or 180 in Main
    let PERF_HORIZON_DAYS = 30;  // 30/90/180 in Performance
    let CRYPTO_WINDOW_DAYS = 30; // 30/180/365 in Crypto

    let CACHE_MAIN = new Map();  // key windowDays => payload
    let CACHE_LEADERS = null;
    let CACHE_PERF = new Map();  // key horizonDays => payload

    function setTitleForTab(tab){
      const map = {
        "Main": "Convergence",
        "Performance": "Performance (2Y)",
        "Leaders": "Leaders",
        "Crypto": "Crypto",
        "Search": "Search"
      };
      el("pageTitle").textContent = map[tab] || "Convergence";
    }

    function setStatus(kind, text, detail){
      const st = el("statusText");
      const sd = el("statusDetail");
      st.textContent = text || "";
      st.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
      sd.textContent = detail || "";
    }

    function normalizeList(arr){ return Array.isArray(arr) ? arr.slice() : []; }

    function congressScore(x){
      return (
        Number(x.demBuyers || 0) +
        Number(x.repBuyers || 0) +
        Number(x.demSellers || 0) +
        Number(x.repSellers || 0)
      );
    }

    function bipartisanScore(x){
      const dem = Number(x.demBuyers || 0) + Number(x.demSellers || 0);
      const rep = Number(x.repBuyers || 0) + Number(x.repSellers || 0);
      return Math.min(dem, rep);
    }

    function sortByCongressStrength(a, b){
      const totalA = congressScore(a);
      const totalB = congressScore(b);
      if (totalA !== totalB) return totalB - totalA;
      const biA = bipartisanScore(a);
      const biB = bipartisanScore(b);
      if (biA !== biB) return biB - biA;
      return String(a.ticker || "").localeCompare(String(b.ticker || ""), undefined, {sensitivity:"base"});
    }

    function netFlow(x){
      const buys = Number(x.demBuyers || 0) + Number(x.repBuyers || 0);
      const sells = Number(x.demSellers || 0) + Number(x.repSellers || 0);
      return buys - sells;
    }

    function confidenceLabel(x){
      const t = congressScore(x);
      if (t >= 6) return "STRONG";
      if (t >= 3) return "MOD";
      return "WEAK";
    }

    function confidenceBadgeClass(lbl){
      if (lbl === "STRONG") return "badgePos";
      if (lbl === "MOD") return "badgeNeu";
      return "badgeNeu";
    }

    function tickerLinksHTML(ticker){
      const t = String(ticker || "").toUpperCase();
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tvChart = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent("NASDAQ:" + t)}`;
      return `
        <div class="miniLinks">
          <a class="miniLink" href="#stock=${t}">Chart</a>
          <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Yahoo</a>
          <a class="miniLink" href="${tvChart}" target="_blank" rel="noopener">TV</a>
        </div>
      `;
    }

    function cardHTML(x, mode){
      const ticker = String(x.ticker || "").toUpperCase();
      const who = String(x.companyName || "").trim();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";
      const traded = x.traded ? String(x.traded) : "";
      const chamber = x.chamber ? String(x.chamber) : "";
      const amt = x.amountRange ? String(x.amountRange) : "";

      const dem = mode === "BUY" ? Number(x.demBuyers || 0) : Number(x.demSellers || 0);
      const rep = mode === "BUY" ? Number(x.repBuyers || 0) : Number(x.repSellers || 0);

      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                ${who ? `<div class="who">${who}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${mode === "BUY" ? `<span class="tag tagBuy">BUY</span>` : `<span class="tag tagSell">SELL</span>`}
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${chamber ? chamber : ""}${amt ? (chamber ? " ¬∑ " : "") + amt : ""}</div>
          </div>

          <div class="metaRow">
            <div>${traded ? `Traded: ${traded}` : ""}</div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function overlapCardHTML(x){
      const ticker = String(x.ticker || "").toUpperCase();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";
      const dem = Number(x.demBuyers || 0);
      const rep = Number(x.repBuyers || 0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                <div class="who">Bipartisan overlap (BUY)</div>
              </div>
            </div>
            <div class="tags">
              <span class="tag tagDem">DEM</span>
              <span class="tag tagRep">GOP</span>
              <span class="tag tagBoth">OVERLAP</span>
              <span class="tag tagBuy">BUY</span>
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Last: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function setStockPanel(ticker){
      const t = String(ticker || "").toUpperCase();
      if (!t){
        el("stockPanel").style.display = "none";
        el("stockPanel").innerHTML = "";
        return;
      }

      const symbol = "NASDAQ:" + t;
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tv = `https://www.tradingview.com/symbols/${encodeURIComponent(symbol)}/`;

      el("stockPanel").style.display = "";
      el("stockPanel").innerHTML = `
        <div class="panel">
          <div class="panelTitle">
            <h2>${t} chart</h2>
            <button class="closeBtn" id="closeStockBtn">Close</button>
          </div>
          <iframe
            title="TradingView Chart"
            src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=D&theme=dark&style=1&withdateranges=1&hideideas=1"
            loading="lazy">
          </iframe>
          <div class="miniLinks">
            <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Open Yahoo</a>
            <a class="miniLink" href="${tv}" target="_blank" rel="noopener">Open TradingView</a>
          </div>
        </div>
      `;

      const btn = document.getElementById("closeStockBtn");
      if (btn) btn.addEventListener("click", () => {
        history.pushState("", document.title, window.location.pathname + window.location.search);
        setStockPanel("");
      });
    }

    function handleHash(){
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim();
        setStockPanel(t);
        return;
      }
      setStockPanel("");
    }

    function topBy(arr, scoreFn, n){
      const a = normalizeList(arr).slice();
      a.sort((x,y) => (scoreFn(y) - scoreFn(x)) || String(x.ticker||"").localeCompare(String(y.ticker||""), undefined, {sensitivity:"base"}));
      return a.slice(0, n);
    }

    function renderKpis(convergence, buys, sells, windowDays){
      const merged = new Map();
      function addCard(x){
        const t = String(x.ticker || "").toUpperCase();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0 };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        merged.set(t, cur);
      }
      buys.forEach(addCard);
      sells.forEach(addCard);

      const mergedArr = Array.from(merged.values());
      const w = windowDays || 30;

      el("kpiTitle").textContent = `Signal dashboard (top 4, rolling ${w} days)`;
      el("convTitle").textContent = `Convergence üî• (bipartisan overlap on BUY, rolling ${w} days)`;
      el("partTitle").textContent = `Politicians ranked by participation (rolling ${w} days)`;
      el("mainHint").textContent = `Sorted by total participation within rolling ${w} days. Convergence is overlap on BUY by both parties.`;

      const topNet = topBy(mergedArr, (x) => netFlow(x), 5).map(x => {
        const nf = netFlow(x);
        const badge = nf > 0 ? "badgePos" : nf < 0 ? "badgeNeg" : "badgeNeu";
        const sign = nf > 0 ? "+" : "";
        return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${badge}">${sign}${nf}</span></div>`;
      }).join("");

      el("kpiAccum").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Net flow</div>
            <div class="kpiValue">Buys ‚àí Sells</div>
          </div>
          <span class="kpiBadge badgeNeu">${w}D</span>
        </div>
        <div class="kpiSub">Highest accumulation or distribution in rolling ${w}D.</div>
        <div class="kpiList">${topNet || `<div class="kpiRow"><span style="color:var(--muted)">No data</span></div>`}</div>
      `;

      const topPart = topBy(mergedArr, (x) => congressScore(x), 5).map(x => {
        const total = congressScore(x);
        return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge badgeNeu">${total} trades</span></div>`;
      }).join("");

      el("kpiSell").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Participation</div>
            <div class="kpiValue">Total activity</div>
          </div>
          <span class="kpiBadge badgeNeu">${w}D</span>
        </div>
        <div class="kpiSub">Most active tickers by total trades in rolling ${w}D.</div>
        <div class="kpiList">${topPart || `<div class="kpiRow"><span style="color:var(--muted)">No data</span></div>`}</div>
      `;

      const topConv = normalizeList(convergence).slice(0, 5).map(x => {
        const total = Number(x.demBuyers||0) + Number(x.repBuyers||0);
        return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge badgeNeu">overlap ${total}</span></div>`;
      }).join("");

      el("kpiTop").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Convergence</div>
            <div class="kpiValue">Overlap</div>
          </div>
          <span class="kpiBadge badgeNeu">${w}D</span>
        </div>
        <div class="kpiSub">Tickers bought by both parties.</div>
        <div class="kpiList">${topConv || `<div class="kpiRow"><span style="color:var(--muted)">None</span></div>`}</div>
      `;

      const topAcc = topBy(mergedArr, (x) => netFlow(x), 1)[0];
      const topDist = topBy(mergedArr, (x) => -netFlow(x), 1)[0];
      const topOverlap = normalizeList(convergence)[0];

      el("kpiHighlights").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top signals</div>
            <div class="kpiValue">Fast read</div>
          </div>
          <span class="kpiBadge badgeNeu">${w}D</span>
        </div>
        <div class="kpiSub">Quick anchors.</div>
        <div class="kpiList">
          <div class="kpiRow"><span style="color:var(--muted)">üî• Accum</span><span>${topAcc ? `<a href="#stock=${topAcc.ticker}"><strong>${topAcc.ticker}</strong></a>` : `<span style="color:var(--muted)">‚Äî</span>`}</span></div>
          <div class="kpiRow"><span style="color:var(--muted)">‚ö†Ô∏è Sell</span><span>${topDist ? `<a href="#stock=${topDist.ticker}"><strong>${topDist.ticker}</strong></a>` : `<span style="color:var(--muted)">‚Äî</span>`}</span></div>
          <div class="kpiRow"><span style="color:var(--muted)">ü§ù Overlap</span><span>${topOverlap ? `<a href="#stock=${topOverlap.ticker}"><strong>${topOverlap.ticker}</strong></a>` : `<span style="color:var(--muted)">‚Äî</span>`}</span></div>
        </div>
      `;
    }

    function showTab(tab){
      ACTIVE_TAB = tab;
      setTitleForTab(tab);

      el("viewMain").style.display = tab === "Main" ? "" : "none";
      el("viewPerf").style.display = tab === "Performance" ? "" : "none";
      el("viewLeaders").style.display = tab === "Leaders" ? "" : "none";
      el("viewCrypto").style.display = tab === "Crypto" ? "" : "none";
      el("viewSearch").style.display = tab === "Search" ? "" : "none";

      el("kpiStrip").style.display = (tab === "Main") ? "" : "none";
      el("windowChips").style.display = (tab === "Main") ? "" : "none";

      el("tabMainBtn").classList.toggle("tabBtnActive", tab === "Main");
      el("tabPerfBtn").classList.toggle("tabBtnActive", tab === "Performance");
      el("tabLeadersBtn").classList.toggle("tabBtnActive", tab === "Leaders");
      el("tabCryptoBtn").classList.toggle("tabBtnActive", tab === "Crypto");
      el("tabSearchBtn").classList.toggle("tabBtnActive", tab === "Search");

      el("navMain").classList.toggle("tabBottomActive", tab === "Main");
      el("navPerf").classList.toggle("tabBottomActive", tab === "Performance");
      el("navLeaders").classList.toggle("tabBottomActive", tab === "Leaders");
      el("navCrypto").classList.toggle("tabBottomActive", tab === "Crypto");
      el("navSearch").classList.toggle("tabBottomActive", tab === "Search");

      if (tab === "Main") loadMain(false);
      if (tab === "Performance") loadPerf(false);
      if (tab === "Leaders") loadLeaders(false);
      if (tab === "Crypto") loadCrypto(false);
    }

    function renderMain(data){
      el("reportDate").textContent = data.date || "";

      const convergence = normalizeList(data.convergence).sort(sortByCongressStrength);
      const buys = normalizeList(data.politicianBuys).sort(sortByCongressStrength);
      const sells = normalizeList(data.politicianSells).sort(sortByCongressStrength);

      el("chipMeta").textContent = `Window: ${data.windowStart || ""} ‚Üí ${data.windowEnd || ""}`;

      renderKpis(convergence, buys, sells, data.windowDays || MAIN_WINDOW_DAYS);

      el("convergenceList").innerHTML =
        convergence.length ? convergence.slice(0, 25).map(overlapCardHTML).join("") : "<div class='subtle'>No overlap tickers in this window.</div>";

      el("buyList").innerHTML =
        buys.length ? buys.slice(0, 120).map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No buy trades found.</div>";

      el("sellList").innerHTML =
        sells.length ? sells.slice(0, 120).map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No sell trades found.</div>";

      handleHash();
    }

    function renderPerf(payload){
      el("reportDate").textContent = payload.date || "";
      const leaders = normalizeList(payload.leaders);

      if (!leaders.length){
        el("perfList").innerHTML = "<div class='subtle'>No performance rows returned.</div>";
        return;
      }

      const html = leaders.slice(0, 30).map((p, idx) => {
        const name = String(p.name || "");
        const party = String(p.party || "");
        const chamber = String(p.chamber || "");
        const cnt = Number(p.tradeCount || 0);
        const avg = Number(p.avgReturnPct || 0);

        const badge = avg >= 0 ? "badgePos" : "badgeNeg";
        const sign = avg >= 0 ? "+" : "";

        const sample = normalizeList(p.sample).map(s => {
          return `<div class="eventRow">
            <div class="eventTitle">${s.ticker} ¬∑ ${s.kind} ¬∑ ${sign}${s.score}%</div>
            <div class="eventMeta">Traded: ${s.traded || "‚Äî"} ¬∑ Filed: ${s.filed || "‚Äî"} ¬∑ Horizon: ${s.horizonDays}D</div>
          </div>`;
        }).join("");

        return `
          <div class="card">
            <div class="cardTop">
              <div>
                <div class="tickerLine">
                  <div class="ticker">#${idx+1} ${name}</div>
                  <div class="who">${chamber || ""}${party ? (chamber ? " ¬∑ " : "") + party : ""}</div>
                </div>
              </div>
              <div class="tags">
                <span class="tag ${badge}">${sign}${avg}%</span>
                <span class="tag badgeNeu">${cnt} trades</span>
              </div>
            </div>
            <div class="divider"></div>
            ${sample || `<div class="subtle">No sample trades available.</div>`}
          </div>
        `;
      }).join("");

      el("perfList").innerHTML = html;
    }

    function labelBadge(label){
      const s = String(label || "").toUpperCase();
      if (s === "BUY") return `<span class="tag tagBuy">BUY</span>`;
      if (s === "SELL") return `<span class="tag tagSell">SELL</span>`;
      if (s === "MIXED") return `<span class="tag tagBoth">MIXED</span>`;
      if (s.includes("13F")) return `<span class="tag tagSEC">13F</span>`;
      return `<span class="tag tagSEC">${s || "FILED"}</span>`;
    }

    function renderLeaders(payload){
      el("reportDate").textContent = payload.date || "";
      const leaders = normalizeList(payload.leaders);

      if (!leaders.length){
        el("leadersList").innerHTML = "<div class='subtle'>No leaders data returned.</div>";
        return;
      }

      const html = leaders.map(l => {
        const name = String(l.name || "");
        const cik = String(l.cik || "");
        const events = normalizeList(l.events);

        const evHtml = events.map(ev => {
          const form = String(ev.form || "");
          const label = String(ev.label || "");
          const filingDate = String(ev.filingDate || "");
          const indexUrl = String(ev.indexUrl || "");
          const primaryUrl = String(ev.primaryUrl || "");
          const details = ev.details || {};
          const txs = normalizeList(details.transactions);

          let txBlock = "";
          if (txs.length){
            const rows = txs.slice(0, 8).map(t => {
              const code = t.code === "P" ? "BUY" : t.code === "S" ? "SELL" : t.code;
              const tick = (t.ticker || "").toUpperCase();
              return `<div class="eventRow">
                <div class="eventTitle">${tick || "‚Äî"} ¬∑ ${code}</div>
                <div class="eventMeta">${t.issuerName || ""}${t.transactionDate ? " ¬∑ Date: " + t.transactionDate : ""}${t.shares ? " ¬∑ Shares: " + t.shares : ""}${t.price ? " ¬∑ Price: " + t.price : ""}</div>
              </div>`;
            }).join("");
            txBlock = `<div class="eventMeta" style="margin-top:8px;">Transactions (Form 4):</div>${rows}`;
          }

          let holdingsBlock = "";
          if (details.topHoldings && details.topHoldings.length){
            const h = details.topHoldings.slice(0, 8).map(h => {
              return `<div class="eventRow">
                <div class="eventTitle">${h.nameOfIssuer || "Holding"} ¬∑ CUSIP ${h.cusip || "‚Äî"}</div>
                <div class="eventMeta">Value: ${h.value || "‚Äî"} ¬∑ Shares: ${h.sshPrnamt || "‚Äî"}</div>
              </div>`;
            }).join("");
            holdingsBlock = `<div class="eventMeta" style="margin-top:8px;">Top holdings (13F):</div>${h}`;
          }

          let deltasBlock = "";
          if (details.topDeltas && details.topDeltas.length){
            const d = details.topDeltas.slice(0, 8).map(d => {
              const dv = Number(d.deltaValue || 0);
              const badge = dv >= 0 ? "badgePos" : "badgeNeg";
              const sign = dv >= 0 ? "+" : "";
              return `<div class="eventRow">
                <div class="eventTitle">${d.nameOfIssuer || "Issuer"} ¬∑ CUSIP ${d.cusip || "‚Äî"}</div>
                <div class="eventMeta">Delta value: <span class="mono ${badge}">${sign}${dv}</span> (Now ${d.valueNow} vs Prev ${d.valuePrev})</div>
              </div>`;
            }).join("");
            deltasBlock = `<div class="eventMeta" style="margin-top:8px;">Largest deltas vs prior 13F:</div>${d}`;
          }

          return `
            <div class="eventRow">
              <div class="eventTitle">${form} ¬∑ ${label || "FILED"}</div>
              <div class="eventMeta">Filed: ${filingDate || "‚Äî"}</div>
              <div class="tags" style="margin-top:8px;">
                ${labelBadge(label)}
                ${form ? `<span class="tag badgeSEC">${form}</span>` : ""}
              </div>
              <div class="miniLinks" style="margin-top:8px;">
                ${indexUrl ? `<a class="miniLink" href="${indexUrl}" target="_blank" rel="noopener">SEC Index</a>` : ""}
                ${primaryUrl ? `<a class="miniLink" href="${primaryUrl}" target="_blank" rel="noopener">Primary doc</a>` : ""}
              </div>
              ${txBlock}
              ${holdingsBlock}
              ${deltasBlock}
            </div>
          `;
        }).join("");

        return `
          <div class="card">
            <div class="cardTop">
              <div>
                <div class="tickerLine">
                  <div class="ticker">${name}</div>
                  <div class="who">CIK: <span class="mono">${cik}</span> ¬∑ Rolling 365D</div>
                </div>
              </div>
              <div class="tags">
                <span class="tag tagSEC">SEC</span>
              </div>
            </div>
            <div class="divider"></div>
            ${evHtml || `<div class="subtle">No recent filings.</div>`}
          </div>
        `;
      }).join("");

      el("leadersList").innerHTML = html;
    }

    function renderCrypto(payload){
      el("reportDate").textContent = payload.date || "";

      const direct = normalizeList(payload.cryptoDirect);
      const linked = normalizeList(payload.cryptoLinked);

      function cryptoRow(x){
        const kind = String(x.kind || "");
        const badge = kind === "BUY" ? "tagBuy" : "tagSell";
        const party = String(x.party || "");
        const ptag = party === "D" ? "tagDem" : party === "R" ? "tagRep" : "tag";
        return `
          <div class="card">
            <div class="cardTop">
              <div>
                <div class="tickerLine">
                  <div class="ticker">${String(x.crypto || "CRYPTO")}</div>
                  <div class="who">${String(x.politician || "")}</div>
                </div>
              </div>
              <div class="tags">
                <span class="tag ${ptag}">${party || "‚Äî"}</span>
                <span class="tag ${badge}">${kind || "‚Äî"}</span>
              </div>
            </div>
            <div class="divider"></div>
            <div class="metaRow">
              <div>${x.amountRange ? `Amount: ${x.amountRange}` : ""}</div>
              <div>${x.chamber ? x.chamber : ""}</div>
            </div>
            <div class="metaRow">
              <div>${x.traded ? `Traded: ${x.traded}` : ""}</div>
              <div>${x.filed ? `Filed: ${x.filed}` : ""}</div>
            </div>
            <div class="metaRow">
              <div>${x.description ? x.description : ""}</div>
            </div>
          </div>
        `;
      }

      function linkedRow(x){
        // these are congress stock-style cards
        const kind = x.strength === "SELL" ? "SELL" : "BUY";
        return cardHTML(x, kind);
      }

      el("cryptoDirectList").innerHTML = direct.length ? direct.slice(0, 120).map(cryptoRow).join("") : "<div class='subtle'>No direct crypto disclosures in this window.</div>";
      el("cryptoLinkedList").innerHTML = linked.length ? linked.slice(0, 80).map(linkedRow).join("") : "<div class='subtle'>No crypto-linked tickers in this window.</div>";
    }

    async function loadMain(force){
      const key = MAIN_WINDOW_DAYS;
      if (!force && CACHE_MAIN.has(key) && ACTIVE_TAB === "Main"){
        renderMain(CACHE_MAIN.get(key));
        return;
      }
      const url = BASE + `/report/today?window_days=${encodeURIComponent(MAIN_WINDOW_DAYS)}`;
      setStatus("", `Loading congress (rolling ${MAIN_WINDOW_DAYS}D)‚Ä¶`, url);

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        CACHE_MAIN.set(key, data);
        setStatus("ok", "Live congress data loaded ‚úÖ", "");
        if (ACTIVE_TAB === "Main") renderMain(data);
      }catch(err){
        setStatus("err", "Could not load congress data", String(err));
        if (ACTIVE_TAB === "Main") el("convergenceList").innerHTML = "<div class='subtle'>No data displayed.</div>";
      }
    }

    async function loadPerf(force){
      const key = PERF_HORIZON_DAYS;
      if (!force && CACHE_PERF.has(key) && ACTIVE_TAB === "Performance"){
        renderPerf(CACHE_PERF.get(key));
        return;
      }
      const url = BASE + `/report/performance-2y?horizon_days=${encodeURIComponent(PERF_HORIZON_DAYS)}`;
      setStatus("", `Loading performance (2Y, horizon ${PERF_HORIZON_DAYS}D)‚Ä¶`, url);
      el("perfList").innerHTML = "<div class='subtle'>Loading performance‚Ä¶</div>";

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        CACHE_PERF.set(key, data);
        setStatus("ok", "Performance loaded ‚úÖ", "");
        if (ACTIVE_TAB === "Performance") renderPerf(data);
      }catch(err){
        setStatus("err", "Could not load performance", String(err));
        if (ACTIVE_TAB === "Performance") el("perfList").innerHTML = "<div class='subtle'>No performance data displayed.</div>";
      }
    }

    async function loadLeaders(force){
      if (!force && CACHE_LEADERS && ACTIVE_TAB === "Leaders"){
        renderLeaders(CACHE_LEADERS);
        return;
      }
      setStatus("", "Loading SEC leaders (rolling 365D)‚Ä¶", LEADERS_URL);
      el("leadersList").innerHTML = "<div class='subtle'>Loading SEC filings‚Ä¶</div>";

      try{
        const res = await fetch(LEADERS_URL, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        CACHE_LEADERS = data;
        setStatus("ok", "SEC leaders loaded ‚úÖ", "");
        if (ACTIVE_TAB === "Leaders") renderLeaders(data);
      }catch(err){
        setStatus("err", "Could not load SEC leaders", String(err));
        if (ACTIVE_TAB === "Leaders") el("leadersList").innerHTML = "<div class='subtle'>No SEC leaders data displayed.</div>";
      }
    }

    async function loadCrypto(force){
      const url = BASE + `/report/today?window_days=${encodeURIComponent(CRYPTO_WINDOW_DAYS)}`;
      setStatus("", `Loading crypto (rolling ${CRYPTO_WINDOW_DAYS}D)‚Ä¶`, url);
      el("cryptoDirectList").innerHTML = "<div class='subtle'>Loading‚Ä¶</div>";
      el("cryptoLinkedList").innerHTML = "";

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        setStatus("ok", "Crypto loaded ‚úÖ", "");
        if (ACTIVE_TAB === "Crypto") renderCrypto(data);
      }catch(err){
        setStatus("err", "Could not load crypto", String(err));
        if (ACTIVE_TAB === "Crypto") el("cryptoDirectList").innerHTML = "<div class='subtle'>No crypto displayed.</div>";
      }
    }

    function handleRefresh(){
      if (ACTIVE_TAB === "Main") loadMain(true);
      if (ACTIVE_TAB === "Performance") loadPerf(true);
      if (ACTIVE_TAB === "Leaders") { CACHE_LEADERS = null; loadLeaders(true); }
      if (ACTIVE_TAB === "Crypto") loadCrypto(true);
    }

    // Window chips (Main)
    function setMainWindow(days){
      MAIN_WINDOW_DAYS = days;
      el("chip30").classList.toggle("chipActive", days === 30);
      el("chip180").classList.toggle("chipActive", days === 180);
      loadMain(true);
    }
    el("chip30").addEventListener("click", () => setMainWindow(30));
    el("chip180").addEventListener("click", () => setMainWindow(180));

    // Perf horizon chips
    function setPerfHorizon(days){
      PERF_HORIZON_DAYS = days;
      el("hChip30").classList.toggle("chipActive", days === 30);
      el("hChip90").classList.toggle("chipActive", days === 90);
      el("hChip180").classList.toggle("chipActive", days === 180);
      loadPerf(true);
    }
    el("hChip30").addEventListener("click", () => setPerfHorizon(30));
    el("hChip90").addEventListener("click", () => setPerfHorizon(90));
    el("hChip180").addEventListener("click", () => setPerfHorizon(180));

    // Crypto chips
    function setCryptoWindow(days){
      CRYPTO_WINDOW_DAYS = days;
      el("cChip30").classList.toggle("chipActive", days === 30);
      el("cChip180").classList.toggle("chipActive", days === 180);
      el("cChip365").classList.toggle("chipActive", days === 365);
      loadCrypto(true);
    }
    el("cChip30").addEventListener("click", () => setCryptoWindow(30));
    el("cChip180").addEventListener("click", () => setCryptoWindow(180));
    el("cChip365").addEventListener("click", () => setCryptoWindow(365));

    // Top tabs
    el("tabMainBtn").addEventListener("click", () => showTab("Main"));
    el("tabPerfBtn").addEventListener("click", () => showTab("Performance"));
    el("tabLeadersBtn").addEventListener("click", () => showTab("Leaders"));
    el("tabCryptoBtn").addEventListener("click", () => showTab("Crypto"));
    el("tabSearchBtn").addEventListener("click", () => showTab("Search"));

    // Bottom tabs
    el("navMain").addEventListener("click", () => showTab("Main"));
    el("navPerf").addEventListener("click", () => showTab("Performance"));
    el("navLeaders").addEventListener("click", () => showTab("Leaders"));
    el("navCrypto").addEventListener("click", () => showTab("Crypto"));
    el("navSearch").addEventListener("click", () => showTab("Search"));

    // Search
    el("searchBtn").addEventListener("click", () => {
      const t = String(el("searchInput").value || "").trim().toUpperCase();
      if (!t) return;
      window.location.hash = "#stock=" + encodeURIComponent(t);
      showTab("Search");
      handleHash();
    });

    // Refresh + chart
    el("refreshBtn").addEventListener("click", handleRefresh);
    window.addEventListener("hashchange", handleHash);

    // Start
    showTab("Main");
    loadMain(true);
  </script>
</body>
</html>

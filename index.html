<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#11111a;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --muted2:rgba(255,255,255,.55);
      --border:rgba(255,255,255,.10);

      --blue: rgba(60,130,255,.95);
      --blueBg: rgba(60,130,255,.12);

      --red: rgba(255,90,90,.95);
      --redBg: rgba(255,90,90,.12);

      --green: rgba(80,255,170,.85);
      --greenBg: rgba(80,255,170,.10);

      --orange: rgba(255,190,80,.90);
      --orangeBg: rgba(255,190,80,.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      font-size:13px;
      line-height:1.25;
    }

    a{ color:inherit; text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .wrap{ max-width:980px; margin:0 auto; padding:10px 12px 18px; }

    .topBar{
      position:sticky; top:0;
      background:rgba(11,11,15,.90);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--border);
      z-index:10;
    }

    .tabsTop{
      max-width:980px;
      margin:0 auto;
      padding:10px 12px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:8px;
    }

    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      padding:10px 10px;
      border-radius:12px;
      text-align:center;
      font-weight:700;
      letter-spacing:.01em;
      user-select:none;
    }
    .tabBtn.active{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border-color:rgba(255,255,255,.16);
    }

    .headerRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-top:12px;
    }
    .hTitle{
      font-size:18px;
      font-weight:900;
      letter-spacing:.01em;
    }
    .sub{
      color:var(--muted);
      margin-top:3px;
      font-size:12px;
    }
    .pillBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
    }

    .sectionTitle{
      margin:14px 0 8px;
      color:var(--muted);
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){
      .grid2{ grid-template-columns:1fr; }
    }

    .colHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius:14px;
    }
    .colHeader .label{
      font-weight:900;
      letter-spacing:.02em;
    }

    .card{
      border:1px solid var(--border);
      background:var(--card);
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:8px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-weight:950;
      font-size:14px;
      letter-spacing:.01em;
    }
    .company{
      color:var(--muted2);
      font-weight:700;
      font-size:12px;
    }

    .badges{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      white-space:nowrap;
      font-weight:900;
      letter-spacing:.01em;
    }
    .bBlue{ border-color: rgba(60,130,255,.35); background: var(--blueBg); color: rgba(190,220,255,.95); }
    .bRed{ border-color: rgba(255,90,90,.35); background: var(--redBg); color: rgba(255,210,210,.95); }
    .bGreen{ border-color: rgba(80,255,170,.35); background: var(--greenBg); color: rgba(200,255,235,.95); }
    .bOrange{ border-color: rgba(255,190,80,.35); background: var(--orangeBg); color: rgba(255,235,200,.95); }

    .meta{
      margin-top:6px;
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
    }

    .miniLinks{
      margin-top:8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      color:rgba(255,255,255,.78);
      font-size:12px;
      font-weight:800;
    }
    .miniLinks a{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
    }

    .empty{
      color:var(--muted);
      padding:8px 2px;
      font-size:12px;
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:10px 10px 2px;
    }

    .searchRow{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:10px;
    }
    .input{
      flex:1;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    .hint{ color:var(--muted); font-size:12px; margin-top:6px; }
  </style>
</head>

<body>
  <div class="topBar">
    <div class="tabsTop">
      <div class="tabBtn active" data-tab="today">Today</div>
      <div class="tabBtn" data-tab="funds">Sovereign Funds</div>
      <div class="tabBtn" data-tab="search">Search</div>
      <div class="tabBtn" data-tab="settings">Settings</div>
    </div>
  </div>

  <div class="wrap">
    <div class="headerRow">
      <div>
        <div class="hTitle" id="screenTitle">Today</div>
        <div class="sub" id="reportDate"> </div>
      </div>
      <button class="pillBtn" id="refreshBtn">Refresh</button>
    </div>

    <div class="status" id="statusBox">Status: Ready.</div>

    <!-- TODAY -->
    <div id="tab-today">
      <div class="sectionTitle">Convergence is key</div>
      <div class="panel" id="convergencePanel">
        <div id="convergenceList"></div>
      </div>

      <div class="sectionTitle">Buys vs Sells</div>
      <div class="grid2">
        <div class="panel">
          <div class="colHeader">
            <div class="label">Buys</div>
            <div class="badge bGreen">Action: BUY</div>
          </div>
          <div id="buysList"></div>
        </div>
        <div class="panel">
          <div class="colHeader">
            <div class="label">Sells</div>
            <div class="badge bOrange">Action: SELL</div>
          </div>
          <div id="sellsList"></div>
        </div>
      </div>
    </div>

    <!-- FUNDS -->
    <div id="tab-funds" style="display:none;">
      <div class="sectionTitle">Sovereign wealth funds</div>
      <div class="panel">
        <div id="fundsList"></div>
      </div>
      <div class="hint">
        This tab loads from <b>/report/sovereign/today</b>. If your backend does not have it yet, you will see an error here.
      </div>
    </div>

    <!-- SEARCH -->
    <div id="tab-search" style="display:none;">
      <div class="sectionTitle">Search tickers (quick links)</div>
      <div class="panel" style="padding:12px;">
        <div class="searchRow">
          <input class="input" id="searchInput" placeholder="Type ticker, e.g. NVDA" />
          <button class="pillBtn" id="searchBtn">Open</button>
        </div>
        <div class="hint">Opens Yahoo Finance and TradingView for the ticker.</div>
        <div class="miniLinks" id="searchLinks" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div id="tab-settings" style="display:none;">
      <div class="sectionTitle">Backend</div>
      <div class="panel" style="padding:12px;">
        <div class="meta">
          Current backend URL:
          <div style="margin-top:8px; font-weight:900; color:rgba(255,255,255,.92);" id="backendUrlText"></div>
        </div>
        <div class="hint" style="margin-top:10px;">
          If you ever change the backend, update <b>BACKEND_URL</b> inside this file and push to GitHub again.
        </div>
      </div>

      <div class="sectionTitle">Notes</div>
      <div class="panel" style="padding:12px;">
        <div class="meta">
          Front end changes do <b>not</b> require redeploying Render. Only backend changes do.
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const BACKEND_URL = "https://finance-backend-dzta.onrender.com/report/today";
    const FUNDS_URL   = "https://finance-backend-dzta.onrender.com/report/sovereign/today";

    // =========================
    // HELPERS
    // =========================
    const el = (id) => document.getElementById(id);

    function setStatus(msg){
      el("statusBox").textContent = msg;
    }

    function safeStr(x){
      return (x === null || x === undefined) ? "" : String(x);
    }

    function toInt(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    function tickerLinks(ticker){
      const t = encodeURIComponent(ticker);
      return {
        yahoo: `https://finance.yahoo.com/quote/${t}`,
        tv:    `https://www.tradingview.com/symbols/${t}/`,
        quiver:`https://www.quiverquant.com/stock/${t}/`
      };
    }

    function sortByPeopleThenTicker(arr){
      return (arr || []).slice().sort((a,b)=>{
        const aTot = toInt(a.demBuyers) + toInt(a.repBuyers) + toInt(a.demSellers) + toInt(a.repSellers);
        const bTot = toInt(b.demBuyers) + toInt(b.repBuyers) + toInt(b.demSellers) + toInt(b.repSellers);
        if (bTot !== aTot) return bTot - aTot;
        return safeStr(a.ticker).localeCompare(safeStr(b.ticker));
      });
    }

    function sortByCountThenTicker(arr, side){
      // side: "buy" uses demBuyers+repBuyers, "sell" uses demSellers+repSellers
      return (arr || []).slice().sort((a,b)=>{
        const aTot = side === "sell"
          ? (toInt(a.demSellers) + toInt(a.repSellers))
          : (toInt(a.demBuyers) + toInt(a.repBuyers));
        const bTot = side === "sell"
          ? (toInt(b.demSellers) + toInt(b.repSellers))
          : (toInt(b.demBuyers) + toInt(b.repBuyers));
        if (bTot !== aTot) return bTot - aTot;
        return safeStr(a.ticker).localeCompare(safeStr(b.ticker));
      });
    }

    function badgeHTML(label, cls){
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function stockCardHTML(x, mode){
      // mode: "convergence" | "buy" | "sell"
      const ticker = safeStr(x.ticker).toUpperCase();
      const companyName = safeStr(x.companyName);
      const links = tickerLinks(ticker);

      const demBuy = toInt(x.demBuyers);
      const repBuy = toInt(x.repBuyers);
      const demSell = toInt(x.demSellers);
      const repSell = toInt(x.repSellers);

      const lastFiledAt = safeStr(x.lastFiledAt);
      const strength = safeStr(x.strength);

      let badges = "";
      if (mode === "buy"){
        badges += badgeHTML(`D ${demBuy}`, "bBlue");
        badges += badgeHTML(`R ${repBuy}`, "bRed");
        badges += badgeHTML(`Total ${demBuy + repBuy}`, "bGreen");
      } else if (mode === "sell"){
        badges += badgeHTML(`D ${demSell}`, "bBlue");
        badges += badgeHTML(`R ${repSell}`, "bRed");
        badges += badgeHTML(`Total ${demSell + repSell}`, "bOrange");
      } else {
        // convergence
        const buyTot = demBuy + repBuy;
        const sellTot = demSell + repSell;
        badges += badgeHTML(`Buy D ${demBuy}`, "bBlue");
        badges += badgeHTML(`Buy R ${repBuy}`, "bRed");
        badges += badgeHTML(`Sell D ${demSell}`, "bBlue");
        badges += badgeHTML(`Sell R ${repSell}`, "bRed");
        badges += badgeHTML(`People ${buyTot + sellTot}`, "bGreen");
        if (strength) badges += badgeHTML(strength, "bOrange");
      }

      const subtitleBits = [];
      if (mode === "convergence"){
        subtitleBits.push(`Buys: D ${demBuy} | R ${repBuy}`);
        subtitleBits.push(`Sells: D ${demSell} | R ${repSell}`);
      } else if (mode === "buy"){
        subtitleBits.push(`Buyers: D ${demBuy} | R ${repBuy}`);
      } else {
        subtitleBits.push(`Sellers: D ${demSell} | R ${repSell}`);
      }
      if (lastFiledAt) subtitleBits.push(`Last filed: ${lastFiledAt}`);

      return `
        <div class="card">
          <div class="row">
            <div class="tickerLine">
              <a class="ticker" href="${links.yahoo}" target="_blank" rel="noopener">${ticker}</a>
              ${companyName ? `<span class="company">${companyName}</span>` : ""}
            </div>
            <div class="badges">${badges}</div>
          </div>
          <div class="meta">${subtitleBits.join(" • ")}</div>
          <div class="miniLinks">
            <a href="${links.yahoo}" target="_blank" rel="noopener">Price</a>
            <a href="${links.tv}" target="_blank" rel="noopener">Chart</a>
            <a href="${links.quiver}" target="_blank" rel="noopener">Signals</a>
          </div>
        </div>
      `;
    }

    function fundSignalCardHTML(s){
      // expected fields:
      // { ticker, companyName, fundName, action, filedAt, details }
      const ticker = safeStr(s.ticker).toUpperCase();
      const companyName = safeStr(s.companyName);
      const fundName = safeStr(s.fundName);
      const action = safeStr(s.action).toUpperCase();
      const filedAt = safeStr(s.filedAt);
      const details = safeStr(s.details);
      const links = tickerLinks(ticker);

      const actionBadge = action === "SELL"
        ? badgeHTML("SELL", "bOrange")
        : badgeHTML("BUY", "bGreen");

      return `
        <div class="card">
          <div class="row">
            <div class="tickerLine">
              <a class="ticker" href="${links.yahoo}" target="_blank" rel="noopener">${ticker}</a>
              ${companyName ? `<span class="company">${companyName}</span>` : ""}
            </div>
            <div class="badges">
              ${actionBadge}
              ${fundName ? badgeHTML(fundName, "badge") : ""}
            </div>
          </div>
          <div class="meta">
            ${fundName ? `<b>${fundName}</b> • ` : ""}${filedAt ? `Filed: ${filedAt}` : "Filed: n/a"}
            ${details ? ` • ${details}` : ""}
          </div>
          <div class="miniLinks">
            <a href="${links.yahoo}" target="_blank" rel="noopener">Price</a>
            <a href="${links.tv}" target="_blank" rel="noopener">Chart</a>
            <a href="${links.quiver}" target="_blank" rel="noopener">Signals</a>
          </div>
        </div>
      `;
    }

    function showEmpty(targetId, msg){
      el(targetId).innerHTML = `<div class="empty">${msg}</div>`;
    }

    // =========================
    // RENDER
    // =========================
    function renderToday(data){
      const date = safeStr(data.date);
      el("reportDate").textContent = date ? date : "";

      // Expecting arrays:
      // data.convergence: items with demBuyers, repBuyers, demSellers, repSellers
      // data.buys: items with demBuyers, repBuyers
      // data.sells: items with demSellers, repSellers
      const convergence = sortByPeopleThenTicker(data.convergence || []);
      const buys = sortByCountThenTicker(data.buys || [], "buy");
      const sells = sortByCountThenTicker(data.sells || [], "sell");

      if (!convergence.length) showEmpty("convergenceList", "No convergence items today.");
      else el("convergenceList").innerHTML = convergence.map(x => stockCardHTML(x, "convergence")).join("");

      if (!buys.length) showEmpty("buysList", "No buys found.");
      else el("buysList").innerHTML = buys.map(x => stockCardHTML(x, "buy")).join("");

      if (!sells.length) showEmpty("sellsList", "No sells found.");
      else el("sellsList").innerHTML = sells.map(x => stockCardHTML(x, "sell")).join("");
    }

    function renderFunds(data){
      const date = safeStr(data.date);
      el("reportDate").textContent = date ? date : "";

      const signals = (data.signals || []).slice().sort((a,b)=>{
        // sort by action then ticker
        const aa = safeStr(a.action).toUpperCase();
        const bb = safeStr(b.action).toUpperCase();
        if (aa !== bb) return aa.localeCompare(bb);
        return safeStr(a.ticker).localeCompare(safeStr(b.ticker));
      });

      if (!signals.length) showEmpty("fundsList", "No sovereign fund signals yet.");
      else el("fundsList").innerHTML = signals.map(fundSignalCardHTML).join("");
    }

    // =========================
    // LOADERS
    // =========================
    async function fetchJSON(url){
      const res = await fetch(url, { cache:"no-store" });
      let data = null;
      try { data = await res.json(); } catch(e) {}
      if (!res.ok){
        const msg = data && data.error ? data.error : (`HTTP ${res.status}`);
        throw new Error(msg);
      }
      if (data && data.error) throw new Error(data.error);
      return data;
    }

    async function loadToday(){
      setStatus("Status: Loading live data…");
      showEmpty("convergenceList", "Loading…");
      el("buysList").innerHTML = "";
      el("sellsList").innerHTML = "";

      try{
        const data = await fetchJSON(BACKEND_URL);
        renderToday(data);
        setStatus("Status: Live data loaded ✅");
      } catch(err){
        setStatus("Status: Could not load live data ❌");
        showEmpty("convergenceList", "Could not load live data. Error: " + safeStr(err));
        showEmpty("buysList", "");
        showEmpty("sellsList", "");
      }
    }

    async function loadFunds(){
      setStatus("Status: Loading sovereign funds…");
      showEmpty("fundsList", "Loading…");

      try{
        const data = await fetchJSON(FUNDS_URL);
        renderFunds(data);
        setStatus("Status: Sovereign fund signals loaded ✅");
      } catch(err){
        setStatus("Status: Could not load sovereign funds ❌");
        showEmpty("fundsList", "Could not load sovereign funds. Error: " + safeStr(err));
      }
    }

    // =========================
    // TABS
    // =========================
    function setActiveTab(name){
      document.querySelectorAll(".tabBtn").forEach(b=>{
        b.classList.toggle("active", b.getAttribute("data-tab") === name);
      });

      el("tab-today").style.display = (name === "today") ? "" : "none";
      el("tab-funds").style.display = (name === "funds") ? "" : "none";
      el("tab-search").style.display = (name === "search") ? "" : "none";
      el("tab-settings").style.display = (name === "settings") ? "" : "none";

      if (name === "today") el("screenTitle").textContent = "Today";
      if (name === "funds") el("screenTitle").textContent = "Sovereign Funds";
      if (name === "search") el("screenTitle").textContent = "Search";
      if (name === "settings") el("screenTitle").textContent = "Settings";

      // Load on tab switch
      if (name === "today") loadToday();
      if (name === "funds") loadFunds();
      if (name === "settings"){
        el("backendUrlText").textContent = BACKEND_URL.replace("/report/today","").replace("/report/today/","");
      }
    }

    document.querySelectorAll(".tabBtn").forEach(b=>{
      b.addEventListener("click", ()=> setActiveTab(b.getAttribute("data-tab")));
    });

    // =========================
    // SEARCH
    // =========================
    function renderSearchLinks(ticker){
      const t = safeStr(ticker).trim().toUpperCase();
      if (!t) { el("searchLinks").innerHTML = ""; return; }
      const links = tickerLinks(t);
      el("searchLinks").innerHTML = `
        <a href="${links.yahoo}" target="_blank" rel="noopener">Yahoo: ${t}</a>
        <a href="${links.tv}" target="_blank" rel="noopener">TradingView: ${t}</a>
        <a href="${links.quiver}" target="_blank" rel="noopener">Quiver: ${t}</a>
      `;
    }

    el("searchInput").addEventListener("input", (e)=> renderSearchLinks(e.target.value));
    el("searchBtn").addEventListener("click", ()=>{
      const t = el("searchInput").value.trim().toUpperCase();
      if (!t) return;
      window.open(tickerLinks(t).yahoo, "_blank", "noopener");
    });

    // =========================
    // REFRESH BUTTON
    // =========================
    el("refreshBtn").addEventListener("click", ()=>{
      const active = document.querySelector(".tabBtn.active")?.getAttribute("data-tab") || "today";
      if (active === "today") loadToday();
      else if (active === "funds") loadFunds();
    });

    // Boot
    setActiveTab("today");
  </script>
</body>
</html>

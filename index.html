<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <meta name="theme-color" content="#0b0b0f" />
  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);

      --dem:#4aa3ff;
      --rep:#ff5a5a;
      --both:#b38bff;

      --ok:#7cffc0;
      --err:#ff8a8a;

      --pos:#7cffc0;
      --neg:#ff8a8a;

      --sec:#ffd27d;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:12px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      padding:12px 14px 8px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    .h1{font-size:16px;font-weight:900;letter-spacing:.01em}
    .subtle{font-size:12px;color:var(--muted);margin-top:2px}
    .pillBtn{
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:8px 14px 110px;
    }

    .status{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px 10px;
      margin:6px 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .status strong{color:#fff}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .tabRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 8px;
      align-items:center;
    }
    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:7px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
    }
    .tabBtnActive{
      color:#fff;
      background:rgba(255,255,255,.10);
    }

    .rightTools{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      padding:7px 10px;
      cursor:pointer;
    }
    .seg .on{
      background:rgba(255,255,255,.10);
      color:#fff;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 820px){
      .grid2{grid-template-columns:1fr 1fr;}
    }

    .grid3{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .grid3{grid-template-columns:repeat(3,1fr);}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .grid3{grid-template-columns:repeat(2,1fr);}
    }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .kpiTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .kpiTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .kpiValue{
      font-size:16px;
      font-weight:900;
      letter-spacing:.02em;
      margin-top:4px;
    }
    .kpiSub{
      font-size:12px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
    }
    .kpiList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:rgba(255,255,255,.90);
      align-items:center;
    }
    .kpiBadge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      color:rgba(255,255,255,.90);
    }
    .badgePos{border-color:rgba(124,255,192,.45); color:var(--pos)}
    .badgeNeg{border-color:rgba(255,138,138,.45); color:var(--neg)}
    .badgeNeu{border-color:rgba(255,255,255,.18); color:rgba(255,255,255,.85)}
    .badgeBoth{border-color:rgba(179,139,255,.45); color:var(--both)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px 9px;
      margin-bottom:8px;
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-size:13px;
      font-weight:900;
      letter-spacing:.03em;
    }
    .who{
      font-size:12px;
      color:var(--muted);
      max-width:720px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tagDem{border-color:rgba(74,163,255,.5); color:var(--dem)}
    .tagRep{border-color:rgba(255,90,90,.5); color:var(--rep)}
    .tagBoth{border-color:rgba(179,139,255,.55); color:var(--both)}
    .tagBuy{border-color:rgba(124,255,192,.45); color:var(--ok)}
    .tagSell{border-color:rgba(255,138,138,.45); color:var(--err)}
    .tagSEC{border-color:rgba(255,210,125,.40); color:var(--sec)}

    .metaRow{
      margin-top:7px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      line-height:1.25;
    }

    .counts{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .countItem{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }

    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dotDem{background:var(--dem)}
    .dotRep{background:var(--rep)}

    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0 7px}

    .miniLinks{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .miniLink{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      margin:10px 0 10px;
    }
    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .panelTitle h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }

    iframe{
      width:100%;
      height:360px;
      border:0;
      border-radius:12px;
      background:#000;
      margin-top:8px;
    }

    .tabsBottom{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#151522f0;
      border-top:1px solid var(--border);
      backdrop-filter:blur(12px);
    }
    .tabBarBottom{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(5,1fr);
    }
    .tabBottom{
      text-align:center;
      padding:11px 10px 16px;
      font-size:11px;
      color:var(--muted);
      user-select:none;
      cursor:pointer;
    }
    .tabBottomActive{color:#fff}

    .holdingsGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 980px){
      .holdingsGrid{grid-template-columns:1fr 1fr;}
    }
    .holdingsItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
    }

    .input{
      width:100%;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:#fff;
      border-radius:12px;
      padding:10px;
      font-size:12px;
      outline:none;
    }

    details.briefingDetails{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
      margin-top:10px;
    }
    details.briefingDetails > summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details.briefingDetails > summary::-webkit-details-marker{display:none}
    .summaryLeft{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .summaryTitle{
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .summaryMeta{
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:740px;
    }
    .bulletList{
      margin:8px 0 0;
      padding-left:16px;
      color:rgba(255,255,255,.86);
      line-height:1.3;
    }
    .headlineList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .headlineItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
    }
    .headlineTitle{
      font-size:12px;
      color:rgba(255,255,255,.92);
      line-height:1.25;
    }
    .headlineMeta{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    details.cryptoDetails{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
      margin-top:10px;
    }
    details.cryptoDetails > summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details.cryptoDetails > summary::-webkit-details-marker{display:none}
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="h1" id="pageTitle">Convergence</div>
      <div class="subtle" id="reportDate"></div>
    </div>
    <button class="pillBtn" id="refreshBtn">Refresh</button>
  </header>

  <main class="container">
    <div class="status" id="statusBox">
      <strong>Status:</strong> <span id="statusText">Loading…</span><br/>
      <span class="mono" id="statusDetail"></span>
    </div>

    <div class="tabRow">
      <button class="tabBtn tabBtnActive" id="tabMainBtn">Main</button>
      <button class="tabBtn" id="tabNewsBtn">News</button>
      <button class="tabBtn" id="tabCongressBtn">Congress</button>
      <button class="tabBtn" id="tabCryptoBtn">Crypto</button>
      <button class="tabBtn" id="tabPerfBtn">Performance</button>

      <div class="rightTools" id="mainWindowTools">
        <div class="seg" aria-label="window toggle">
          <button id="btn30" class="on">30D</button>
          <button id="btn180">180D</button>
          <button id="btn365">365D</button>
        </div>
      </div>
    </div>

    <div id="stockPanel" style="display:none;"></div>

    <!-- MAIN TAB -->
    <section id="viewMain">
      <div class="sectionTitle">Market entry</div>
      <div class="panel">
        <div class="grid3">
          <div class="kpi" id="entryKpiScore"></div>
          <div class="kpi" id="entryKpiRules"></div>
          <div class="kpi" id="entryKpiNotes"></div>
        </div>
        <div class="subtle" id="entryHint" style="margin-top:10px;"></div>
      </div>

      <div class="sectionTitle">What this app is for</div>
      <div class="panel">
        <div class="kpiSub">
          This is a pacing dashboard, not a prediction engine.
          Use Market Entry to decide how aggressive to DCA. Use News for sentiment context.
          Use Congress and Crypto for idea discovery.
        </div>
      </div>
    </section>

    <!-- NEWS TAB -->
    <section id="viewNews" style="display:none;">
      <div class="sectionTitle">Market snapshot</div>
      <div class="grid3">
        <div class="kpi" id="snapKpiSPY"></div>
        <div class="kpi" id="snapKpiVIX"></div>
        <div class="kpi" id="snapKpiFG"></div>
      </div>
      <div class="subtle" id="snapHint" style="margin-top:10px;"></div>

      <div class="sectionTitle">Daily briefing</div>
      <div class="grid3">
        <div class="kpi" id="briefKpiSentiment"></div>
        <div class="kpi" id="briefKpiScope"></div>
        <div class="kpi" id="briefKpiNotes"></div>
      </div>

      <div class="sectionTitle">Your watchlist</div>
      <div class="panel">
        <div class="kpiSub">
          Comma-separated tickers. Example: SPY,QQQ,NVDA,AAPL
          This watchlist influences the briefing and pulls ticker RSS into the same sector view.
        </div>
        <div style="margin-top:10px;">
          <input class="input" id="watchInput" value="SPY,QQQ,NVDA,AAPL,MSFT,AMZN,GOOGL,META,TSLA,BRK-B" />
        </div>
        <div class="miniLinks" style="margin-top:10px;">
          <button class="pillBtn" id="watchApplyBtn">Refresh briefing</button>
          <button class="pillBtn" id="snapRefreshBtn">Refresh snapshot</button>
        </div>
      </div>

      <div class="sectionTitle">Sectors</div>
      <div id="briefingSectors"></div>

      <div class="subtle" id="briefHint" style="margin-top:12px;"></div>
    </section>

    <!-- CONGRESS TAB -->
    <section id="viewCongress" style="display:none;">
      <div class="sectionTitle">Common holdings (simple)</div>
      <div class="panel">
        <div class="panelTitle">
          <h2>Most commonly held tickers</h2>
          <span class="kpiBadge badgeNeu" id="holdingsWindowBadge">365D</span>
        </div>
        <div class="subtle" style="margin-top:6px;">
          Ticker + how many unique politicians disclosed activity in that ticker during the selected window.
        </div>

        <div class="divider"></div>

        <div class="kpi" id="holdingsKpiSimple"></div>

        <div class="divider"></div>

        <div class="sectionTitle" style="margin-top:0;">Ranked by holder count</div>
        <div id="holdingsList" class="holdingsGrid"></div>

        <div class="subtle" id="holdingsHint" style="margin-top:10px;"></div>
      </div>

      <div class="sectionTitle">Day-by-day trade feed</div>
      <div class="panel">
        <div class="kpiSub">
          This is the detailed activity view. Grouped by filed date when available.
        </div>
        <div class="divider"></div>
        <div id="dailyTradeList"></div>
        <div class="subtle" id="dailyHint" style="margin-top:10px;"></div>
      </div>

      <div class="sectionTitle" id="kpiTitle">Congress activity dashboard</div>
      <div class="grid3">
        <div class="kpi" id="kpiNet"></div>
        <div class="kpi" id="kpiPart"></div>
        <div class="kpi" id="kpiHighlights"></div>
      </div>

      <div class="sectionTitle" id="convTitle">Convergence (bipartisan overlap on BUY)</div>
      <div id="convergenceList"></div>

      <div class="sectionTitle" id="partTitle">Trades by participation</div>
      <div class="grid2">
        <div>
          <div class="sectionTitle" style="margin-top:0;">Buys</div>
          <div id="buyList"></div>
        </div>
        <div>
          <div class="sectionTitle" style="margin-top:0;">Sells</div>
          <div id="sellList"></div>
        </div>
      </div>

      <div class="subtle" id="mainHint"></div>
    </section>

    <!-- CRYPTO TAB -->
    <section id="viewCrypto" style="display:none;">
      <div class="sectionTitle">Crypto news briefing</div>

      <div class="panel">
        <div class="kpiSub">
          This is headline context and upcoming catalysts. It is meant to flag what could move price.
          Use Refresh sparingly to reduce rate-limits.
        </div>

        <div class="divider"></div>

        <div class="grid3">
          <div class="kpi" id="cryptoNewsKpiOverall"></div>
          <div class="kpi" id="cryptoNewsKpiScope"></div>
          <div class="kpi" id="cryptoNewsKpiNotes"></div>
        </div>

        <div class="divider"></div>

        <div class="kpiSub"><strong>Coins</strong></div>
        <div style="margin-top:8px;">
          <input class="input" id="cryptoCoinsInput" value="BTC,ETH,LINK,SHIB" />
        </div>
        <div class="miniLinks" style="margin-top:10px;">
          <button class="pillBtn" id="cryptoNewsRefreshBtn">Refresh crypto news</button>
        </div>

        <div class="divider"></div>

        <div class="kpiSub"><strong>Major upcoming catalysts (next days to weeks)</strong></div>
        <ul class="bulletList" id="cryptoCatalystsList"></ul>

        <div class="divider"></div>

        <div class="kpiSub"><strong>Coins and headlines</strong></div>
        <div id="cryptoNewsCoins"></div>

        <div class="subtle" id="cryptoNewsHint" style="margin-top:10px;"></div>
      </div>

      <div class="sectionTitle" id="cryptoTitle">Crypto disclosures</div>

      <div class="panel">
        <div class="kpiSub">
          Includes direct coin mapping, hint-only disclosures, and crypto-linked tickers.
          Use 180D or 365D if 30D looks sparse.
        </div>
      </div>

      <div class="grid2">
        <div>
          <div class="sectionTitle">Direct crypto disclosures (BUY)</div>
          <div id="cryptoDirectBuys"></div>

          <div class="sectionTitle" style="margin-top:14px;">Direct crypto disclosures (SELL)</div>
          <div id="cryptoDirectSells"></div>
        </div>

        <div>
          <div class="sectionTitle">Hint-only crypto disclosures (BUY/SELL)</div>
          <div class="subtle" style="margin-top:-4px;">
            Mentions “crypto / digital asset” but does not cleanly map to a coin symbol.
          </div>
          <div id="cryptoHintOnly"></div>

          <div class="sectionTitle" style="margin-top:14px;">Crypto-linked tickers</div>
          <div id="cryptoLinkedTickers"></div>
        </div>
      </div>

      <div class="subtle" id="cryptoHint" style="margin-top:12px;"></div>
    </section>

    <!-- PERFORMANCE TAB -->
    <section id="viewPerf" style="display:none;">
      <div class="sectionTitle">Politician performance</div>
      <div class="panel">
        <div class="kpiSub">
          Portfolio performance inside the app needs a backend integration.
          Many providers block browser-side scraping.
          Use these trackers plus the Congress day-by-day feed.
        </div>

        <div class="miniLinks" style="margin-top:10px;">
          <a class="miniLink" target="_blank" rel="noopener" href="https://www.capitoltrades.com/">Capitol Trades</a>
          <a class="miniLink" target="_blank" rel="noopener" href="https://www.quiverquant.com/congresstrading/">QuiverQuant Congress Trading</a>
          <a class="miniLink" target="_blank" rel="noopener" href="https://efdsearch.senate.gov/search/home/">Senate EFD Search</a>
          <a class="miniLink" target="_blank" rel="noopener" href="https://disclosures-clerk.house.gov/">House Disclosures</a>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabsBottom">
    <div class="tabBarBottom">
      <div class="tabBottom tabBottomActive" id="navMain">Main</div>
      <div class="tabBottom" id="navNews">News</div>
      <div class="tabBottom" id="navCongress">Congress</div>
      <div class="tabBottom" id="navCrypto">Crypto</div>
      <div class="tabBottom" id="navPerf">Performance</div>
    </div>
  </nav>

  <script>
    const BACKEND_BASE = "https://finance-backend-1-bbi9.onrender.com";

    const TODAY_URL = (windowDays) =>
      `${BACKEND_BASE}/report/today?window_days=${encodeURIComponent(String(windowDays))}`;

    const HOLDINGS_URL = (windowDays) =>
      `${BACKEND_BASE}/report/holdings/common?window_days=${encodeURIComponent(String(windowDays))}&top_n=30`;

    const DAILY_URL = (windowDays) =>
      `${BACKEND_BASE}/report/congress/daily?window_days=${encodeURIComponent(String(windowDays))}&limit=250`;

    const ENTRY_URL = (windowDays) =>
      `${BACKEND_BASE}/market/entry?window_days=${encodeURIComponent(String(windowDays))}`;

    const MARKET_SNAPSHOT_URL = () =>
      `${BACKEND_BASE}/market/snapshot`;

    const NEWS_BRIEF_URL = (watchlist) => {
    const wl = String(watchlist || "");
    return `${BACKEND_BASE}/news/briefing?tickers=${encodeURIComponent(wl)}&max_general=60&max_per_ticker=6`;
    };

    const CRYPTO_NEWS_URL = (coins, includeTopN) =>
      `${BACKEND_BASE}/crypto/news/briefing?coins=${encodeURIComponent(String(coins||""))}&include_top_n=${encodeURIComponent(String(includeTopN||15))}`;

    const el = (id) => document.getElementById(id);

    let ACTIVE_TAB = "Main";
    let WINDOW_DAYS = 30;

    let CACHE_MAIN = new Map();
    let CACHE_ENTRY = new Map();
    let CACHE_HOLDINGS = new Map();
    let CACHE_DAILY = new Map();
    let CACHE_BRIEFING = new Map();
    let CACHE_SNAPSHOT = null;
    let CACHE_SNAPSHOT_TS = 0;

    let CACHE_CRYPTO_NEWS = new Map();

    let LAST_HARD_REFRESH_MS = 0;
    const HARD_REFRESH_COOLDOWN_MS = 25000;

    function setStatus(kind, text, detail){
      const st = el("statusText");
      const sd = el("statusDetail");
      st.textContent = text || "";
      st.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
      sd.textContent = detail || "";
    }

    function setTitleForTab(tab){
      const map = {
        "Main":"Convergence",
        "News":"News",
        "Congress":"Congress",
        "Crypto":"Crypto",
        "Performance":"Performance",
      };
      el("pageTitle").textContent = map[tab] || "Convergence";
    }

    function setStockPanel(ticker){
      const t = String(ticker||"").toUpperCase();
      if (!t){
        el("stockPanel").style.display = "none";
        el("stockPanel").innerHTML = "";
        return;
      }
      const symbol = "NASDAQ:" + t;
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tv = `https://www.tradingview.com/symbols/${encodeURIComponent(symbol)}/`;

      el("stockPanel").style.display = "";
      el("stockPanel").innerHTML = `
        <div class="panel">
          <div class="panelTitle">
            <h2>${t} chart</h2>
            <button class="pillBtn" id="closeStockBtn">Close</button>
          </div>
          <iframe
            title="TradingView Chart"
            src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=D&hidesidetoolbar=0&symboledit=1&saveimage=1&toolbarbg=%23151522&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1"
            loading="lazy">
          </iframe>
          <div class="miniLinks">
            <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Open Yahoo</a>
            <a class="miniLink" href="${tv}" target="_blank" rel="noopener">Open TradingView</a>
          </div>
        </div>
      `;
      const btn = document.getElementById("closeStockBtn");
      if (btn) btn.addEventListener("click", () => {
        history.pushState("", document.title, window.location.pathname + window.location.search);
        setStockPanel("");
      });
    }

    function handleHash(){
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim();
        setStockPanel(t);
        return;
      }
      setStockPanel("");
    }

    function tickerLinksHTML(ticker){
      const t = String(ticker||"").toUpperCase();
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tvChart = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent("NASDAQ:" + t)}`;
      return `
        <div class="miniLinks">
          <a class="miniLink" href="#stock=${t}">Chart</a>
          <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Yahoo</a>
          <a class="miniLink" href="${tvChart}" target="_blank" rel="noopener">TV</a>
        </div>
      `;
    }

    function entryBadge(score){
      const s = Number(score || 0);
      if (s >= 75) return {label:"RISK-ON", cls:"badgePos"};
      if (s >= 55) return {label:"NEUTRAL", cls:"badgeNeu"};
      return {label:"RISK-OFF", cls:"badgeNeg"};
    }

    function renderEntryIndex(payload){
      if (!payload || typeof payload.score !== "number"){
        el("entryKpiScore").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">Market entry index</div>
              <div class="kpiValue">Unavailable</div>
            </div>
            <span class="kpiBadge badgeNeu">Backend</span>
          </div>
          <div class="kpiSub">
            Backend must expose <span class="mono">/market/entry</span>.
          </div>
        `;
        el("entryKpiRules").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">Simple strategy</div>
              <div class="kpiValue">Pacing DCA</div>
            </div>
            <span class="kpiBadge badgeNeu">Rules</span>
          </div>
          <div class="kpiSub">
            <div class="kpiList">
              <div class="kpiRow"><span>75–100</span><span class="kpiBadge badgePos">Aggressive buys</span></div>
              <div class="kpiRow"><span>55–74</span><span class="kpiBadge badgeNeu">Normal DCA</span></div>
              <div class="kpiRow"><span>0–54</span><span class="kpiBadge badgeNeg">Small DCA only</span></div>
            </div>
          </div>
        `;
        el("entryKpiNotes").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">What it means</div>
              <div class="kpiValue">One number</div>
            </div>
            <span class="kpiBadge badgeNeu">0–100</span>
          </div>
          <div class="kpiSub">Risk temperature, not prediction.</div>
        `;
        el("entryHint").textContent = "Once /market/entry returns data, this is your pacing meter.";
        return;
      }

      const b = entryBadge(payload.score);
      const regime = payload.regime || b.label;
      const signal = payload.signal || (payload.score >= 70 ? "ACCUMULATE" : payload.score >= 55 ? "ACCUMULATE SLOWLY" : "WAIT / SMALL DCA");
      const notes = payload.notes || "";
      const c = payload.components || {};
      const pct01 = (x) => `${Math.round(100 * Number(x || 0))}%`;

      el("entryKpiScore").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Market entry index</div>
            <div class="kpiValue">${Math.round(payload.score)}/100</div>
          </div>
          <span class="kpiBadge ${b.cls}">${regime}</span>
        </div>
        <div class="kpiSub">
          Suggested action: <strong>${signal}</strong><br/>
          ${notes ? `<span class="subtle">${notes}</span>` : ""}
        </div>
      `;

      el("entryKpiRules").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Drivers</div>
            <div class="kpiValue">What moved it</div>
          </div>
          <span class="kpiBadge badgeNeu">${payload.date || ""}</span>
        </div>
        <div class="kpiSub">
          <div class="kpiList">
            <div class="kpiRow"><span>SPX trend</span><span class="kpiBadge badgeNeu">${pct01(c.spxTrend)}</span></div>
            <div class="kpiRow"><span>Volatility</span><span class="kpiBadge badgeNeu">${pct01(c.vix)}</span></div>
            <div class="kpiRow"><span>Breadth</span><span class="kpiBadge badgeNeu">${pct01(c.breadth)}</span></div>
            <div class="kpiRow"><span>Credit</span><span class="kpiBadge badgeNeu">${pct01(c.credit)}</span></div>
            <div class="kpiRow"><span>Rates</span><span class="kpiBadge badgeNeu">${pct01(c.rates)}</span></div>
          </div>
        </div>
      `;

      el("entryKpiNotes").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">How to use it</div>
            <div class="kpiValue">Pacing</div>
          </div>
          <span class="kpiBadge badgeNeu">Simple</span>
        </div>
        <div class="kpiSub">
          Increase buys when score is high. Slow down when low. Combine with watchlist quality.
        </div>
      `;

      el("entryHint").textContent = "High score: faster DCA. Low score: smaller buys and patience.";
    }

    async function loadEntryIndex(windowDays, force){
      const key = String(windowDays || 365);
      if (CACHE_ENTRY.has(key) && !force){
        renderEntryIndex(CACHE_ENTRY.get(key));
        return;
      }
      try{
        const url = ENTRY_URL(windowDays || 365);
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_ENTRY.set(key, data);
        renderEntryIndex(data);
      }catch(err){
        if (CACHE_ENTRY.has(key)){
          renderEntryIndex(CACHE_ENTRY.get(key));
          el("entryHint").textContent = "Using cached market entry index to avoid rate-limits.";
        } else {
          renderEntryIndex(null);
        }
      }
    }

    function renderSnapshot(payload){
      const sp = payload?.sp500 || {};
      const vix = payload?.vix || {};
      const fg = payload?.fearGreed || {};
      const errs = Array.isArray(payload?.errors) ? payload.errors : [];

      const fmtPct = (x) => {
        if (x === null || x === undefined || isNaN(Number(x))) return "—";
        const n = Number(x);
        const s = n > 0 ? "+" : "";
        return `${s}${n.toFixed(2)}%`;
      };

      const fgScore = fg?.score;
      const fgRating = fg?.rating;

      el("snapKpiSPY").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">S&P proxy</div>
            <div class="kpiValue">${sp?.last ? sp.last : "—"}</div>
          </div>
          <span class="kpiBadge badgeNeu">${sp?.symbol || "SPY"}</span>
        </div>
        <div class="kpiSub">
          1D: <strong>${fmtPct(sp?.ret1dPct)}</strong> · 5D: <strong>${fmtPct(sp?.ret5dPct)}</strong> · 1M: <strong>${fmtPct(sp?.ret1mPct)}</strong>
        </div>
      `;

      el("snapKpiVIX").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Volatility</div>
            <div class="kpiValue">${vix?.last ? vix.last : "—"}</div>
          </div>
          <span class="kpiBadge badgeNeu">${vix?.symbol || "^VIX"}</span>
        </div>
        <div class="kpiSub">
          1D change: <strong>${(vix?.chg1d !== null && vix?.chg1d !== undefined) ? (Number(vix.chg1d) > 0 ? "+" : "") + Number(vix.chg1d).toFixed(2) : "—"}</strong>
        </div>
      `;

      const fgBadge = (typeof fgScore === "number")
        ? (fgScore >= 60 ? "badgePos" : fgScore <= 40 ? "badgeNeg" : "badgeNeu")
        : "badgeNeu";

      el("snapKpiFG").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Fear & greed</div>
            <div class="kpiValue">${(typeof fgScore === "number") ? fgScore : "—"}</div>
          </div>
          <span class="kpiBadge ${fgBadge}">${fgRating || "External index"}</span>
        </div>
        <div class="kpiSub">
          Best effort fetch. If blank, provider may be blocked.
        </div>
      `;

      el("snapHint").textContent = errs.length ? ("Snapshot issues: " + errs.slice(0,2).join(" | ")) : "Market snapshot loaded.";
    }

    async function loadMarketSnapshot(force){
      const now = Date.now();
      if (CACHE_SNAPSHOT && !force){
        renderSnapshot(CACHE_SNAPSHOT);
        return;
      }
      if (force && (now - CACHE_SNAPSHOT_TS) < HARD_REFRESH_COOLDOWN_MS && CACHE_SNAPSHOT){
        renderSnapshot(CACHE_SNAPSHOT);
        el("snapHint").textContent = "Using cached snapshot to avoid rate-limits.";
        return;
      }

      const url = MARKET_SNAPSHOT_URL();
      el("snapHint").textContent = `Loading from: ${url}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_SNAPSHOT = data;
        CACHE_SNAPSHOT_TS = Date.now();
        renderSnapshot(data);
      }catch(err){
        if (CACHE_SNAPSHOT){
          renderSnapshot(CACHE_SNAPSHOT);
          el("snapHint").textContent = "Snapshot fetch failed. Showing cached snapshot.";
        } else {
          el("snapHint").textContent = "Could not load market snapshot. Confirm backend has /market/snapshot and CORS allows this origin.";
        }
      }
    }

    function normalizeList(arr){ return Array.isArray(arr) ? arr.slice() : []; }

    function congressScore(x){
      return Number(x.demBuyers||0)+Number(x.repBuyers||0)+Number(x.demSellers||0)+Number(x.repSellers||0);
    }
    function bipartisanScore(x){
      const dem = Number(x.demBuyers||0)+Number(x.repBuyers||0);
      const rep = Number(x.demSellers||0)+Number(x.repSellers||0);
      return Math.min(dem, rep);
    }
    function sortByCongressStrength(a,b){
      const ta = congressScore(a), tb = congressScore(b);
      if (ta !== tb) return tb - ta;
      const ba = bipartisanScore(a), bb = bipartisanScore(b);
      if (ba !== bb) return bb - ba;
      return String(a.ticker||"").localeCompare(String(b.ticker||""), undefined, {sensitivity:"base"});
    }
    function netFlow(x){
      const buys = Number(x.demBuyers||0) + Number(x.repBuyers||0);
      const sells = Number(x.demSellers||0) + Number(x.repSellers||0);
      return buys - sells;
    }
    function confidenceLabel(x){
      const t = congressScore(x);
      if (t >= 6) return "STRONG";
      if (t >= 3) return "MOD";
      return "WEAK";
    }
    function confidenceBadgeClass(lbl){
      if (lbl === "STRONG") return "badgePos";
      if (lbl === "MOD") return "badgeNeu";
      return "badgeNeu";
    }

    function cardHTML(x, mode){
      const ticker = String(x.ticker||"").toUpperCase();
      const who = String(x.companyName||"").trim();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";

      const dem = mode === "BUY" ? Number(x.demBuyers||0) : Number(x.demSellers||0);
      const rep = mode === "BUY" ? Number(x.repBuyers||0) : Number(x.repSellers||0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                ${who ? `<div class="who">${who}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${mode === "BUY" ? `<span class="tag tagBuy">BUY</span>` : `<span class="tag tagSell">SELL</span>`}
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function overlapCardHTML(x){
      const ticker = String(x.ticker||"").toUpperCase();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";
      const dem = Number(x.demBuyers||0);
      const rep = Number(x.repBuyers||0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                <div class="who">Bipartisan overlap (BUY)</div>
              </div>
            </div>
            <div class="tags">
              <span class="tag tagBoth">OVERLAP</span>
              <span class="tag tagBuy">BUY</span>
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Filed: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function topBy(arr, scoreFn, n){
      const a = normalizeList(arr).slice();
      a.sort((x,y) => (scoreFn(y) - scoreFn(x)) || String(x.ticker||"").localeCompare(String(y.ticker||""), undefined, {sensitivity:"base"}));
      return a.slice(0, n);
    }

    function renderCongressTradeSections(data){
      const win = Number(data.windowDays || WINDOW_DAYS || 30);
      el("kpiTitle").textContent = `Congress activity dashboard (rolling ${win} days)`;
      el("convTitle").textContent = `Convergence (bipartisan overlap on BUY, rolling ${win} days)`;
      el("partTitle").textContent = `Trades by participation (rolling ${win} days)`;
      el("mainHint").textContent = `Sorted by participation within ${win}D. Tap a ticker for chart.`;

      const convergence = normalizeList(data.convergence).sort(sortByCongressStrength);
      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers).sort(sortByCongressStrength);
      const sells = normalizeList(data.politicianSells).sort(sortByCongressStrength);

      const merged = new Map();
      function addCard(x){
        const t = String(x.ticker||"").toUpperCase();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0 };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        merged.set(t, cur);
      }
      buys.forEach(addCard);
      sells.forEach(addCard);
      const mergedArr = Array.from(merged.values());

      const topNet = topBy(mergedArr, x => netFlow(x), 5);
      el("kpiNet").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Net flow</div>
            <div class="kpiValue">Buys - Sells</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Highest accumulation or distribution in this window.</div>
        <div class="kpiList">
          ${topNet.map(x => {
            const nf = netFlow(x);
            const cls = nf > 0 ? "badgePos" : nf < 0 ? "badgeNeg" : "badgeNeu";
            const sign = nf > 0 ? "+" : "";
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${sign}${nf}</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="subtle">No data</span></div>`}
        </div>
      `;

      const topPart = topBy(mergedArr, x => congressScore(x), 5);
      el("kpiPart").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Participation</div>
            <div class="kpiValue">Total activity</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Most active tickers in this window.</div>
        <div class="kpiList">
          ${topPart.map(x => {
            const total = congressScore(x);
            const lbl = confidenceLabel(x);
            const cls = confidenceBadgeClass(lbl);
            return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${lbl} · ${total}</span></div>`;
          }).join("") || `<div class="kpiRow"><span class="subtle">No data</span></div>`}
        </div>
      `;

      const topConv = convergence.length ? convergence[0] : null;
      el("kpiHighlights").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Quick read</div>
            <div class="kpiValue">Top overlap</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Highest bipartisan overlap on BUY.</div>
        <div class="kpiList">
          <div class="kpiRow">
            <span class="subtle">Overlap</span>
            ${topConv ? `<a href="#stock=${String(topConv.ticker||"").toUpperCase()}"><strong>${String(topConv.ticker||"").toUpperCase()}</strong></a>` : `<span class="subtle">None</span>`}
          </div>
        </div>
      `;

      el("convergenceList").innerHTML =
        convergence.length ? convergence.map(overlapCardHTML).join("") : "<div class='subtle'>No overlap tickers in this window.</div>";

      el("buyList").innerHTML =
        buys.length ? buys.map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No buys found.</div>";

      el("sellList").innerHTML =
        sells.length ? sells.map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No sells found.</div>";
    }

    function holdingsRowHTML(item){
      const t = String(item.ticker || "").toUpperCase();
      const holders = Number(item.holders ?? 0);
      return `
        <div class="holdingsItem">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${encodeURIComponent(t)}">${t}</a>
                <span class="kpiBadge badgeNeu">Holders: <strong>${holders}</strong></span>
              </div>
              <div class="who">Popularity list (idea discovery)</div>
            </div>
            <div class="tags">
              <span class="tag tagSEC">HOLDINGS</span>
            </div>
          </div>
          ${tickerLinksHTML(t)}
        </div>
      `;
    }

    function renderHoldingsCommon(payload){
      const win = Number(payload?.windowDays || 365);
      el("holdingsWindowBadge").textContent = `${win}D`;

      const list = Array.isArray(payload?.commonHoldings) ? payload.commonHoldings : [];

      if (!list.length){
        el("holdingsKpiSimple").innerHTML = `
          <div class="kpiTop">
            <div>
              <div class="kpiTitle">Holdings</div>
              <div class="kpiValue">No data</div>
            </div>
            <span class="kpiBadge badgeNeu">${win}D</span>
          </div>
          <div class="kpiSub">
            Backend must return JSON with <span class="mono">commonHoldings</span>.
          </div>
        `;
        el("holdingsList").innerHTML = "<div class='subtle'>No holdings data returned.</div>";
        el("holdingsHint").textContent = "If you see this, the backend endpoint is missing, failing, or blocked by CORS.";
        return;
      }

      const sorted = list.slice()
        .map(x => ({ ticker: x.ticker, holders: Number(x.holders||0) }))
        .filter(x => x.ticker)
        .sort((a,b) => (b.holders - a.holders) || String(a.ticker).localeCompare(String(b.ticker)));

      const top = sorted[0];

      el("holdingsKpiSimple").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top holding</div>
            <div class="kpiValue">${top ? String(top.ticker).toUpperCase() : "—"}</div>
          </div>
          <span class="kpiBadge badgeNeu">${win}D</span>
        </div>
        <div class="kpiSub">Keep this list as idea discovery. Not a timing signal.</div>
        <div class="kpiList">
          ${sorted.slice(0,5).map(x => `
            <div class="kpiRow">
              <a href="#stock=${encodeURIComponent(String(x.ticker).toUpperCase())}"><strong>${String(x.ticker).toUpperCase()}</strong></a>
              <span class="kpiBadge badgeNeu">${Number(x.holders||0)} holders</span>
            </div>
          `).join("")}
        </div>
      `;

      el("holdingsList").innerHTML = sorted.map(holdingsRowHTML).join("");
      el("holdingsHint").textContent = "Simple view: ticker + holders.";
    }

    async function loadHoldingsCommon(windowDays, force){
      const key = String(windowDays || 365);
      if (CACHE_HOLDINGS.has(key) && !force){
        renderHoldingsCommon(CACHE_HOLDINGS.get(key));
        return;
      }

      const url = HOLDINGS_URL(windowDays || 365);
      el("holdingsList").innerHTML = "<div class='subtle'>Loading holdings…</div>";
      el("holdingsHint").textContent = `Loading from: ${url}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_HOLDINGS.set(key, data);
        renderHoldingsCommon(data);
      }catch(err){
        renderHoldingsCommon({ windowDays: windowDays || 365, commonHoldings: [] });
        el("holdingsHint").textContent = "Could not load holdings. Confirm backend has /report/holdings/common and CORS allows this origin.";
      }
    }

    function partyTag(p){
      const s = String(p||"").toUpperCase();
      if (s === "D") return `<span class="tag tagDem">DEM</span>`;
      if (s === "R") return `<span class="tag tagRep">GOP</span>`;
      return `<span class="tag badgeNeu">?</span>`;
    }

    function dailyItemHTML(it){
      const kind = String(it.kind||"").toUpperCase();
      const t = String(it.ticker||"").toUpperCase();
      const who = String(it.politician||"").trim();
      const chamber = String(it.chamber||"").trim();
      const amt = String(it.amountRange||"").trim();
      const traded = String(it.traded||"");
      const filed = String(it.filed||"");
      const desc = String(it.description||"").trim();

      const links = it.links || {};
      const capPol = links.capitoltrades_politician || "";
      const capTick = links.capitoltrades_ticker || "";

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                ${t ? `<a class="ticker" href="#stock=${encodeURIComponent(t)}">${t}</a>` : `<div class="ticker">N/A</div>`}
                <div class="who">${who}${chamber ? " · " + chamber : ""}</div>
              </div>
            </div>
            <div class="tags">
              ${kind === "BUY" ? `<span class="tag tagBuy">BUY</span>` : `<span class="tag tagSell">SELL</span>`}
              ${partyTag(it.party)}
              <span class="tag tagSEC">DISCLOSURE</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              ${amt ? `<div class="countItem">Amount: <strong>${amt}</strong></div>` : ""}
              ${traded ? `<div class="countItem">Traded: <strong>${traded}</strong></div>` : ""}
              ${filed ? `<div class="countItem">Filed: <strong>${filed}</strong></div>` : ""}
            </div>
          </div>

          ${desc ? `
            <div class="metaRow">
              <div style="max-width:900px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${desc}
              </div>
            </div>
          ` : ""}

          <div class="miniLinks">
            ${capPol ? `<a class="miniLink" href="${capPol}" target="_blank" rel="noopener">CapitolTrades: ${who || "Politician"}</a>` : ""}
            ${capTick ? `<a class="miniLink" href="${capTick}" target="_blank" rel="noopener">CapitolTrades: ${t || "Ticker"}</a>` : ""}
            <a class="miniLink" href="https://www.quiverquant.com/congresstrading/" target="_blank" rel="noopener">QuiverQuant</a>
            <a class="miniLink" href="https://efdsearch.senate.gov/search/home/" target="_blank" rel="noopener">Senate EFD</a>
            <a class="miniLink" href="https://disclosures-clerk.house.gov/" target="_blank" rel="noopener">House</a>
          </div>
        </div>
      `;
    }

    function renderDaily(payload){
      const days = Array.isArray(payload?.days) ? payload.days : [];
      if (!days.length){
        el("dailyTradeList").innerHTML = "<div class='subtle'>No daily trades returned for this window.</div>";
        el("dailyHint").textContent = "If this is empty, try 180D or 365D.";
        return;
      }

      el("dailyTradeList").innerHTML = days.map(d => {
        const items = Array.isArray(d.items) ? d.items : [];
        return `
          <div class="sectionTitle">${d.date}</div>
          ${items.map(dailyItemHTML).join("")}
        `;
      }).join("");

      el("dailyHint").textContent = "This is the detailed day-by-day activity feed.";
    }

    async function loadDaily(windowDays, force){
      const key = String(windowDays || 30);
      if (CACHE_DAILY.has(key) && !force){
        renderDaily(CACHE_DAILY.get(key));
        return;
      }

      const url = DAILY_URL(windowDays || 30);
      el("dailyTradeList").innerHTML = "<div class='subtle'>Loading daily feed…</div>";
      el("dailyHint").textContent = `Loading from: ${url}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_DAILY.set(key, data);
        renderDaily(data);
      }catch(err){
        renderDaily({ days: [] });
        el("dailyHint").textContent = "Could not load daily feed. Confirm backend has /report/congress/daily and CORS allows this origin.";
      }
    }

    const DIRECT_COIN_SET = new Set(["BTC","ETH","SOL","LINK","XRP","ADA","DOGE","AVAX","MATIC","BNB"]);
    const CRYPTO_LINKED_TICKERS = new Set([
      "COIN","MSTR","RIOT","MARA","HUT","CLSK","SQ","PYPL",
      "IBIT","FBTC","GBTC","BITO","ARKB","BTCO","HODL","BITB",
      "ETHE","ETHA","WGMI","BKCH","BLOK","BITQ","DAPP"
    ]);

    function coinsToLabel(coins){
      const arr = Array.isArray(coins) ? coins.map(x => String(x||"").toUpperCase()).filter(Boolean) : [];
      if (!arr.length) return "CRYPTO";
      return arr.join(" · ");
    }

    function cryptoCardHTML(r){
      const kind = String(r.kind || "").toUpperCase();
      const who = String(r.politician || "").trim();
      const chamber = String(r.chamber || "").trim();
      const amt = String(r.amountRange || "").trim();
      const traded = String(r.traded || "");
      const filed = String(r.filed || "");
      const desc = String(r.description || "").trim();
      const sym = coinsToLabel(r.coins);
      const type = String(r.cryptoKind || "").trim();

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <div class="ticker">${sym}</div>
                ${who ? `<div class="who">${who}${chamber ? " · " + chamber : ""}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${kind === "BUY" ? `<span class="tag tagBuy">BUY</span>` : kind === "SELL" ? `<span class="tag tagSell">SELL</span>` : `<span class="tag badgeNeu">${kind || "TX"}</span>`}
              ${partyTag(r.party)}
              ${type ? `<span class="tag badgeNeu">${type}</span>` : ""}
            </div>
          </div>

          <div class="divider"></div>

          ${desc ? `
            <div class="metaRow">
              <div style="max-width:820px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${desc}
              </div>
            </div>
          ` : ""}

          <div class="metaRow">
            <div class="counts">
              ${amt ? `<div class="countItem">Amount: <strong>${amt}</strong></div>` : ""}
              ${traded ? `<div class="countItem">Traded: <strong>${traded}</strong></div>` : ""}
              ${filed ? `<div class="countItem">Filed: <strong>${filed}</strong></div>` : ""}
            </div>
          </div>
        </div>
      `;
    }

    function renderCryptoFromMain(data){
      const win = Number(data.windowDays || WINDOW_DAYS || 30);
      el("cryptoTitle").textContent = `Crypto disclosures (rolling ${win} days)`;

      const crypto = (data && data.crypto && typeof data.crypto === "object") ? data.crypto : {};
      const raw = normalizeList(crypto.raw);

      const direct = raw.filter(x => {
        const coins = Array.isArray(x.coins) ? x.coins.map(c => String(c||"").toUpperCase()) : [];
        return coins.some(c => DIRECT_COIN_SET.has(c));
      });

      const directBuys = direct.filter(x => String(x.kind||"").toUpperCase() === "BUY");
      const directSells = direct.filter(x => String(x.kind||"").toUpperCase() === "SELL");

      el("cryptoDirectBuys").innerHTML =
        directBuys.length ? directBuys.slice(0,80).map(cryptoCardHTML).join("") : "<div class='subtle'>No direct crypto buys in this window.</div>";

      el("cryptoDirectSells").innerHTML =
        directSells.length ? directSells.slice(0,80).map(cryptoCardHTML).join("") : "<div class='subtle'>No direct crypto sells in this window.</div>";

      const hintOnly = raw.filter(x => {
        const ck = String(x.cryptoKind||"");
        const coins = Array.isArray(x.coins) ? x.coins.map(c => String(c||"").toUpperCase()) : [];
        const hasSymbol = coins.some(c => DIRECT_COIN_SET.has(c));
        const isGeneric = coins.includes("CRYPTO") && !hasSymbol;
        return ck === "hint_only" || isGeneric;
      });

      el("cryptoHintOnly").innerHTML =
        hintOnly.length ? hintOnly.slice(0,120).map(cryptoCardHTML).join("") : "<div class='subtle'>No hint-only crypto disclosures in this window.</div>";

      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers);
      const sells = normalizeList(data.politicianSells);
      const all = buys.concat(sells);

      const linked = all
        .map(x => ({
          ticker: String(x.ticker||"").toUpperCase(),
          companyName: String(x.companyName||""),
          demBuyers: Number(x.demBuyers||0),
          repBuyers: Number(x.repBuyers||0),
          demSellers: Number(x.demSellers||0),
          repSellers: Number(x.repSellers||0),
          lastFiledAt: x.lastFiledAt
        }))
        .filter(x => x.ticker && CRYPTO_LINKED_TICKERS.has(x.ticker))
        .sort(sortByCongressStrength);

      el("cryptoLinkedTickers").innerHTML =
        linked.length ? linked.map(x => cardHTML(x, (Number(x.demBuyers||0)+Number(x.repBuyers||0)) >= (Number(x.demSellers||0)+Number(x.repSellers||0)) ? "BUY" : "SELL")).join("")
                      : "<div class='subtle'>No crypto-linked ticker activity in this window.</div>";

      el("cryptoHint").textContent =
        `Showing direct, hint-only, and crypto-linked. If 30D looks empty, switch to 180D or 365D.`;
    }

    function cryptoHeadlineHTML(h){
      const title = String(h?.title || "").trim();
      const link = String(h?.link || "").trim();
      const pub = String(h?.published || "").trim();
      const src = String(h?.source || h?.bucket || "").trim();

      return `
        <div class="headlineItem">
          <div class="headlineTitle">${link ? `<a href="${link}" target="_blank" rel="noopener">${title}</a>` : title}</div>
          <div class="headlineMeta">
            ${pub ? `<span>Published: <strong>${pub}</strong></span>` : ""}
            ${src ? `<span>Source: <strong>${src}</strong></span>` : ""}
          </div>
        </div>
      `;
    }

    function renderCryptoNews(data, coinsStr){
      const date = String(data?.date || "");
      const note = String(data?.note || "");
      const errors = Array.isArray(data?.errors) ? data.errors : [];
      const sources = (data?.sources && Array.isArray(data.sources.outlets)) ? data.sources.outlets : [];

      const overall = data?.overallSentiment || { label: "NEUTRAL", score: 50 };
      const cls = (overall.score >= 60) ? "badgePos" : (overall.score <= 40) ? "badgeNeg" : "badgeNeu";

      const coins = Array.isArray(data?.coins) ? data.coins : [];
      const catalysts = Array.isArray(data?.catalysts) ? data.catalysts : [];

      el("cryptoNewsKpiOverall").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Overall crypto tone</div>
            <div class="kpiValue">${Number(overall.score || 50)}/100</div>
          </div>
          <span class="kpiBadge ${cls}">${String(overall.label || "NEUTRAL")}</span>
        </div>
        <div class="kpiSub">Headline-based gauge for context.</div>
        <div class="kpiList">
          <div class="kpiRow"><span>Date</span><span class="kpiBadge badgeNeu">${date || "—"}</span></div>
        </div>
      `;

      el("cryptoNewsKpiScope").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Scope</div>
            <div class="kpiValue">${coins.length} coins</div>
          </div>
          <span class="kpiBadge badgeNeu">Top list</span>
        </div>
        <div class="kpiSub">Requested: ${String(coinsStr || "").toUpperCase()}</div>
        <div class="kpiList">
          <div class="kpiRow"><span>Sources</span><span class="kpiBadge badgeNeu">${sources.length ? sources.length : "RSS"}</span></div>
        </div>
      `;

      el("cryptoNewsKpiNotes").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Notes</div>
            <div class="kpiValue">Catalysts</div>
          </div>
          <span class="kpiBadge badgeNeu">Briefing</span>
        </div>
        <div class="kpiSub">
          ${note ? note : "Crypto news briefing."}
        </div>
      `;

      el("cryptoCatalystsList").innerHTML = catalysts.length
        ? catalysts.map(x => `<li>${String(x||"")}</li>`).join("")
        : "<li>No catalysts returned.</li>";

      el("cryptoNewsCoins").innerHTML = coins.length
        ? coins.map(c => {
            const sym = String(c?.symbol || c?.coin || "").toUpperCase();
            const s = c?.sentiment || { label: "NEUTRAL", score: 50 };
            const scls = (s.score >= 60) ? "badgePos" : (s.score <= 40) ? "badgeNeg" : "badgeNeu";
            const summary = String(c?.summary || "").trim();
            const heads = Array.isArray(c?.headlines) ? c.headlines : [];

            const meta = [];
            meta.push(`${heads.length} headlines`);
            meta.push(`Sentiment ${Number(s.score || 50)}/100`);
            const metaLine = meta.join(" · ");

            return `
              <details class="cryptoDetails">
                <summary>
                  <div class="summaryLeft">
                    <div class="summaryTitle">${sym || "COIN"}</div>
                    <div class="summaryMeta">${metaLine}${summary ? " · " + summary : ""}</div>
                  </div>
                  <div class="tags">
                    <span class="kpiBadge badgeNeu">${heads.length}</span>
                    <span class="kpiBadge ${scls}">${String(s.label || "NEUTRAL")} · ${Number(s.score || 50)}</span>
                  </div>
                </summary>

                <div class="divider"></div>
                <div class="kpiSub">
                  <strong>Today’s read:</strong> ${summary || "No summary available."}
                </div>

                <div class="divider"></div>
                <div class="kpiSub"><strong>Headlines:</strong></div>
                <div class="headlineList">
                  ${heads.length ? heads.map(cryptoHeadlineHTML).join("") : "<div class='subtle'>No headlines returned.</div>"}
                </div>
              </details>
            `;
          }).join("")
        : "<div class='subtle'>No coins returned.</div>";

      el("cryptoNewsHint").textContent = errors.length
        ? ("Some crypto feeds failed: " + errors.slice(0, 3).join(" | "))
        : "Crypto news briefing loaded.";
    }

    async function loadCryptoNews(coinsStr, force){
      const key = String(coinsStr || "").trim().toUpperCase() || "BTC,ETH,LINK,SHIB";
      if (CACHE_CRYPTO_NEWS.has(key) && !force){
        renderCryptoNews(CACHE_CRYPTO_NEWS.get(key), key);
        return;
      }

      const url = CRYPTO_NEWS_URL(key, 15);
      el("cryptoNewsHint").textContent = `Loading from: ${url}`;
      el("cryptoNewsCoins").innerHTML = "<div class='subtle'>Loading crypto news briefing…</div>";

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_CRYPTO_NEWS.set(key, data);
        renderCryptoNews(data, key);
      }catch(err){
        if (CACHE_CRYPTO_NEWS.has(key)){
          renderCryptoNews(CACHE_CRYPTO_NEWS.get(key), key);
          el("cryptoNewsHint").textContent = "Crypto news fetch failed. Showing cached briefing.";
        } else {
          el("cryptoNewsCoins").innerHTML = "<div class='subtle'>Could not load crypto briefing.</div>";
          el("cryptoNewsHint").textContent = "Backend must expose /crypto/news/briefing and allow CORS.";
        }
      }
    }

    function renderMain(payload){
      const win = Number(payload.windowDays || WINDOW_DAYS || 30);
      el("reportDate").textContent = payload.date ? `${payload.date} · window ${win}D` : `window ${win}D`;
      handleHash();
    }

    async function loadMain(force){
      const key = String(WINDOW_DAYS);
      const cached = CACHE_MAIN.get(key);

      if (cached && !force){
        setStatus("ok", "Using cached congress data ✅", "");
        if (ACTIVE_TAB === "Main") renderMain(cached);
        if (ACTIVE_TAB === "Crypto") renderCryptoFromMain(cached);
        if (ACTIVE_TAB === "Congress") renderCongressTradeSections(cached);
        return;
      }

      const url = TODAY_URL(WINDOW_DAYS);
      setStatus("", `Loading congress (rolling ${WINDOW_DAYS}D)…`, url);

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);

        CACHE_MAIN.set(key, data);
        setStatus("ok", "Live congress data loaded ✅", "");

        if (ACTIVE_TAB === "Main") renderMain(data);
        if (ACTIVE_TAB === "Crypto") renderCryptoFromMain(data);
        if (ACTIVE_TAB === "Congress") renderCongressTradeSections(data);
      }catch(err){
        setStatus("err", "Could not load congress data", String(err));
      }
    }

    function sentimentBadge(s){
      const score = Number(s?.score ?? 50);
      const label = String(s?.label ?? "NEUTRAL");
      if (score >= 60) return { cls: "badgePos", label: label, score };
      if (score <= 40) return { cls: "badgeNeg", label: label, score };
      return { cls: "badgeNeu", label: label, score };
    }

    function normalizeNewsErrors(err){
      if (!err) return [];
      if (Array.isArray(err)) return err.filter(Boolean).map(String);
      if (typeof err === "object"){
        const out = [];
        for (const k of Object.keys(err)){
          const v = err[k];
          if (Array.isArray(v)) out.push(...v.filter(Boolean).map(String));
          else if (v) out.push(String(v));
        }
        return out;
      }
      return [String(err)];
    }

    function normalizeSectorHeadlines(s){
      if (!s || typeof s !== "object") return [];
      if (Array.isArray(s.headlines)) return s.headlines;
      if (Array.isArray(s.topHeadlines)) return s.topHeadlines;
      return [];
    }

    function normalizeImplications(s){
      if (!s || typeof s !== "object") return [];
      if (Array.isArray(s.implications_2_12_weeks)) return s.implications_2_12_weeks.filter(Boolean).map(String);
      if (Array.isArray(s.implications)) return s.implications.filter(Boolean).map(String);
      if (typeof s.implications === "string" && s.implications.trim()) return [s.implications.trim()];
      return [];
    }

    function headlineHTML(h){
      const title = String(h?.title || "").trim();
      const link = String(h?.link || "").trim();
      const pub = String(h?.published || "").trim();
      const bucket = String(h?.bucket || h?.sourceFeed || h?.source || "").trim();

      return `
        <div class="headlineItem">
          <div class="headlineTitle">${link ? `<a href="${link}" target="_blank" rel="noopener">${title}</a>` : title}</div>
          <div class="headlineMeta">
            ${pub ? `<span>Published: <strong>${pub}</strong></span>` : ""}
            ${bucket ? `<span>Source: <strong>${bucket}</strong></span>` : ""}
          </div>
        </div>
      `;
    }

    function sectorPanelHTML(s){
      const sector = String(s?.sector || "General");
      const sent = sentimentBadge(s?.sentiment);
      const summary = String(s?.summary || "").trim();

      const headlines = normalizeSectorHeadlines(s);
      const implications = normalizeImplications(s);

      const meta = [];
      meta.push(`${headlines.length} headlines`);
      if (typeof sent.score === "number") meta.push(`Sentiment ${sent.score}/100`);
      const metaLine = meta.join(" · ");

      return `
        <details class="briefingDetails">
          <summary>
            <div class="summaryLeft">
              <div class="summaryTitle">${sector}</div>
              <div class="summaryMeta">${metaLine}${summary ? " · " + summary : ""}</div>
            </div>
            <div class="tags">
              <span class="kpiBadge badgeNeu">${headlines.length}</span>
              <span class="kpiBadge ${sent.cls}">${sent.label} · ${sent.score}</span>
            </div>
          </summary>

          <div class="divider"></div>

          <div class="kpiSub">
            <strong>Today’s read:</strong> ${summary || "No summary available."}
          </div>

          <div class="divider"></div>

          <div class="kpiSub"><strong>Implications (next 2 to 12 weeks):</strong></div>
          <ul class="bulletList">
            ${implications.length ? implications.map(x => `<li>${x}</li>`).join("") : "<li>No implications generated.</li>"}
          </ul>

          <div class="divider"></div>

          <div class="kpiSub"><strong>Headlines:</strong></div>
          <div class="headlineList">
            ${headlines.length ? headlines.map(headlineHTML).join("") : "<div class='subtle'>No headlines in this sector.</div>"}
          </div>
        </details>
      `;
    }

    function renderBriefing(data, watchlist){
      const overall = sentimentBadge(data?.overallSentiment);
      const sectors = Array.isArray(data?.sectors) ? data.sectors : [];
      const date = String(data?.date || "");
      const note = String(data?.note || "");

      const total = sectors.reduce((a, s) => a + normalizeSectorHeadlines(s).length, 0);

      el("briefKpiSentiment").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Overall sentiment</div>
            <div class="kpiValue">${overall.score}/100</div>
          </div>
          <span class="kpiBadge ${overall.cls}">${overall.label}</span>
        </div>
        <div class="kpiSub">
          Headline-based gauge. Use for context, not timing.
        </div>
        <div class="kpiList">
          <div class="kpiRow"><span>Date</span><span class="kpiBadge badgeNeu">${date || "—"}</span></div>
        </div>
      `;

      el("briefKpiScope").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Briefing scope</div>
            <div class="kpiValue">${total} headlines</div>
          </div>
          <span class="kpiBadge badgeNeu">Sectors</span>
        </div>
        <div class="kpiSub">
          Watchlist: ${String(watchlist||"").split(",").filter(x => x.trim()).length} tickers
        </div>
        <div class="kpiList">
          <div class="kpiRow"><span>Sectors</span><span class="kpiBadge badgeNeu">${sectors.length}</span></div>
        </div>
      `;

      el("briefKpiNotes").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Notes</div>
            <div class="kpiValue">RSS</div>
          </div>
          <span class="kpiBadge badgeNeu">Backend</span>
        </div>
        <div class="kpiSub">
          ${note ? note : "Daily briefing."}
        </div>
      `;

      el("briefingSectors").innerHTML = sectors.length
        ? sectors.map(sectorPanelHTML).join("")
        : "<div class='subtle'>No sectors returned.</div>";

      const errAll = normalizeNewsErrors(data?.errors);
      el("briefHint").textContent = errAll.length
        ? ("Some feeds failed: " + errAll.slice(0, 3).join(" | "))
        : "Daily briefing loaded.";
    }

    async function loadBriefing(watchlist, force){
      const key = String(watchlist || "").trim();
      if (CACHE_BRIEFING.has(key) && !force){
        renderBriefing(CACHE_BRIEFING.get(key), key);
        return;
      }

      const url = NEWS_BRIEF_URL(key);
      el("briefingSectors").innerHTML = "<div class='subtle'>Loading daily briefing…</div>";
      el("briefHint").textContent = `Loading from: ${url}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_BRIEFING.set(key, data);
        renderBriefing(data, key);
      }catch(err){
        if (CACHE_BRIEFING.has(key)){
          renderBriefing(CACHE_BRIEFING.get(key), key);
          el("briefHint").textContent = "Briefing fetch failed. Showing cached briefing.";
        } else {
          el("briefingSectors").innerHTML = "<div class='subtle'>Could not load briefing.</div>";
          el("briefHint").textContent = "Backend must expose /news/briefing and allow CORS.";
          el("briefKpiSentiment").innerHTML = "";
          el("briefKpiScope").innerHTML = "";
          el("briefKpiNotes").innerHTML = "";
        }
      }
    }

    function showTab(tab){
      ACTIVE_TAB = tab;
      setTitleForTab(tab);

      el("viewMain").style.display = tab === "Main" ? "" : "none";
      el("viewNews").style.display = tab === "News" ? "" : "none";
      el("viewCongress").style.display = tab === "Congress" ? "" : "none";
      el("viewCrypto").style.display = tab === "Crypto" ? "" : "none";
      el("viewPerf").style.display = tab === "Performance" ? "" : "none";

      el("tabMainBtn").classList.toggle("tabBtnActive", tab === "Main");
      el("tabNewsBtn").classList.toggle("tabBtnActive", tab === "News");
      el("tabCongressBtn").classList.toggle("tabBtnActive", tab === "Congress");
      el("tabCryptoBtn").classList.toggle("tabBtnActive", tab === "Crypto");
      el("tabPerfBtn").classList.toggle("tabBtnActive", tab === "Performance");

      el("navMain").classList.toggle("tabBottomActive", tab === "Main");
      el("navNews").classList.toggle("tabBottomActive", tab === "News");
      el("navCongress").classList.toggle("tabBottomActive", tab === "Congress");
      el("navCrypto").classList.toggle("tabBottomActive", tab === "Crypto");
      el("navPerf").classList.toggle("tabBottomActive", tab === "Performance");

      el("mainWindowTools").style.display = (tab === "Congress" || tab === "Crypto") ? "" : "none";

      if (tab === "Main"){
        loadMain(false);
        loadEntryIndex(365, false);
      }
      if (tab === "News"){
        loadMarketSnapshot(false);
        loadBriefing(el("watchInput").value, false);
      }
      if (tab === "Congress"){
        loadMain(false);
        loadHoldingsCommon(365, false);
        loadDaily(WINDOW_DAYS, false);
      }
      if (tab === "Crypto"){
        loadMain(false);
        loadCryptoNews(el("cryptoCoinsInput").value, false);
      }

      handleHash();
    }

    function setWindow(days){
      WINDOW_DAYS = days;
      el("btn30").classList.toggle("on", WINDOW_DAYS === 30);
      el("btn180").classList.toggle("on", WINDOW_DAYS === 180);
      el("btn365").classList.toggle("on", WINDOW_DAYS === 365);

      if (ACTIVE_TAB === "Congress" || ACTIVE_TAB === "Crypto"){
        loadMain(false);
      }
      if (ACTIVE_TAB === "Congress"){
        loadDaily(WINDOW_DAYS, false);
      }
    }

    function handleRefresh(){
      const now = Date.now();
      const inCooldown = (now - LAST_HARD_REFRESH_MS) < HARD_REFRESH_COOLDOWN_MS;

      CACHE_MAIN.delete(String(WINDOW_DAYS));
      CACHE_DAILY.delete(String(WINDOW_DAYS));

      if (!inCooldown){
        CACHE_BRIEFING.clear();
        CACHE_CRYPTO_NEWS.clear();
        LAST_HARD_REFRESH_MS = now;
      }

      if (inCooldown){
        setStatus("ok", "Using cached market data to avoid rate-limits ✅", `Cooldown ${Math.ceil((HARD_REFRESH_COOLDOWN_MS - (now - LAST_HARD_REFRESH_MS))/1000)}s`);
      } else {
        setStatus("", "Refreshing (rate-limit safe)…", "");
      }

      if (ACTIVE_TAB === "Main"){
        loadMain(true);
        loadEntryIndex(365, !inCooldown);
        return;
      }
      if (ACTIVE_TAB === "News"){
        loadMarketSnapshot(!inCooldown);
        loadBriefing(el("watchInput").value, !inCooldown);
        return;
      }
      if (ACTIVE_TAB === "Congress"){
        loadMain(true);
        loadHoldingsCommon(365, true);
        loadDaily(WINDOW_DAYS, true);
        return;
      }
      if (ACTIVE_TAB === "Crypto"){
        loadMain(true);
        loadCryptoNews(el("cryptoCoinsInput").value, !inCooldown);
        return;
      }

      loadMain(true);
    }

    el("btn30").addEventListener("click", () => setWindow(30));
    el("btn180").addEventListener("click", () => setWindow(180));
    el("btn365").addEventListener("click", () => setWindow(365));

    el("tabMainBtn").addEventListener("click", () => showTab("Main"));
    el("tabNewsBtn").addEventListener("click", () => showTab("News"));
    el("tabCongressBtn").addEventListener("click", () => showTab("Congress"));
    el("tabCryptoBtn").addEventListener("click", () => showTab("Crypto"));
    el("tabPerfBtn").addEventListener("click", () => showTab("Performance"));

    el("navMain").addEventListener("click", () => showTab("Main"));
    el("navNews").addEventListener("click", () => showTab("News"));
    el("navCongress").addEventListener("click", () => showTab("Congress"));
    el("navCrypto").addEventListener("click", () => showTab("Crypto"));
    el("navPerf").addEventListener("click", () => showTab("Performance"));

    el("refreshBtn").addEventListener("click", handleRefresh);
    window.addEventListener("hashchange", handleHash);

    el("watchApplyBtn").addEventListener("click", () => {
      loadBriefing(el("watchInput").value, true);
    });

    el("snapRefreshBtn").addEventListener("click", () => {
      loadMarketSnapshot(true);
    });

    el("cryptoNewsRefreshBtn").addEventListener("click", () => {
      loadCryptoNews(el("cryptoCoinsInput").value, true);
    });

    showTab("Main");
    loadMain(false);
    loadEntryIndex(365, false);
  </script>
</body>
</html>

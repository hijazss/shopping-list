<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <meta name="theme-color" content="#0b0b0f" />
  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);

      --dem:#4aa3ff;
      --rep:#ff5a5a;
      --both:#b38bff;

      --ok:#7cffc0;
      --err:#ff8a8a;

      --pos:#7cffc0;
      --neg:#ff8a8a;

      --sec:#ffd27d;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:12px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      padding:12px 14px 8px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      max-width:1100px;
      margin:0 auto;
    }
    .h1{font-size:16px;font-weight:900;letter-spacing:.01em}
    .subtle{font-size:12px;color:var(--muted);margin-top:2px}
    .pillBtn{
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:#fff;
      font-size:12px;
      cursor:pointer;
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      padding:8px 14px 110px;
    }

    .status{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px 10px;
      margin:6px 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .status strong{color:#fff}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .tabRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 8px;
      align-items:center;
    }
    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:7px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
    }
    .tabBtnActive{
      color:#fff;
      background:rgba(255,255,255,.10);
    }

    .rightTools{
      margin-left:auto;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .seg{
      display:flex;
      border:1px solid var(--border);
      border-radius:999px;
      overflow:hidden;
      background:rgba(255,255,255,.03);
    }
    .seg button{
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      padding:7px 10px;
      cursor:pointer;
    }
    .seg .on{
      background:rgba(255,255,255,.10);
      color:#fff;
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .grid3{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 980px){
      .grid3{grid-template-columns:repeat(3,1fr);}
    }
    @media (min-width: 760px) and (max-width: 979px){
      .grid3{grid-template-columns:repeat(2,1fr);}
    }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .kpiTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom:6px;
    }
    .kpiTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .kpiValue{
      font-size:16px;
      font-weight:900;
      letter-spacing:.02em;
      margin-top:4px;
    }
    .kpiSub{
      font-size:12px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
    }
    .kpiList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:rgba(255,255,255,.90);
      align-items:center;
    }
    .kpiBadge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      color:rgba(255,255,255,.90);
    }
    .badgePos{border-color:rgba(124,255,192,.45); color:var(--pos)}
    .badgeNeg{border-color:rgba(255,138,138,.45); color:var(--neg)}
    .badgeNeu{border-color:rgba(255,255,255,.18); color:rgba(255,255,255,.85)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px 9px;
      margin-bottom:8px;
    }
    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-size:13px;
      font-weight:900;
      letter-spacing:.03em;
    }
    .who{
      font-size:12px;
      color:var(--muted);
      max-width:720px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0 7px}

    .miniLinks{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .miniLink{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      margin:10px 0 10px;
    }

    iframe{
      width:100%;
      height:360px;
      border:0;
      border-radius:12px;
      background:#000;
      margin-top:8px;
    }

    .tabsBottom{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#151522f0;
      border-top:1px solid var(--border);
      backdrop-filter:blur(12px);
    }
    .tabBarBottom{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(4,1fr);
    }
    .tabBottom{
      text-align:center;
      padding:11px 10px 16px;
      font-size:11px;
      color:var(--muted);
      user-select:none;
      cursor:pointer;
    }
    .tabBottomActive{color:#fff}

    .input{
      width:100%;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:#fff;
      border-radius:12px;
      padding:10px;
      font-size:12px;
      outline:none;
    }

    details.briefingDetails{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
      margin-top:10px;
    }
    details.briefingDetails > summary{
      cursor:pointer;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      user-select:none;
    }
    details.briefingDetails > summary::-webkit-details-marker{display:none}
    .summaryLeft{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .summaryTitle{
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .summaryMeta{
      font-size:12px;
      color:var(--muted);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:740px;
    }
    .bulletList{
      margin:8px 0 0;
      padding-left:16px;
      color:rgba(255,255,255,.86);
      line-height:1.3;
    }
    .headlineList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .headlineItem{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
      border-radius:12px;
      padding:9px;
    }
    .headlineTitle{
      font-size:12px;
      color:rgba(255,255,255,.92);
      line-height:1.25;
    }
    .headlineMeta{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="h1" id="pageTitle">News</div>
      <div class="subtle" id="reportDate"></div>
    </div>
    <button class="pillBtn" id="refreshBtn">Refresh</button>
  </header>

  <main class="container">
    <div class="status" id="statusBox">
      <strong>Status:</strong> <span id="statusText">Loading…</span><br/>
      <span class="mono" id="statusDetail"></span>
    </div>

    <div class="tabRow">
      <button class="tabBtn tabBtnActive" id="tabNewsBtn">News</button>
      <button class="tabBtn" id="tabCongressBtn">Congress</button>
      <button class="tabBtn" id="tabCryptoBtn">Crypto</button>
      <button class="tabBtn" id="tabPerfBtn">Performance</button>

      <div class="rightTools" id="mainWindowTools" style="display:none;">
        <div class="seg" aria-label="window toggle">
          <button id="btn30" class="on">30D</button>
          <button id="btn180">180D</button>
          <button id="btn365">365D</button>
        </div>
      </div>
    </div>

    <div id="stockPanel" style="display:none;"></div>

    <!-- NEWS TAB -->
    <section id="viewNews">
      <div class="sectionTitle">Daily market read</div>
      <div class="grid3">
        <div class="kpi" id="readKpiSPY"></div>
        <div class="kpi" id="readKpiQQQ"></div>
        <div class="kpi" id="readKpiFG"></div>
      </div>
      <div class="panel" style="margin-top:10px;">
        <div class="kpiSub" id="readSummary">Loading…</div>
        <div class="subtle" id="readHint" style="margin-top:8px;"></div>
        <div class="miniLinks" style="margin-top:10px;">
          <button class="pillBtn" id="readRefreshBtn">Refresh market read</button>
        </div>
      </div>

      <div class="sectionTitle">Daily briefing</div>
      <div class="grid3">
        <div class="kpi" id="briefKpiSentiment"></div>
        <div class="kpi" id="briefKpiScope"></div>
        <div class="kpi" id="briefKpiNotes"></div>
      </div>

      <div class="sectionTitle">Your watchlist</div>
      <div class="panel">
        <div class="kpiSub">
          Comma-separated tickers. Example: SPY,QQQ,NVDA,AAPL
        </div>
        <div style="margin-top:10px;">
          <input class="input" id="watchInput" value="SPY,QQQ,NVDA,AAPL,MSFT,AMZN,GOOGL,META,TSLA,BRK-B" />
        </div>
        <div class="miniLinks" style="margin-top:10px;">
          <button class="pillBtn" id="watchApplyBtn">Refresh briefing</button>
        </div>
      </div>

      <div class="sectionTitle">Sectors</div>
      <div id="briefingSectors"></div>
      <div class="subtle" id="briefHint" style="margin-top:12px;"></div>
    </section>

    <!-- CONGRESS TAB -->
    <section id="viewCongress" style="display:none;">
      <div class="panel">
        <div class="kpiSub">
          Congress tab unchanged here. If your backend is returning empty, the fix is in backend routes or CORS.
        </div>
      </div>
    </section>

    <!-- CRYPTO TAB -->
    <section id="viewCrypto" style="display:none;">
      <div class="panel">
        <div class="kpiSub">
          Crypto tab placeholder in this simplified build.
        </div>
      </div>
    </section>

    <!-- PERFORMANCE TAB -->
    <section id="viewPerf" style="display:none;">
      <div class="sectionTitle">Politician performance</div>
      <div class="panel">
        <div class="kpiSub">
          Portfolio performance inside the app needs a backend integration.
          Use these trackers plus the Congress day-by-day feed.
        </div>

        <div class="miniLinks" style="margin-top:10px;">
          <a class="miniLink" target="_blank" rel="noopener" href="https://www.capitoltrades.com/">Capitol Trades</a>
          <a class="miniLink" target="_blank" rel="noopener" href="https://www.quiverquant.com/congresstrading/">QuiverQuant Congress Trading</a>
          <a class="miniLink" target="_blank" rel="noopener" href="https://efdsearch.senate.gov/search/home/">Senate EFD Search</a>
          <a class="miniLink" target="_blank" rel="noopener" href="https://disclosures-clerk.house.gov/">House Disclosures</a>
        </div>
      </div>
    </section>
  </main>

  <nav class="tabsBottom">
    <div class="tabBarBottom">
      <div class="tabBottom tabBottomActive" id="navNews">News</div>
      <div class="tabBottom" id="navCongress">Congress</div>
      <div class="tabBottom" id="navCrypto">Crypto</div>
      <div class="tabBottom" id="navPerf">Performance</div>
    </div>
  </nav>

  <script>
    const BACKEND_BASE = "https://finance-backend-1-bbi9.onrender.com";

    const MARKET_READ_URL = () => `${BACKEND_BASE}/market/read`;
    const NEWS_BRIEF_URL = (watchlist) => {
      const wl = String(watchlist || "");
      return `${BACKEND_BASE}/news/briefing?tickers=${encodeURIComponent(wl)}&max_general=60&max_per_ticker=6`;
    };

    const el = (id) => document.getElementById(id);

    let ACTIVE_TAB = "News";
    let CACHE_READ = null;
    let CACHE_BRIEFING = new Map();

    function setStatus(kind, text, detail){
      const st = el("statusText");
      const sd = el("statusDetail");
      st.textContent = text || "";
      st.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
      sd.textContent = detail || "";
    }

    function setTitleForTab(tab){
      el("pageTitle").textContent = tab;
    }

    function fmtPct(x){
      if (x === null || x === undefined || isNaN(Number(x))) return "—";
      const n = Number(x);
      const s = n > 0 ? "+" : "";
      return `${s}${n.toFixed(2)}%`;
    }

    function sentimentBadge(s){
      const score = Number(s?.score ?? 50);
      const label = String(s?.label ?? "NEUTRAL");
      if (score >= 60) return { cls: "badgePos", label: label, score };
      if (score <= 40) return { cls: "badgeNeg", label: label, score };
      return { cls: "badgeNeu", label: label, score };
    }

    function normalizeNewsErrors(err){
      if (!err) return [];
      if (Array.isArray(err)) return err.filter(Boolean).map(String);
      if (typeof err === "object"){
        const out = [];
        for (const k of Object.keys(err)){
          const v = err[k];
          if (Array.isArray(v)) out.push(...v.filter(Boolean).map(String));
          else if (v) out.push(String(v));
        }
        return out;
      }
      return [String(err)];
    }

    function normalizeSectorHeadlines(s){
      if (!s || typeof s !== "object") return [];
      if (Array.isArray(s.headlines)) return s.headlines;
      if (Array.isArray(s.topHeadlines)) return s.topHeadlines;
      return [];
    }

    function getWatchlistTickers(){
      const raw = String(el("watchInput")?.value || "");
      return raw.split(",").map(x => x.trim().toUpperCase()).filter(Boolean);
    }

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function headlineHTML(h){
  const title = String(h?.title || "").trim();
  const link = String(h?.link || "").trim();
  const pub = String(h?.published || "").trim();
  const bucket = String(h?.bucket || h?.sourceFeed || h?.source || "").trim();
  const summary = String(h?.summary || "").trim();

  return `
    <div class="headlineItem">
      <div class="headlineTitle">${link ? `<a href="${link}" target="_blank" rel="noopener">${title}</a>` : title}</div>

      ${summary ? `<div class="kpiSub" style="margin-top:6px; color:rgba(255,255,255,.84);">${summary}</div>` : ""}

      <div class="headlineMeta">
        ${pub ? `<span>Published: <strong>${pub}</strong></span>` : ""}
        ${bucket ? `<span>Source: <strong>${bucket}</strong></span>` : ""}
      </div>
    </div>
      `;
    }

    function makeFallbackSummaryFromHeadlines(headlines){
      const titles = headlines
        .map(h => String(h?.title || "").trim())
        .filter(Boolean)
        .slice(0, 3);

      if (!titles.length) return "No summary available yet (no headlines returned).";

      // Keep it human-readable
      return `Top themes: ${titles.join(" | ")}.`;
    }

    function makeFallbackImplications(headlines){
      const watch = getWatchlistTickers();
      if (!watch.length) return [];

      const textBlob = headlines
        .map(h => `${String(h?.title||"")} ${String(h?.summary||"")} ${String(h?.description||"")}`)
        .join(" ")
        .toUpperCase();

      const mentioned = watch.filter(t => {
        // crude but effective: match whole token boundaries for most tickers
        const re = new RegExp(`(^|[^A-Z0-9])${t.replaceAll("-","\\-")}([^A-Z0-9]|$)`, "g");
        return re.test(textBlob);
      });

      if (!mentioned.length) return [];

      const top = mentioned.slice(0, 10);
      return [
        `Watchlist mentions in headlines: ${top.join(", ")}.`,
        `If today’s score looks extreme, sanity-check by opening the “Headlines” list for the sector that mentions those tickers.`
      ];
    }

    function normalizeImplications(s, headlines){
      // Preferred: backend-generated
      if (s && typeof s === "object"){
        if (Array.isArray(s.implications_2_12_weeks)) return s.implications_2_12_weeks.filter(Boolean).map(String);
        if (Array.isArray(s.implications)) return s.implications.filter(Boolean).map(String);
        if (typeof s.implications === "string" && s.implications.trim()) return [s.implications.trim()];
      }
      // Fallback: front-end generated
      return makeFallbackImplications(headlines);
    }

    function sectorPanelHTML(s){
      const sector = String(s?.sector || "General");
      const sent = sentimentBadge(s?.sentiment);

      const headlines = normalizeSectorHeadlines(s);
      const backendSummary = String(s?.summary || "").trim();
      const summary = backendSummary || makeFallbackSummaryFromHeadlines(headlines);

      const implications = normalizeImplications(s, headlines);

      const meta = [];
      meta.push(`${headlines.length} headlines`);
      meta.push(`Sentiment ${sent.score}/100`);
      const metaLine = meta.join(" · ");

      return `
        <details class="briefingDetails">
          <summary>
            <div class="summaryLeft">
              <div class="summaryTitle">${escapeHtml(sector)}</div>
              <div class="summaryMeta">${escapeHtml(metaLine)}${summary ? " · " + escapeHtml(summary) : ""}</div>
            </div>
            <div class="tags">
              <span class="kpiBadge badgeNeu">${headlines.length}</span>
              <span class="kpiBadge ${sent.cls}">${escapeHtml(sent.label)} · ${sent.score}</span>
            </div>
          </summary>

          <div class="divider"></div>

          <div class="kpiSub">
            <strong>Today’s read:</strong> ${escapeHtml(summary)}
          </div>

          <div class="divider"></div>

          <div class="kpiSub"><strong>Implications (next 2 to 12 weeks):</strong></div>
          <ul class="bulletList">
            ${implications.length ? implications.map(x => `<li>${escapeHtml(x)}</li>`).join("") : "<li>No implications available.</li>"}
          </ul>

          <div class="divider"></div>

          <div class="kpiSub"><strong>Headlines:</strong></div>
          <div class="headlineList">
            ${headlines.length ? headlines.map(headlineHTML).join("") : "<div class='subtle'>No headlines in this sector.</div>"}
          </div>
        </details>
      `;
    }

    function lsGetJson(key){
      try{
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        return JSON.parse(raw);
      }catch(e){
        return null;
      }
    }

    function lsSetJson(key, obj){
      try{
        localStorage.setItem(key, JSON.stringify(obj));
      }catch(e){}
    }

    function renderMarketRead(payload){
      const sp = payload?.sp500 || {};
      const nq = payload?.nasdaq || {};
      const fg = payload?.fearGreed || {};
      const errs = Array.isArray(payload?.errors) ? payload.errors : [];

      el("readKpiSPY").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">S&P proxy</div>
            <div class="kpiValue">${sp?.last ? sp.last : "—"}</div>
          </div>
          <span class="kpiBadge badgeNeu">${sp?.symbol || "SPY"}</span>
        </div>
        <div class="kpiSub">
          1D: <strong>${fmtPct(sp?.ret1dPct)}</strong> · 5D: <strong>${fmtPct(sp?.ret5dPct)}</strong> · 1M: <strong>${fmtPct(sp?.ret1mPct)}</strong>
        </div>
      `;

      el("readKpiQQQ").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Nasdaq proxy</div>
            <div class="kpiValue">${nq?.last ? nq.last : "—"}</div>
          </div>
          <span class="kpiBadge badgeNeu">${nq?.symbol || "QQQ"}</span>
        </div>
        <div class="kpiSub">
          1D: <strong>${fmtPct(nq?.ret1dPct)}</strong> · 5D: <strong>${fmtPct(nq?.ret5dPct)}</strong> · 1M: <strong>${fmtPct(nq?.ret1mPct)}</strong>
        </div>
      `;

      // Fear & Greed: cache the last good value so you never stare at a blank widget
      const cacheKey = "cs_fear_greed_last_good";
      const fgScore = fg?.score;
      const fgRating = fg?.rating;

      let usedScore = (typeof fgScore === "number") ? fgScore : null;
      let usedRating = fgRating || "";
      let usedCached = false;
      let cachedAt = "";

      if (typeof fgScore === "number" && fgRating){
        lsSetJson(cacheKey, { score: fgScore, rating: fgRating, ts: Date.now() });
      } else {
        const cached = lsGetJson(cacheKey);
        if (cached && typeof cached.score === "number"){
          usedScore = cached.score;
          usedRating = cached.rating || "Cached";
          usedCached = true;
          cachedAt = cached.ts ? new Date(cached.ts).toLocaleString() : "";
        }
      }

      const fgBadge = (typeof usedScore === "number")
        ? (usedScore >= 60 ? "badgePos" : usedScore <= 40 ? "badgeNeg" : "badgeNeu")
        : "badgeNeu";

      const fgValue = (typeof usedScore === "number") ? usedScore : "Unavailable";
      const fgLabel = (typeof usedScore === "number") ? (usedRating || "Fear & Greed") : "External index";
      const extraBadge = usedCached ? `<span class="kpiBadge badgeNeu">CACHED</span>` : "";

      el("readKpiFG").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Fear & greed</div>
            <div class="kpiValue">${fgValue}</div>
          </div>
          <span class="kpiBadge ${fgBadge}">${escapeHtml(fgLabel)}</span>
        </div>
        <div class="kpiSub">
          ${usedCached ? `Using cached value${cachedAt ? " · " + escapeHtml(cachedAt) : ""}.` : "Best effort fetch from backend."}
        </div>
        ${usedCached ? `<div class="kpiList"><div class="kpiRow"><span>Fallback</span>${extraBadge}</div></div>` : ""}
      `;

      el("readSummary").textContent = String(payload?.summary || "—");
      el("readHint").textContent = errs.length ? ("Market read issues: " + errs.slice(0,2).join(" | ")) : "Market read loaded.";
    }

    async function loadMarketRead(force){
      if (CACHE_READ && !force){
        renderMarketRead(CACHE_READ);
        return;
      }
      const url = MARKET_READ_URL();
      el("readHint").textContent = `Loading from: ${url}`;
      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_READ = data;
        renderMarketRead(data);
      }catch(err){
        el("readHint").textContent = "Could not load market read. Confirm backend has /market/read and CORS allows this origin.";
        el("readSummary").textContent = "—";
        // still attempt to render cached FG if present
        renderMarketRead({ errors: [String(err)] });
      }
    }

    function renderBriefing(data, watchlist){
      const overall = sentimentBadge(data?.overallSentiment);
      const sectors = Array.isArray(data?.sectors) ? data.sectors : [];
      const date = String(data?.date || "");
      const note = String(data?.note || "");

      const totalHeadlines = sectors.reduce((a, s) => a + normalizeSectorHeadlines(s).length, 0);

      // Quick sanity checks: how many sectors look positive/negative
      const sectorScores = sectors.map(s => Number(s?.sentiment?.score ?? 50));
      const posSectors = sectorScores.filter(x => x >= 60).length;
      const negSectors = sectorScores.filter(x => x <= 40).length;

      const lowSample = totalHeadlines < 12; // tweak as you like

      el("briefKpiSentiment").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Overall sentiment</div>
            <div class="kpiValue">${overall.score}/100</div>
          </div>
          <span class="kpiBadge ${overall.cls}">${overall.label}</span>
        </div>
        <div class="kpiSub">
          Headline-based context gauge. ${lowSample ? "Low sample size today, treat score as noisy." : ""}
        </div>
        <div class="kpiList">
          <div class="kpiRow"><span>Date</span><span class="kpiBadge badgeNeu">${date || "—"}</span></div>
          <div class="kpiRow"><span>Headlines used</span><span class="kpiBadge badgeNeu">${totalHeadlines}</span></div>
          <div class="kpiRow"><span>Sector split</span><span class="kpiBadge badgeNeu">+${posSectors} / -${negSectors}</span></div>
        </div>
      `;

      el("briefKpiScope").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Briefing scope</div>
            <div class="kpiValue">${totalHeadlines} headlines</div>
          </div>
          <span class="kpiBadge badgeNeu">Sectors</span>
        </div>
        <div class="kpiSub">
          Watchlist: ${String(watchlist||"").split(",").filter(x => x.trim()).length} tickers
        </div>
        <div class="kpiList">
          <div class="kpiRow"><span>Sectors</span><span class="kpiBadge badgeNeu">${sectors.length}</span></div>
          <div class="kpiRow"><span>Confidence</span><span class="kpiBadge badgeNeu">${lowSample ? "LOW" : "OK"}</span></div>
        </div>
      `;

      el("briefKpiNotes").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Notes</div>
            <div class="kpiValue">RSS</div>
          </div>
          <span class="kpiBadge badgeNeu">Backend</span>
        </div>
        <div class="kpiSub">${note ? note : "Daily briefing."}</div>
      `;

      el("briefingSectors").innerHTML = sectors.length
        ? sectors.map(sectorPanelHTML).join("")
        : "<div class='subtle'>No sectors returned.</div>";

      const errAll = normalizeNewsErrors(data?.errors);
      el("briefHint").textContent = errAll.length
        ? ("Some feeds failed: " + errAll.slice(0, 3).join(" | "))
        : "Daily briefing loaded.";
    }

    async function loadBriefing(watchlist, force){
      const key = String(watchlist || "").trim();
      if (CACHE_BRIEFING.has(key) && !force){
        renderBriefing(CACHE_BRIEFING.get(key), key);
        return;
      }

      const url = NEWS_BRIEF_URL(key);
      el("briefingSectors").innerHTML = "<div class='subtle'>Loading daily briefing…</div>";
      el("briefHint").textContent = `Loading from: ${url}`;

      try{
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error("HTTP " + res.status);
        CACHE_BRIEFING.set(key, data);
        renderBriefing(data, key);
      }catch(err){
        el("briefingSectors").innerHTML = "<div class='subtle'>Could not load briefing.</div>";
        el("briefHint").textContent = "Backend must expose /news/briefing and allow CORS.";
        el("briefKpiSentiment").innerHTML = "";
        el("briefKpiScope").innerHTML = "";
        el("briefKpiNotes").innerHTML = "";
      }
    }

    function showTab(tab){
      ACTIVE_TAB = tab;
      setTitleForTab(tab);

      el("viewNews").style.display = tab === "News" ? "" : "none";
      el("viewCongress").style.display = tab === "Congress" ? "" : "none";
      el("viewCrypto").style.display = tab === "Crypto" ? "" : "none";
      el("viewPerf").style.display = tab === "Performance" ? "" : "none";

      el("tabNewsBtn").classList.toggle("tabBtnActive", tab === "News");
      el("tabCongressBtn").classList.toggle("tabBtnActive", tab === "Congress");
      el("tabCryptoBtn").classList.toggle("tabBtnActive", tab === "Crypto");
      el("tabPerfBtn").classList.toggle("tabBtnActive", tab === "Performance");

      el("navNews").classList.toggle("tabBottomActive", tab === "News");
      el("navCongress").classList.toggle("tabBottomActive", tab === "Congress");
      el("navCrypto").classList.toggle("tabBottomActive", tab === "Crypto");
      el("navPerf").classList.toggle("tabBottomActive", tab === "Performance");

      if (tab === "News"){
        loadMarketRead(false);
        loadBriefing(el("watchInput").value, false);
      }
    }

    function handleRefresh(){
      CACHE_READ = null;
      CACHE_BRIEFING.clear();

      setStatus("", "Refreshing…", "");
      if (ACTIVE_TAB === "News"){
        loadMarketRead(true);
        loadBriefing(el("watchInput").value, true);
      }
    }

    el("tabNewsBtn").addEventListener("click", () => showTab("News"));
    el("tabCongressBtn").addEventListener("click", () => showTab("Congress"));
    el("tabCryptoBtn").addEventListener("click", () => showTab("Crypto"));
    el("tabPerfBtn").addEventListener("click", () => showTab("Performance"));

    el("navNews").addEventListener("click", () => showTab("News"));
    el("navCongress").addEventListener("click", () => showTab("Congress"));
    el("navCrypto").addEventListener("click", () => showTab("Crypto"));
    el("navPerf").addEventListener("click", () => showTab("Performance"));

    el("refreshBtn").addEventListener("click", handleRefresh);

    el("watchApplyBtn").addEventListener("click", () => {
      loadBriefing(el("watchInput").value, true);
    });

    el("readRefreshBtn").addEventListener("click", () => {
      loadMarketRead(true);
    });

    showTab("News");
    setStatus("ok", "Ready ✅", "");
    el("reportDate").textContent = "";
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Convergence Signals</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#0b0b0f" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b0b0f;
      --card:#151522;
      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --border:rgba(255,255,255,.10);

      --dem:#4aa3ff;
      --rep:#ff5a5a;
      --both:#b38bff;

      --ok:#7cffc0;
      --err:#ff8a8a;

      --pos:#7cffc0;
      --neg:#ff8a8a;
      --neutral:rgba(255,255,255,.70);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,sans-serif;
      font-size:13px;
    }
    a{color:inherit;text-decoration:none}

    .header{
      padding:14px 14px 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      max-width:980px;
      margin:0 auto;
    }
    .h1{font-size:18px;font-weight:900;letter-spacing:.01em}
    .subtle{font-size:12px;color:var(--muted);margin-top:2px}
    .pillBtn{
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
      color:#fff;
      font-size:12px;
    }

    .container{
      max-width:980px;
      margin:0 auto;
      padding:8px 14px 110px;
    }

    .status{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:12px;
      padding:9px 10px;
      margin:6px 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.25;
    }
    .status strong{color:#fff}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    .tabRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin:8px 0 10px;
    }
    .tabBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:7px 9px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .tabBtnActive{
      color:#fff;
      background:rgba(255,255,255,.08);
    }

    .sectionTitle{
      margin:14px 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 760px){
      .grid2{grid-template-columns:1fr 1fr;}
    }

    .grid4{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    @media (min-width: 860px){
      .grid4{grid-template-columns:repeat(4,1fr);}
    }
    @media (min-width: 760px) and (max-width: 859px){
      .grid4{grid-template-columns:repeat(2,1fr);}
    }

    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
    }
    .kpiTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom:6px;
    }
    .kpiTitle{
      font-size:11px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .kpiValue{
      font-size:18px;
      font-weight:900;
      letter-spacing:.02em;
      margin-top:4px;
    }
    .kpiSub{
      font-size:12px;
      color:rgba(255,255,255,.82);
      line-height:1.25;
    }
    .kpiList{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpiRow{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:rgba(255,255,255,.90);
    }
    .kpiRow .muted{color:var(--muted)}
    .kpiBadge{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
      color:rgba(255,255,255,.90);
    }
    .badgePos{border-color:rgba(124,255,192,.45); color:var(--pos)}
    .badgeNeg{border-color:rgba(255,138,138,.45); color:var(--neg)}
    .badgeNeu{border-color:rgba(255,255,255,.18); color:rgba(255,255,255,.85)}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px 9px;
      margin-bottom:8px;
    }

    .cardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .tickerLine{
      display:flex;
      align-items:baseline;
      gap:8px;
      flex-wrap:wrap;
    }
    .ticker{
      font-size:14px;
      font-weight:900;
      letter-spacing:.03em;
    }
    .who{
      font-size:12px;
      color:var(--muted);
      max-width:560px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .tags{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .tagDem{border-color:rgba(74,163,255,.5); color:var(--dem)}
    .tagRep{border-color:rgba(255,90,90,.5); color:var(--rep)}
    .tagBoth{border-color:rgba(179,139,255,.55); color:var(--both)}
    .tagBuy{border-color:rgba(124,255,192,.45); color:var(--ok)}
    .tagSell{border-color:rgba(255,138,138,.45); color:var(--err)}

    .metaRow{
      margin-top:7px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      line-height:1.25;
    }

    .counts{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .countItem{
      display:flex;
      gap:6px;
      align-items:center;
      font-size:12px;
      color:rgba(255,255,255,.88);
    }
    .dot{width:8px;height:8px;border-radius:999px;display:inline-block}
    .dotDem{background:var(--dem)}
    .dotRep{background:var(--rep)}

    .divider{height:1px;background:rgba(255,255,255,.08);margin:8px 0 7px}

    .miniLinks{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .miniLink{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.92);
    }

    .panel{
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      margin:10px 0 10px;
    }
    .panelTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .panelTitle h2{
      margin:0;
      font-size:13px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .closeBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      padding:6px 9px;
      border-radius:999px;
      font-size:11px;
      color:rgba(255,255,255,.9);
    }
    iframe{
      width:100%;
      height:360px;
      border:0;
      border-radius:12px;
      background:#000;
      margin-top:8px;
    }

    .colsHeader{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin:2px 0 8px;
      color:var(--muted);
      font-size:11px;
      letter-spacing:.05em;
      text-transform:uppercase;
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin:6px 0 0;
    }

    .tabsBottom{
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      background:#151522f0;
      border-top:1px solid var(--border);
      backdrop-filter:blur(12px);
    }
    .tabBarBottom{
      max-width:980px;
      margin:0 auto;
      display:grid;
      grid-template-columns:repeat(4,1fr);
    }
    .tabBottom{
      text-align:center;
      padding:11px 10px 16px;
      font-size:11px;
      color:var(--muted);
    }
    .tabBottomActive{color:#fff}

    .leaderRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-top:6px;
    }
    .leaderName{
      font-size:13px;
      font-weight:900;
      letter-spacing:.01em;
    }
    .leaderMeta{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .leaderRight{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <header class="header">
    <div>
      <div class="h1">Convergence</div>
      <div class="subtle" id="reportDate"></div>
    </div>
    <button class="pillBtn" id="refreshBtn">Refresh</button>
  </header>

  <main class="container">
    <div class="status" id="statusBox">
      <strong>Status:</strong> <span id="statusText">Loading‚Ä¶</span><br/>
      <span class="mono" id="statusDetail"></span>
    </div>

    <div class="tabRow">
      <button class="tabBtn tabBtnActive" id="tabMainBtn">Main</button>
      <button class="tabBtn" id="tabYearlyBtn">Yearly</button>
      <button class="tabBtn" id="tabLeadersBtn">Leaders</button>
      <button class="tabBtn" id="tabSearchBtn">Search</button>
    </div>

    <div id="stockPanel" style="display:none;"></div>

    <!-- KPI STRIP -->
    <section id="kpiStrip">
      <div class="sectionTitle">Signal dashboard (top 4, 30-day window)</div>

      <div class="panel">
        <div class="metaRow" style="margin-top:0;">
          <div>
            <strong>Definitions (30D):</strong>
            Buy and Sell are counts of members filing buys or sells for a ticker in the last 30 days.
            Participation is Buy plus Sell across both parties in the last 30 days.
            Accumulation is Buys minus Sells in the last 30 days.
            Top signals highlight the strongest Accumulation, strongest Selling, and top Convergence in the last 30 days.
          </div>
        </div>
      </div>

      <div class="grid4">
        <div class="kpi" id="kpiAccum"></div>
        <div class="kpi" id="kpiSell"></div>
        <div class="kpi" id="kpiRolling30"></div>
        <div class="kpi" id="kpiHighlights"></div>
      </div>
    </section>

    <!-- MAIN VIEW -->
    <section id="viewMain">
      <div class="sectionTitle">Convergence üî• (bipartisan overlap on BUY, last 30 days)</div>
      <div id="convergenceList"></div>

      <div class="sectionTitle">Congress activity ranked by participation (last 30 days)</div>
      <div class="colsHeader">
        <div>Buys (left, 30D)</div>
        <div>Sells (right, 30D)</div>
      </div>

      <div class="grid2">
        <div><div id="buyList"></div></div>
        <div><div id="sellList"></div></div>
      </div>

      <div class="hint">Sort is by total participation across both parties over the last 30 days. Tap ticker for chart.</div>
    </section>

    <!-- YEARLY VIEW -->
    <section id="viewYearly" style="display:none;">
      <div class="sectionTitle">Yearly congress accumulation & sell-off (1-year window)</div>

      <div class="panel">
        <div class="panelTitle">
          <h2>Top yearly movers (restricted to highest activity tickers)</h2>
        </div>
        <div class="hint" id="yearlyHint" style="margin-top:6px;">
          This view requires backend yearly totals. If missing, it shows a proxy.
        </div>
      </div>

      <div class="grid2">
        <div>
          <div class="sectionTitle" style="margin-top:0;">Yearly accumulation (BUY)</div>
          <div id="yearBuyList"></div>
        </div>
        <div>
          <div class="sectionTitle" style="margin-top:0;">Yearly sell-off (SELL)</div>
          <div id="yearSellList"></div>
        </div>
      </div>
    </section>

    <!-- LEADERS VIEW -->
    <section id="viewLeaders" style="display:none;">
      <div class="sectionTitle">Top 5 congress portfolio performers (30-day performance)</div>

      <div class="panel">
        <div class="panelTitle">
          <h2>Best performers</h2>
        </div>
        <div class="hint" id="leadersHint" style="margin-top:6px;">
          This requires backend portfolio performance per member (example field: leaders).
        </div>
      </div>

      <div id="leadersList"></div>
    </section>

    <!-- SEARCH VIEW -->
    <section id="viewSearch" style="display:none;">
      <div class="sectionTitle">Search ticker</div>
      <div class="panel">
        <div class="metaRow" style="margin-top:0;">
          <div style="color:rgba(255,255,255,.9)">Type a ticker (example: NVDA)</div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input id="searchInput" placeholder="Ticker" autocapitalize="characters"
                 style="flex:1; padding:10px 10px; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:#fff; font-size:13px;" />
          <button class="pillBtn" id="searchBtn">Go</button>
        </div>
        <div class="hint" style="margin-top:10px;">Opens the chart panel for quick trend context.</div>
      </div>
    </section>
  </main>

  <nav class="tabsBottom">
    <div class="tabBarBottom">
      <div class="tabBottom tabBottomActive" id="navMain">Main</div>
      <div class="tabBottom" id="navYearly">Yearly</div>
      <div class="tabBottom" id="navLeaders">Leaders</div>
      <div class="tabBottom" id="navSearch">Search</div>
    </div>
  </nav>

  <script>
    const BACKEND_URL = "https://finance-backend-dzta.onrender.com/report/today";

    const el = (id) => document.getElementById(id);

    function setStatus(kind, text, detail){
      const st = el("statusText");
      const sd = el("statusDetail");
      st.textContent = text || "";
      st.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
      sd.textContent = detail || "";
    }

    function normalizeList(arr){ return Array.isArray(arr) ? arr.slice() : []; }

    function congressScore(x){
      return (
        Number(x.demBuyers || 0) +
        Number(x.repBuyers || 0) +
        Number(x.demSellers || 0) +
        Number(x.repSellers || 0)
      );
    }

    function bipartisanScore(x){
      const dem = Number(x.demBuyers || 0) + Number(x.demSellers || 0);
      const rep = Number(x.repBuyers || 0) + Number(x.repSellers || 0);
      return Math.min(dem, rep);
    }

    function sortByCongressStrength(a, b){
      const totalA = congressScore(a);
      const totalB = congressScore(b);
      if (totalA !== totalB) return totalB - totalA;
      const biA = bipartisanScore(a);
      const biB = bipartisanScore(b);
      if (biA !== biB) return biB - biA;
      return String(a.ticker || "").localeCompare(String(b.ticker || ""), undefined, {sensitivity:"base"});
    }

    function netFlow(x){
      const buys = Number(x.demBuyers || 0) + Number(x.repBuyers || 0);
      const sells = Number(x.demSellers || 0) + Number(x.repSellers || 0);
      return buys - sells;
    }

    function confidenceLabel(x){
      const t = congressScore(x);
      if (t >= 6) return "STRONG";
      if (t >= 3) return "MOD";
      return "WEAK";
    }

    function confidenceBadgeClass(lbl){
      if (lbl === "STRONG") return "badgePos";
      if (lbl === "MOD") return "badgeNeu";
      return "badgeNeu";
    }

    function tickerLinksHTML(ticker){
      const t = String(ticker || "").toUpperCase();
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tvChart = `https://www.tradingview.com/chart/?symbol=${encodeURIComponent("NASDAQ:" + t)}`;
      return `
        <div class="miniLinks">
          <a class="miniLink" href="#stock=${t}">Chart</a>
          <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Yahoo</a>
          <a class="miniLink" href="${tvChart}" target="_blank" rel="noopener">TV</a>
        </div>
      `;
    }

    function cardHTML(x, mode){
      const ticker = String(x.ticker || "").toUpperCase();
      const who = String(x.companyName || "").trim();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";

      const dem = mode === "BUY" ? Number(x.demBuyers || 0) : Number(x.demSellers || 0);
      const rep = mode === "BUY" ? Number(x.repBuyers || 0) : Number(x.repSellers || 0);

      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                ${who ? `<div class="who">${who}</div>` : ""}
              </div>
            </div>
            <div class="tags">
              ${mode === "BUY" ? `<span class="tag tagBuy">BUY</span>` : `<span class="tag tagSell">SELL</span>`}
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Latest filing: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function overlapCardHTML(x){
      const ticker = String(x.ticker || "").toUpperCase();
      const filed = x.lastFiledAt ? String(x.lastFiledAt) : "";
      const dem = Number(x.demBuyers || 0);
      const rep = Number(x.repBuyers || 0);
      const conf = confidenceLabel(x);

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="tickerLine">
                <a class="ticker" href="#stock=${ticker}">${ticker}</a>
                <div class="who">Bipartisan overlap on BUY (30D)</div>
              </div>
            </div>
            <div class="tags">
              <span class="tag tagDem">DEM</span>
              <span class="tag tagRep">GOP</span>
              <span class="tag tagBoth">OVERLAP</span>
              <span class="tag tagBuy">BUY</span>
              <span class="tag ${confidenceBadgeClass(conf)}">${conf}</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="metaRow">
            <div class="counts">
              <div class="countItem"><span class="dot dotDem"></span> Dem: <strong>${dem}</strong></div>
              <div class="countItem"><span class="dot dotRep"></span> GOP: <strong>${rep}</strong></div>
              <div class="countItem">Total: <strong>${dem + rep}</strong></div>
            </div>
            <div>${filed ? `Latest filing: ${filed}` : ""}</div>
          </div>

          ${tickerLinksHTML(ticker)}
        </div>
      `;
    }

    function setStockPanel(ticker){
      const t = String(ticker || "").toUpperCase();
      if (!t){
        el("stockPanel").style.display = "none";
        el("stockPanel").innerHTML = "";
        return;
      }

      const symbol = "NASDAQ:" + t;
      const yf = `https://finance.yahoo.com/quote/${encodeURIComponent(t)}`;
      const tv = `https://www.tradingview.com/symbols/${encodeURIComponent(symbol)}/`;

      el("stockPanel").style.display = "";
      el("stockPanel").innerHTML = `
        <div class="panel">
          <div class="panelTitle">
            <h2>${t} chart (MA + RSI)</h2>
            <button class="closeBtn" id="closeStockBtn">Close</button>
          </div>
          <iframe
            title="TradingView Chart"
            src="https://s.tradingview.com/widgetembed/?symbol=${encodeURIComponent(symbol)}&interval=D&hidesidetoolbar=0&symboledit=1&saveimage=1&toolbarbg=%23151522&studies=%5B%22MASimple%40tv-basicstudies%22%2C%22RSI%40tv-basicstudies%22%5D&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&hideideas=1"
            loading="lazy">
          </iframe>
          <div class="miniLinks">
            <a class="miniLink" href="${yf}" target="_blank" rel="noopener">Open Yahoo</a>
            <a class="miniLink" href="${tv}" target="_blank" rel="noopener">Open TradingView</a>
          </div>
        </div>
      `;

      const btn = document.getElementById("closeStockBtn");
      if (btn) btn.addEventListener("click", () => {
        history.pushState("", document.title, window.location.pathname + window.location.search);
        setStockPanel("");
      });
    }

    function handleHash(){
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim();
        setStockPanel(t);
        return;
      }
      setStockPanel("");
    }

    function topBy(arr, scoreFn, n){
      const a = normalizeList(arr).slice();
      a.sort((x,y) => (scoreFn(y) - scoreFn(x)) || String(x.ticker||"").localeCompare(String(y.ticker||""), undefined, {sensitivity:"base"}));
      return a.slice(0, n);
    }

    function renderKpiBoxes(convergence, buys, sells, roll30){
      // Merge buy+sell by ticker for net flow
      const merged = new Map();
      function addCard(x){
        const t = String(x.ticker || "").toUpperCase();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, demBuyers:0, repBuyers:0, demSellers:0, repSellers:0 };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        merged.set(t, cur);
      }
      buys.forEach(addCard);
      sells.forEach(addCard);

      const mergedArr = Array.from(merged.values());

      // KPI 1: Accumulation 30D
      const topNet = topBy(mergedArr, (x) => netFlow(x), 5);
      const topNetHtml = topNet.map(x => {
        const nf = netFlow(x);
        const badge = nf > 0 ? "badgePos" : nf < 0 ? "badgeNeg" : "badgeNeu";
        const sign = nf > 0 ? "+" : "";
        return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${badge}">${sign}${nf}</span></div>`;
      }).join("");

      el("kpiAccum").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Accumulation (30D)</div>
            <div class="kpiValue">Buys ‚àí Sells</div>
          </div>
          <span class="kpiBadge badgeNeu">30D</span>
        </div>
        <div class="kpiSub">Net member flow per ticker in the last 30 days.</div>
        <div class="kpiList">${topNetHtml || `<div class="kpiRow"><span class="muted">No data</span></div>`}</div>
      `;

      // KPI 2: Participation 30D
      const topConf = topBy(mergedArr, (x) => congressScore(x), 5);
      const topConfHtml = topConf.map(x => {
        const total = congressScore(x);
        const lbl = confidenceLabel(x);
        const cls = confidenceBadgeClass(lbl);
        return `<div class="kpiRow"><a href="#stock=${x.ticker}"><strong>${x.ticker}</strong></a><span class="kpiBadge ${cls}">${lbl} ¬∑ ${total}</span></div>`;
      }).join("");

      el("kpiSell").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Participation (30D)</div>
            <div class="kpiValue">Buy + Sell</div>
          </div>
          <span class="kpiBadge badgeNeu">30D</span>
        </div>
        <div class="kpiSub">Total filings by members across both parties in the last 30 days.</div>
        <div class="kpiList">${topConfHtml || `<div class="kpiRow"><span class="muted">No data</span></div>`}</div>
      `;

      // KPI 3: Rolling 30D (uses backend roll30 if provided, else uses mergedArr proxy)
      let roll30Items = [];
      let roll30Label = "Proxy";

      if (Array.isArray(roll30) && roll30.length){
        roll30Items = roll30.slice();
        roll30Label = "30D";
      } else {
        roll30Items = mergedArr.map(x => ({
          ticker: x.ticker,
          net: netFlow(x)
        }));
      }

      roll30Items.sort((a,b)=>{
        const aNet = Number(a.net ?? a.value ?? 0);
        const bNet = Number(b.net ?? b.value ?? 0);
        if (bNet !== aNet) return bNet - aNet;
        return String(a.ticker||"").localeCompare(String(b.ticker||""), undefined, {sensitivity:"base"});
      });

      const top30 = roll30Items.slice(0,5);
      const roll30Html = top30.map(x=>{
        const n = Number(x.net ?? x.value ?? 0);
        const badge = n > 0 ? "badgePos" : n < 0 ? "badgeNeg" : "badgeNeu";
        const sign = n > 0 ? "+" : "";
        return `<div class="kpiRow"><a href="#stock=${String(x.ticker||"").toUpperCase()}"><strong>${String(x.ticker||"").toUpperCase()}</strong></a><span class="kpiBadge ${badge}">${sign}${n}</span></div>`;
      }).join("");

      el("kpiRolling30").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top flow (30D)</div>
            <div class="kpiValue">Ranking</div>
          </div>
          <span class="kpiBadge badgeNeu">${roll30Label}</span>
        </div>
        <div class="kpiSub">Most positive net flow in the last 30 days (or best proxy).</div>
        <div class="kpiList">${roll30Html || `<div class="kpiRow"><span class="muted">No data</span></div>`}</div>
      `;

      // KPI 4: Top signals (30D)
      const topAcc = topBy(mergedArr, (x) => netFlow(x), 1)[0];
      const topDist = topBy(mergedArr, (x) => -netFlow(x), 1)[0];
      const topConv = (convergence && convergence.length) ? convergence[0] : null;

      const accLine = topAcc
        ? `<div class="kpiRow"><span class="muted">üî• Accumulation</span><a href="#stock=${topAcc.ticker}"><strong>${topAcc.ticker}</strong></a></div>`
        : `<div class="kpiRow"><span class="muted">üî• Accumulation</span><span class="muted">None</span></div>`;

      const distLine = topDist
        ? `<div class="kpiRow"><span class="muted">‚ö†Ô∏è Sell-off</span><a href="#stock=${topDist.ticker}"><strong>${topDist.ticker}</strong></a></div>`
        : `<div class="kpiRow"><span class="muted">‚ö†Ô∏è Sell-off</span><span class="muted">None</span></div>`;

      const convLine = topConv
        ? `<div class="kpiRow"><span class="muted">ü§ù Convergence</span><a href="#stock=${String(topConv.ticker||"").toUpperCase()}"><strong>${String(topConv.ticker||"").toUpperCase()}</strong></a></div>`
        : `<div class="kpiRow"><span class="muted">ü§ù Convergence</span><span class="muted">None</span></div>`;

      el("kpiHighlights").innerHTML = `
        <div class="kpiTop">
          <div>
            <div class="kpiTitle">Top signals (30D)</div>
            <div class="kpiValue">Fast read</div>
          </div>
          <span class="kpiBadge badgeNeu">30D</span>
        </div>
        <div class="kpiSub">Strongest accumulation, sell-off, and convergence in the last 30 days.</div>
        <div class="kpiList">
          ${accLine}
          ${distLine}
          ${convLine}
        </div>
      `;
    }

    function renderYearlyCongress(yearly, fallbackMerged){
      let universe = [];
      let usedBackend = false;

      if (yearly && Array.isArray(yearly.universe) && yearly.universe.length){
        universe = yearly.universe.slice();
        usedBackend = true;
        el("yearlyHint").textContent = "Using backend 1-year window (restricted to highest activity tickers).";
      } else {
        universe = fallbackMerged.slice();
        el("yearlyHint").textContent = "Backend yearly window not provided yet, showing a proxy using the current pull.";
      }

      universe.sort(sortByCongressStrength);

      const topUniverse = universe.slice(0, 25);

      const buyRank = topUniverse.slice().sort((a,b)=>{
        const aBuy = Number(a.demBuyers||0)+Number(a.repBuyers||0);
        const bBuy = Number(b.demBuyers||0)+Number(b.repBuyers||0);
        if (bBuy !== aBuy) return bBuy - aBuy;
        return String(a.ticker||"").localeCompare(String(b.ticker||""));
      });

      const sellRank = topUniverse.slice().sort((a,b)=>{
        const aSell = Number(a.demSellers||0)+Number(a.repSellers||0);
        const bSell = Number(b.demSellers||0)+Number(b.repSellers||0);
        if (bSell !== aSell) return bSell - aSell;
        return String(a.ticker||"").localeCompare(String(b.ticker||""));
      });

      const topBuy = buyRank.slice(0, 15);
      const topSell = sellRank.slice(0, 15);

      el("yearBuyList").innerHTML = topBuy.length
        ? topBuy.map(x => cardHTML(x, "BUY")).join("")
        : "<div class='subtle'>No yearly buy accumulation found.</div>";

      el("yearSellList").innerHTML = topSell.length
        ? topSell.map(x => cardHTML(x, "SELL")).join("")
        : "<div class='subtle'>No yearly sell-off found.</div>";
    }

    function leaderCardHTML(p){
      // Expected shape from backend (example):
      // { name, party, chamber, state, return30d, return1y, trades30d, url }
      const name = String(p.name || p.congressman || p.member || "Unknown");
      const party = String(p.party || "").toUpperCase();
      const chamber = String(p.chamber || "");
      const state = String(p.state || "");
      const r30 = (p.return30d ?? p.performance30d ?? p.pnl30d);
      const r1y = (p.return1y ?? p.performance1y ?? p.pnl1y);
      const trades = (p.trades30d ?? p.tradeCount30d ?? p.activity30d);

      const r30Num = Number(r30);
      const badge30 = Number.isFinite(r30Num)
        ? (r30Num > 0 ? "badgePos" : r30Num < 0 ? "badgeNeg" : "badgeNeu")
        : "badgeNeu";

      const partyTag = party === "DEM"
        ? `<span class="tag tagDem">DEM</span>`
        : party === "REP" || party === "GOP"
          ? `<span class="tag tagRep">GOP</span>`
          : `<span class="tag">UNK</span>`;

      const link = p.url ? String(p.url) : "";

      const r30Text = Number.isFinite(r30Num) ? `${(r30Num*100).toFixed(1)}%` : "n/a";
      const r1yNum = Number(r1y);
      const r1yText = Number.isFinite(r1yNum) ? `${(r1yNum*100).toFixed(1)}%` : "n/a";

      return `
        <div class="card">
          <div class="cardTop">
            <div>
              <div class="leaderName">${link ? `<a href="${link}" target="_blank" rel="noopener">${name}</a>` : name}</div>
              <div class="leaderMeta">${chamber ? chamber : ""}${(chamber && state) ? " ¬∑ " : ""}${state ? state : ""}</div>
            </div>
            <div class="leaderRight">
              ${partyTag}
              <span class="kpiBadge ${badge30}">30D ${r30Text}</span>
              <span class="kpiBadge badgeNeu">1Y ${r1yText}</span>
              ${trades !== undefined ? `<span class="kpiBadge badgeNeu">${Number(trades)||0} trades</span>` : ""}
            </div>
          </div>
          <div class="hint" style="margin-top:8px;">
            Ranking is 30-day portfolio performance.
          </div>
        </div>
      `;
    }

    function renderLeaders(leaders){
      const list = normalizeList(leaders);

      if (!list.length){
        el("leadersHint").textContent = "No leader performance data yet. Backend needs to provide a leaders array with 30-day returns.";
        el("leadersList").innerHTML = "<div class='subtle'>No leader performance data displayed.</div>";
        return;
      }

      el("leadersHint").textContent = "Showing top 5 by 30-day portfolio performance.";
      list.sort((a,b) => {
        const ar = Number(a.return30d ?? a.performance30d ?? a.pnl30d ?? -999999);
        const br = Number(b.return30d ?? b.performance30d ?? b.pnl30d ?? -999999);
        if (br !== ar) return br - ar;
        return String(a.name||"").localeCompare(String(b.name||""));
      });

      const top5 = list.slice(0,5);
      el("leadersList").innerHTML = top5.map(leaderCardHTML).join("");
    }

    function showTab(tab){
      el("viewMain").style.display = tab === "Main" ? "" : "none";
      el("viewYearly").style.display = tab === "Yearly" ? "" : "none";
      el("viewLeaders").style.display = tab === "Leaders" ? "" : "none";
      el("viewSearch").style.display = tab === "Search" ? "" : "none";

      el("tabMainBtn").classList.toggle("tabBtnActive", tab === "Main");
      el("tabYearlyBtn").classList.toggle("tabBtnActive", tab === "Yearly");
      el("tabLeadersBtn").classList.toggle("tabBtnActive", tab === "Leaders");
      el("tabSearchBtn").classList.toggle("tabBtnActive", tab === "Search");

      el("navMain").classList.toggle("tabBottomActive", tab === "Main");
      el("navYearly").classList.toggle("tabBottomActive", tab === "Yearly");
      el("navLeaders").classList.toggle("tabBottomActive", tab === "Leaders");
      el("navSearch").classList.toggle("tabBottomActive", tab === "Search");
    }

    function setStockPanelFromHash(){
      const h = window.location.hash || "";
      if (h.startsWith("#stock=")){
        const t = decodeURIComponent(h.replace("#stock=","")).trim();
        setStockPanel(t);
        return;
      }
      setStockPanel("");
    }

    function render(data){
      el("reportDate").textContent = data.date || "";

      // These should be 30-day window lists from backend
      const convergence = normalizeList(data.convergence).sort(sortByCongressStrength);
      const buys = normalizeList(data.politicianBuys || data.bipartisanTickers).sort(sortByCongressStrength);
      const sells = normalizeList(data.politicianSells).sort(sortByCongressStrength);

      // merged fallback universe (for yearly proxy if yearly not provided)
      const merged = new Map();
      function addCard(x){
        const t = String(x.ticker || "").toUpperCase();
        if (!t) return;
        const cur = merged.get(t) || { ticker:t, companyName:x.companyName||"", demBuyers:0, repBuyers:0, demSellers:0, repSellers:0, lastFiledAt:x.lastFiledAt||"" };
        cur.demBuyers += Number(x.demBuyers||0);
        cur.repBuyers += Number(x.repBuyers||0);
        cur.demSellers += Number(x.demSellers||0);
        cur.repSellers += Number(x.repSellers||0);
        if (x.lastFiledAt && String(x.lastFiledAt) > String(cur.lastFiledAt||"")) cur.lastFiledAt = x.lastFiledAt;
        merged.set(t, cur);
      }
      buys.forEach(addCard);
      sells.forEach(addCard);
      const fallbackMerged = Array.from(merged.values()).sort(sortByCongressStrength);

      renderKpiBoxes(convergence, buys, sells, data.roll30);

      el("convergenceList").innerHTML =
        convergence.length ? convergence.map(overlapCardHTML).join("") : "<div class='subtle'>No overlap tickers in the last 30 days.</div>";

      el("buyList").innerHTML =
        buys.length ? buys.map(x => cardHTML(x, "BUY")).join("") : "<div class='subtle'>No buy trades in the last 30 days.</div>";

      el("sellList").innerHTML =
        sells.length ? sells.map(x => cardHTML(x, "SELL")).join("") : "<div class='subtle'>No sell trades in the last 30 days.</div>";

      renderYearlyCongress(data.yearly, fallbackMerged);

      // New Leaders tab (expects backend to provide leaders)
      renderLeaders(data.leaders || data.topCongressPerformers || data.performanceLeaders || []);

      setStockPanelFromHash();
    }

    async function load(){
      setStatus("", "Loading‚Ä¶", BACKEND_URL);

      el("convergenceList").innerHTML = "<div class='subtle'>Loading‚Ä¶</div>";
      el("buyList").innerHTML = "";
      el("sellList").innerHTML = "";
      el("yearBuyList").innerHTML = "";
      el("yearSellList").innerHTML = "";
      el("leadersList").innerHTML = "<div class='subtle'>Loading‚Ä¶</div>";

      try{
        const res = await fetch(BACKEND_URL, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) throw new Error("HTTP " + res.status);
        if (data.error) throw new Error(data.error);

        setStatus("ok", "Live data loaded ‚úÖ", "");
        render(data);
      }catch(err){
        setStatus("err", "Could not load live data", String(err));
        el("convergenceList").innerHTML = "<div class='subtle'>No data displayed.</div>";
        el("leadersList").innerHTML = "<div class='subtle'>No leader performance data displayed.</div>";
      }
    }

    // Top tabs
    el("tabMainBtn").addEventListener("click", () => showTab("Main"));
    el("tabYearlyBtn").addEventListener("click", () => showTab("Yearly"));
    el("tabLeadersBtn").addEventListener("click", () => showTab("Leaders"));
    el("tabSearchBtn").addEventListener("click", () => showTab("Search"));

    // Bottom tabs
    el("navMain").addEventListener("click", () => showTab("Main"));
    el("navYearly").addEventListener("click", () => showTab("Yearly"));
    el("navLeaders").addEventListener("click", () => showTab("Leaders"));
    el("navSearch").addEventListener("click", () => showTab("Search"));

    // Search
    el("searchBtn").addEventListener("click", () => {
      const t = String(el("searchInput").value || "").trim().toUpperCase();
      if (!t) return;
      window.location.hash = "#stock=" + encodeURIComponent(t);
      showTab("Search");
      setStockPanelFromHash();
    });

    // Chart panel + refresh
    el("refreshBtn").addEventListener("click", load);
    window.addEventListener("hashchange", setStockPanelFromHash);

    showTab("Main");
    load();
  </script>
</body>
</html>
